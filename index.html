<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">
    <title>Dza-Genius V11 Ultra</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/adhan/4.4.4/Adhan.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&family=Fira+Code:wght@400&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #10b981; --bg-dark: #0f172a; --safe-top: env(safe-area-inset-top, 20px); --safe-bottom: env(safe-area-inset-bottom, 20px); }
        body { font-family: 'Cairo', sans-serif; background: var(--bg-dark); color: #f8fafc; height: 100dvh; overflow: hidden; background-image: radial-gradient(#1e293b 1px, transparent 1px); background-size: 24px 24px; }
        .app-layout { display: flex; flex-direction: column; height: 100%; padding-top: var(--safe-top); padding-bottom: calc(75px + var(--safe-bottom)); }
        
        .page { display: none; height: 100%; overflow-y: auto; padding: 16px; scroll-behavior: smooth; }
        .page.active { display: block; animation: fadeUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        
        .msg-bubble { max-width: 90%; padding: 12px 16px; margin-bottom: 12px; border-radius: 18px; position: relative; font-size: 15px; line-height: 1.6; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .msg-bot { background: #1e293b; color: #e2e8f0; border: 1px solid #334155; border-bottom-left-radius: 4px; }
        .msg-user { background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; margin-right: auto; border-bottom-right-radius: 4px; }
        
        pre { background: #111827 !important; padding: 0 !important; border-radius: 8px !important; overflow: hidden; margin: 10px 0; border: 1px solid #374151; direction: ltr; }
        pre code { font-family: 'Fira Code', monospace; font-size: 13px; display: block; padding: 12px; overflow-x: auto; }
        .code-header { background: #1f2937; padding: 4px 12px; font-size: 11px; color: #9ca3af; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #374151; }

        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); border-radius: 20px; padding: 16px; margin-bottom: 14px; }
        .glass-card:active { transform: scale(0.99); transition: 0.1s; }

        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: calc(70px + var(--safe-bottom)); background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-around; padding-top: 10px; z-index: 50; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #64748b; width: 20%; transition: 0.3s; cursor: pointer; }
        .nav-item.active { color: var(--primary); transform: translateY(-4px); font-weight: bold; }
        .nav-item i { font-size: 20px; margin-bottom: 4px; }

        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="welcomeModal" class="fixed inset-0 z-[100] flex items-center justify-center p-6 hidden bg-black/90 backdrop-blur-md">
        <div class="glass-card w-full max-w-sm text-center border border-green-500/30 shadow-2xl shadow-green-900/40 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-green-500 to-teal-500"></div>
            <div class="w-16 h-16 bg-gradient-to-tr from-green-600 to-teal-800 rounded-2xl flex items-center justify-center mx-auto mb-4 text-2xl shadow-lg">ğŸ‡©ğŸ‡¿</div>
            <h2 class="text-xl font-black mb-1 text-white">Dza-Genius V11</h2>
            <p class="text-xs text-gray-400 mb-5">Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±ÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</p>
            
            <div class="text-right mb-4 bg-slate-900/80 p-4 rounded-xl border border-slate-700">
                <label class="text-[10px] text-gray-500 uppercase font-bold block mb-2">Ø§Ù„Ù…Ø­Ø±Ùƒ (AI Engine)</label>
                <select id="welcomeProvider" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2 text-xs mb-3 text-white outline-none">
                    <option value="groq">Groq (Llama 3 - Ù…Ø¬Ø§Ù†ÙŠ ÙˆØ³Ø±ÙŠØ¹ Ø¬Ø¯Ø§Ù‹ âš¡)</option>
                    <option value="openai">OpenAI (GPT-4o)</option>
                </select>
                
                <label class="text-[10px] text-gray-500 uppercase font-bold block mb-2">API Key</label>
                <input type="password" id="welcomeKey" placeholder="sk-..." class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2 text-xs font-mono text-white outline-none focus:border-green-500">
                <a href="https://console.groq.com/keys" target="_blank" class="text-[10px] text-blue-400 mt-2 block text-center hover:underline">Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ Groq Ù…Ø¬Ø§Ù†ÙŠ</a>
            </div>
            <button onclick="finishOnboarding()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl transition shadow-lg text-sm">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù† ğŸš€</button>
        </div>
    </div>

    <div class="app-layout">
        <header class="flex justify-between items-center px-4 py-3 bg-slate-900/80 backdrop-blur sticky top-0 z-40 border-b border-slate-800/60">
            <div class="flex items-center gap-3">
                <div class="relative">
                    <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-green-500 to-teal-700 flex items-center justify-center text-white font-bold text-xs shadow-lg shadow-green-900/20">DZ</div>
                    <div class="absolute -bottom-1 -right-1 bg-slate-900 rounded-full p-0.5"><div class="w-2.5 h-2.5 bg-green-500 rounded-full animate-pulse border border-slate-900"></div></div>
                </div>
                <div class="leading-tight">
                    <h1 class="font-bold text-sm text-white tracking-wide">Dza-Genius <span class="text-[9px] bg-green-900/30 text-green-400 px-1 rounded border border-green-500/20">ULTRA</span></h1>
                    <div class="text-[10px] text-gray-400 cursor-pointer flex items-center gap-1 hover:text-green-300 transition" onclick="nav('tools', this)">
                        <i class="fa-solid fa-location-dot"></i> <span id="headerCity">Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± Ø§Ù„Ø¹Ø§ØµÙ…Ø©</span>
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="clearChat()" class="w-8 h-8 rounded-full bg-slate-800 text-red-400 border border-slate-700 flex items-center justify-center hover:bg-red-900/20 transition" title="Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©">
                    <i class="fa-solid fa-eraser text-xs"></i>
                </button>
                <button onclick="toggleSound()" id="soundBtn" class="w-8 h-8 rounded-full bg-slate-800 text-gray-400 border border-slate-700 flex items-center justify-center hover:text-green-400 transition" title="Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„ØµÙˆØªÙŠ">
                    <i class="fa-solid fa-volume-xmark text-xs"></i>
                </button>
            </div>
        </header>

        <main id="view-chat" class="page active">
            <div id="chatContainer" class="pb-28 min-h-[60vh] flex flex-col justify-end"></div>
            
            <div class="fixed bottom-[calc(70px+var(--safe-bottom))] left-0 right-0 px-3 py-2 z-40 bg-gradient-to-t from-slate-900 via-slate-900/95 to-transparent">
                <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide mb-1 px-1" id="quickSuggestions">
                    <button onclick="setInput('ÙˆØ§Ø´ Ù‡Ùˆ Ø³Ø¹Ø± Ø§Ù„Ø£ÙˆØ±Ùˆ Ø§Ù„ÙŠÙˆÙ…ØŸ')" class="whitespace-nowrap bg-slate-800/80 border border-slate-700 text-[10px] text-gray-300 px-3 py-1.5 rounded-full hover:bg-slate-700 transition">ğŸ’¶ Ø³Ø¹Ø± Ø§Ù„Ø£ÙˆØ±Ùˆ</button>
                    <button onclick="setInput('Ø£ÙƒØªØ¨ Ù„ÙŠ Ø¯ÙˆÙ…ÙˆÙ†Ø¯ Ø®Ø·ÙŠØ©')" class="whitespace-nowrap bg-slate-800/80 border border-slate-700 text-[10px] text-gray-300 px-3 py-1.5 rounded-full hover:bg-slate-700 transition">ğŸ“ Ø·Ù„Ø¨ Ø®Ø·ÙŠ</button>
                    <button onclick="setInput('Ù†ÙƒØªØ© Ø¬Ø²Ø§Ø¦Ø±ÙŠØ©')" class="whitespace-nowrap bg-slate-800/80 border border-slate-700 text-[10px] text-gray-300 px-3 py-1.5 rounded-full hover:bg-slate-700 transition">ğŸ˜‚ Ù†ÙƒØªØ©</button>
                </div>

                <div class="max-w-3xl mx-auto flex items-end gap-2 bg-slate-800/90 backdrop-blur p-1.5 rounded-[24px] border border-slate-700 shadow-2xl">
                    <button id="micBtn" onclick="toggleVoice()" class="w-10 h-10 rounded-full bg-slate-700/50 text-gray-400 hover:text-white transition flex-shrink-0">
                        <i class="fa-solid fa-microphone"></i>
                    </button>
                    <textarea id="msgInput" rows="1" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§..." class="flex-1 bg-transparent text-white text-sm py-3 px-1 focus:outline-none resize-none max-h-32 placeholder-slate-500 dir-rtl" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
                    <button onclick="sendMessage()" id="sendBtn" class="w-10 h-10 rounded-full bg-green-600 hover:bg-green-500 text-white shadow-lg shadow-green-900/30 transition transform active:scale-90 flex-shrink-0 flex items-center justify-center">
                        <i class="fa-solid fa-paper-plane text-sm"></i>
                    </button>
                </div>
            </div>
        </main>

        <main id="view-tools" class="page">
            <div class="glass-card p-3 flex gap-2 items-center mb-4 border-blue-500/30 bg-blue-900/10">
                <i class="fa-solid fa-map-location-dot text-blue-400"></i>
                <select id="wilayaSelect" onchange="changeWilaya()" class="bg-transparent w-full text-sm text-white font-bold outline-none">
                    <option value="auto">ğŸ“ ØªØ­Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ (GPS)</option>
                    </select>
            </div>

            <div class="glass-card bg-gradient-to-br from-blue-900/20 to-slate-900 border-r-4 border-blue-500 relative overflow-hidden">
                <div class="flex justify-between items-start z-10 relative">
                    <div>
                        <h3 class="text-xs text-blue-300 font-bold mb-1"><i class="fa-solid fa-cloud"></i> Ø§Ù„Ø·Ù‚Ø³</h3>
                        <div class="flex items-baseline gap-2">
                            <span id="weatherTemp" class="text-3xl font-black text-white">--Â°</span>
                            <span id="weatherDesc" class="text-xs text-gray-400">..</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div id="weatherCity" class="text-xs font-bold text-white mb-1">---</div>
                        <div class="text-[10px] text-blue-400"><i class="fa-solid fa-wind"></i> <span id="windSpeed">--</span> km/h</div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="glass-card mb-0 p-3 bg-gradient-to-br from-green-900/20 to-slate-900 border-green-500/20">
                    <div class="text-[10px] text-green-400 mb-1 font-bold">Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</div>
                    <div id="nextPrayerName" class="text-xs text-gray-300">--</div>
                    <div id="nextPrayerCounter" class="text-xl font-mono font-bold text-white mt-1">--:--</div>
                </div>
                <div class="glass-card mb-0 p-3 bg-gradient-to-br from-indigo-900/20 to-slate-900 border-indigo-500/20 text-center relative overflow-hidden">
                    <div class="text-[10px] text-indigo-400 mb-1 font-bold">Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù‚Ø¨Ù„Ø©</div>
                    <div class="relative w-12 h-12 mx-auto mt-1 border-2 border-indigo-500/30 rounded-full flex items-center justify-center">
                        <i id="qiblaArrow" class="fa-solid fa-location-arrow text-xl text-white transition-all duration-1000"></i>
                    </div>
                    <div id="qiblaDegree" class="text-[10px] text-gray-400 mt-1">--Â°</div>
                </div>
            </div>

            <div class="glass-card">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xs font-bold text-gray-300"><i class="fa-regular fa-clock"></i> Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª</h3>
                    <span id="hijriDate" class="text-[10px] text-gray-500 font-mono">--/--/14--</span>
                </div>
                <div id="prayerList" class="grid grid-cols-5 gap-1 text-center">
                    </div>
            </div>

            <div class="glass-card border-yellow-500/30">
                <h3 class="text-xs font-bold text-yellow-500 mb-3 flex justify-between">
                    <span><i class="fa-solid fa-money-bill-transfer"></i> Ø§Ù„Ø³ÙƒÙˆØ§Ø± (Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…ÙˆØ§Ø²ÙŠØ©)</span>
                    <i class="fa-solid fa-rotate cursor-pointer hover:rotate-180 transition" onclick="calcCurrency()"></i>
                </h3>
                <div class="flex gap-2 items-center mb-2">
                    <input type="number" id="currAmount" value="100" class="w-1/3 bg-slate-800 border border-slate-600 rounded p-2 text-center text-sm font-bold">
                    <select id="currType" class="bg-slate-800 border border-slate-600 rounded p-2 text-xs text-white">
                        <option value="eur">â‚¬ Ø£ÙˆØ±Ùˆ</option>
                        <option value="usd">$ Ø¯ÙˆÙ„Ø§Ø±</option>
                    </select>
                    <i class="fa-solid fa-arrow-left text-gray-500 text-xs"></i>
                    <div id="currResult" class="flex-1 text-left font-mono font-bold text-green-400 text-sm">-- DA</div>
                </div>
                <div class="text-[10px] text-gray-500 flex justify-between items-center bg-slate-900/50 p-2 rounded">
                    <span>Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù (ØªÙ‚Ø±ÙŠØ¨ÙŠ):</span>
                    <input type="number" id="exchangeRate" value="245" class="w-12 bg-transparent border-b border-gray-600 text-center outline-none text-yellow-200">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="glass-card mb-0 hover:bg-slate-800/80 cursor-pointer transition" onclick="toggleCCP()">
                    <div class="text-center">
                        <i class="fa-solid fa-credit-card text-2xl text-blue-400 mb-2"></i>
                        <div class="text-xs font-bold">Ù…ÙØªØ§Ø­ CCP</div>
                    </div>
                </div>
                <div class="glass-card mb-0 hover:bg-slate-800/80 cursor-pointer transition" onclick="toggleGrade()">
                    <div class="text-center">
                        <i class="fa-solid fa-calculator text-2xl text-pink-400 mb-2"></i>
                        <div class="text-xs font-bold">Ø§Ù„Ù…Ø¹Ø¯Ù„</div>
                    </div>
                </div>
            </div>
            
            <div id="ccpTool" class="glass-card hidden mt-3 bg-blue-900/10 border-blue-500/20">
                <input type="number" id="ccpInput" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ù…ÙØªØ§Ø­)" class="w-full bg-slate-900 p-2 rounded border border-slate-700 text-center mb-2 text-sm">
                <button onclick="calcKey()" class="w-full bg-blue-600 text-white py-1 rounded text-xs">Ø§Ø­Ø³Ø¨</button>
                <div id="ccpRes" class="text-center font-bold text-xl mt-2 text-white"></div>
            </div>

        </main>

        <main id="view-settings" class="page">
            <h2 class="text-lg font-bold mb-4 px-1 text-gray-300">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
            
            <div class="glass-card">
                <label class="text-xs text-gray-400 font-bold mb-3 block">Ø´Ø®ØµÙŠØ© Ø§Ù„Ø¨ÙˆØª</label>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="setMode('darja', this)" class="mode-btn active bg-slate-800 p-3 rounded-xl text-xs border border-green-500 text-green-400">ğŸ‡©ğŸ‡¿ Ø§Ù„Ø¯Ø§Ø±Ø¬Ø© (Ø¹Ø§Ù…)</button>
                    <button onclick="setMode('admin', this)" class="mode-btn bg-slate-800 p-3 rounded-xl text-xs text-gray-400">âš–ï¸ Ø¨ÙŠØ±ÙˆÙ‚Ø±Ø§Ø·ÙŠ (Ø¥Ø¯Ø§Ø±ÙŠ)</button>
                    <button onclick="setMode('tech', this)" class="mode-btn bg-slate-800 p-3 rounded-xl text-xs text-gray-400">ğŸ’» Ù…Ø¨Ø±Ù…Ø¬ (Dev)</button>
                    <button onclick="setMode('chef', this)" class="mode-btn bg-slate-800 p-3 rounded-xl text-xs text-gray-400">ğŸ³ Ø´Ø§Ù Ø·Ø¨Ø®</button>
                </div>
            </div>

            <div class="glass-card">
                <label class="text-xs text-gray-400 font-bold mb-2 block">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</label>
                <select id="settingProvider" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-xs mb-2 text-gray-300" onchange="saveConfig()">
                    <option value="groq">Groq AI</option>
                    <option value="openai">OpenAI</option>
                </select>
                <div class="relative">
                    <input type="password" id="settingKey" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-xs font-mono" placeholder="API Key" onchange="saveConfig()">
                    <i class="fa-solid fa-eye absolute left-3 top-2.5 text-gray-500 cursor-pointer text-xs" onclick="toggleKeyVis()"></i>
                </div>
            </div>

            <button onclick="exportChatPDF()" class="w-full glass-card flex items-center justify-between text-xs font-bold text-gray-300 hover:bg-slate-800">
                <span><i class="fa-solid fa-file-export text-blue-400 ml-2"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© (PDF)</span>
                <i class="fa-solid fa-chevron-left text-gray-600"></i>
            </button>
            
            <button onclick="fullReset()" class="w-full mt-6 py-3 text-red-400 text-xs border border-red-900/50 rounded-xl bg-red-900/10 hover:bg-red-900/20">
                <i class="fa-solid fa-triangle-exclamation"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù…ØµÙ†Ø¹
            </button>
        </main>

        <nav class="bottom-nav">
            <div class="nav-item active" onclick="nav('chat', this)"><i class="fa-solid fa-comment-dots"></i><span>Ø´Ø§Øª</span></div>
            <div class="nav-item" onclick="nav('tools', this)"><i class="fa-solid fa-toolbox"></i><span>Ø£Ø¯ÙˆØ§Øª</span></div>
            <div class="nav-item" onclick="nav('settings', this)"><i class="fa-solid fa-sliders"></i><span>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></div>
        </nav>
    </div>

    <script>
        // --- Data: Wilayas Coordinates ---
        const WILAYAS = [
            {id:1, name:"Ø£Ø¯Ø±Ø§Ø±", lat:27.8742, lon:-0.2053}, {id:16, name:"Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±", lat:36.7528, lon:3.0420},
            {id:31, name:"ÙˆÙ‡Ø±Ø§Ù†", lat:35.6971, lon:-0.6308}, {id:25, name:"Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©", lat:36.3650, lon:6.6147},
            {id:23, name:"Ø¹Ù†Ø§Ø¨Ø©", lat:36.9000, lon:7.7667}, {id:30, name:"ÙˆØ±Ù‚Ù„Ø©", lat:31.9493, lon:5.3250},
            {id:19, name:"Ø³Ø·ÙŠÙ", lat:36.1898, lon:5.4107}, {id:15, name:"ØªÙŠØ²ÙŠ ÙˆØ²Ùˆ", lat:36.7118, lon:4.0459},
            {id:13, name:"ØªÙ„Ù…Ø³Ø§Ù†", lat:34.8783, lon:-1.3150}, {id:5, name:"Ø¨Ø§ØªÙ†Ø©", lat:35.5559, lon:6.1741},
            {id:9, name:"Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©", lat:36.4715, lon:2.8259}, {id:33, name:"Ø¥Ù„ÙŠØ²ÙŠ", lat:26.4893, lon:8.4670},
            {id:39, name:"Ø§Ù„ÙˆØ§Ø¯ÙŠ", lat:33.3561, lon:6.8631}, {id:47, name:"ØºØ±Ø¯Ø§ÙŠØ©", lat:32.4909, lon:3.6734}
        ]; // Added common ones to save space, logic supports all if array extended

        // --- Configuration & State ---
        const CONFIG = {
            modes: {
                darja: { name: "Ø§Ù„Ø¯Ø§Ø±Ø¬Ø©", prompt: "Act as a smart, witty Algerian assistant. Speak in Algerian Darja (Arabic/French mix). Keep answers concise and helpful. Use emojis." },
                admin: { name: "Ø¥Ø¯Ø§Ø±ÙŠ", prompt: "Act as an expert in Algerian bureaucracy. Write formal letters (Demande, Recours) strictly adhering to Algerian administrative standards. Be formal and precise." },
                tech: { name: "Ù…Ø¨Ø±Ù…Ø¬", prompt: "Act as a Senior Developer. Provide code snippets, explain concepts simply. Use markdown for code." },
                chef: { name: "Ø´Ø§Ù", prompt: "Ø£Ù†Øª Ø·Ø¨Ø§Ø® Ø¬Ø²Ø§Ø¦Ø±ÙŠ Ù…Ø­ØªØ±Ù. Ø§Ù‚ØªØ±Ø­ ÙˆØµÙØ§Øª ØªÙ‚Ù„ÙŠØ¯ÙŠØ© ÙˆØ¹ØµØ±ÙŠØ© Ø¨Ù…Ù‚Ø§Ø¯ÙŠØ± Ø¯Ù‚ÙŠÙ‚Ø©." }
            },
            models: { groq: 'llama-3.3-70b-versatile', openai: 'gpt-4o' }
        };

        let state = {
            lat: 36.75, lon: 3.05, city: "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±",
            chatHistory: [],
            mode: 'darja',
            voiceEnabled: false,
            nextPrayerTime: null,
            prayerInstance: null
        };

        // --- Initialization ---
        window.onload = () => {
            loadState();
            initWilayaSelect();
            
            if (!localStorage.getItem('dza_key')) {
                document.getElementById('welcomeModal').classList.remove('hidden');
            } else {
                renderChat();
                // Ensure Adhan library is loaded
                setTimeout(refreshTools, 500); 
            }
            // Auto-refresh widgets
            setInterval(updateTimers, 1000);
            
            marked.setOptions({
                highlight: function(code, lang) {
                    const language = highlight.getLanguage(lang) ? lang : 'plaintext';
                    return highlight.highlight(code, { language }).value;
                }
            });
        };

        function initWilayaSelect() {
            const sel = document.getElementById('wilayaSelect');
            WILAYAS.sort((a,b)=> a.id - b.id).forEach(w => {
                const opt = document.createElement('option');
                opt.value = w.id;
                opt.innerText = `${w.id}. ${w.name}`;
                sel.appendChild(opt);
            });
            // Add remaining generic option
            const other = document.createElement('option');
            other.innerText = "Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª (Ù‚Ø±ÙŠØ¨Ø§Ù‹)";
            other.disabled = true;
            sel.appendChild(other);
        }

        function loadState() {
            const savedLoc = JSON.parse(localStorage.getItem('dza_loc'));
            if(savedLoc) { 
                state.lat = savedLoc.lat; 
                state.lon = savedLoc.lon; 
                state.city = savedLoc.city; 
                if(savedLoc.isAuto === false) {
                   document.getElementById('wilayaSelect').value = savedLoc.wilayaId || 'auto';
                }
            }
            
            const savedChat = JSON.parse(localStorage.getItem('dza_history'));
            if(savedChat) state.chatHistory = savedChat;

            const key = localStorage.getItem('dza_key');
            if(key) {
                document.getElementById('settingKey').value = key;
                document.getElementById('settingProvider').value = localStorage.getItem('dza_provider') || 'groq';
            }
            updateUI();
        }

        function changeWilaya() {
            const val = document.getElementById('wilayaSelect').value;
            if(val === 'auto') {
                getUserLocation();
            } else {
                const w = WILAYAS.find(x => x.id == val);
                if(w) {
                    state.lat = w.lat;
                    state.lon = w.lon;
                    state.city = w.name;
                    localStorage.setItem('dza_loc', JSON.stringify({lat: state.lat, lon: state.lon, city: state.city, isAuto: false, wilayaId: val}));
                    updateUI();
                    refreshTools();
                }
            }
        }

        // --- Core: Chat & AI ---
        async function sendMessage() {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            if (!text) return;

            input.value = '';
            input.style.height = 'auto';
            addMessage('user', text);

            const apiKey = localStorage.getItem('dza_key');
            const provider = localStorage.getItem('dza_provider') || 'groq';
            const loaderId = addLoader();

            try {
                const systemMsg = {
                    role: "system", 
                    content: `${CONFIG.modes[state.mode].prompt}. Current Context: Location=${state.city}, Time=${new Date().toLocaleString('fr-DZ')}.`
                };
                
                const apiMessages = [systemMsg, ...state.chatHistory.slice(-10)];

                const endpoint = provider === 'groq' 
                    ? 'https://api.groq.com/openai/v1/chat/completions' 
                    : 'https://api.openai.com/v1/chat/completions';

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: CONFIG.models[provider],
                        messages: apiMessages,
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });

                const data = await response.json();
                removeLoader(loaderId);

                if (data.error) throw new Error(data.error.message || "API Error");
                
                const reply = data.choices[0].message.content;
                addMessage('assistant', reply);
                
                if (state.voiceEnabled) speak(reply);

            } catch (error) {
                removeLoader(loaderId);
                addMessage('system', `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}`);
            }
        }

        function addMessage(role, content) {
            if(role !== 'system') {
                state.chatHistory.push({ role, content });
                localStorage.setItem('dza_history', JSON.stringify(state.chatHistory));
            }

            const container = document.getElementById('chatContainer');
            const div = document.createElement('div');
            
            if (role === 'system') {
                div.className = 'text-center text-[10px] text-red-400 my-2';
                div.innerText = content;
            } else {
                div.className = `msg-bubble ${role === 'user' ? 'msg-user' : 'msg-bot'}`;
                if (role === 'assistant') {
                    div.innerHTML = marked.parse(content);
                    div.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                        const pre = block.parentElement;
                        const lang = block.className.replace('language-', '') || 'Code';
                        const header = document.createElement('div');
                        header.className = 'code-header';
                        header.innerHTML = `<span>${lang}</span><i class="fa-regular fa-copy cursor-pointer" onclick="copyCode(this)"></i>`;
                        pre.insertBefore(header, block);
                    });
                } else {
                    div.innerText = content;
                }
            }
            container.appendChild(div);
            window.scrollTo(0, document.body.scrollHeight);
            div.scrollIntoView({ behavior: "smooth", block: "end" });
        }

        function renderChat() {
            const container = document.getElementById('chatContainer');
            container.innerHTML = '';
            if (state.chatHistory.length === 0) {
                container.innerHTML = `<div class="msg-bubble msg-bot">Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Dza-Genius ğŸ‘‹<br>ÙˆØ§Ø´ Ø±Ø§Ùƒ Ø­Ø§Ø¨ ØªØ¯ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ØŸ</div>`;
                return;
            }
            state.chatHistory.forEach(msg => {
                const div = document.createElement('div');
                div.className = `msg-bubble ${msg.role === 'user' ? 'msg-user' : 'msg-bot'}`;
                if (msg.role === 'assistant') {
                    div.innerHTML = marked.parse(msg.content);
                } else {
                    div.innerText = msg.content;
                }
                container.appendChild(div);
            });
            document.querySelectorAll('pre code').forEach(hljs.highlightElement);
            window.scrollTo(0, document.body.scrollHeight);
        }

        function addLoader() {
            const id = 'loader-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'msg-bubble msg-bot w-16';
            div.innerHTML = `<div class="flex gap-1 justify-center"><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-100"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-200"></div></div>`;
            document.getElementById('chatContainer').appendChild(div);
            div.scrollIntoView();
            return id;
        }
        function removeLoader(id) { const el = document.getElementById(id); if(el) el.remove(); }

        // --- Tools & Widgets ---
        
        function getUserLocation() {
            const label = document.getElementById('headerCity');
            label.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            
            if(!navigator.geolocation) {
                alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹");
                return;
            }

            navigator.geolocation.getCurrentPosition(async (pos) => {
                state.lat = pos.coords.latitude;
                state.lon = pos.coords.longitude;
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${state.lat}&lon=${state.lon}`);
                    const json = await res.json();
                    state.city = json.address.city || json.address.town || json.address.state || "Ù…ÙˆÙ‚Ø¹ÙŠ";
                } catch(e) { state.city = "Ù…ÙˆÙ‚Ø¹ÙŠ"; }

                localStorage.setItem('dza_loc', JSON.stringify({lat: state.lat, lon: state.lon, city: state.city, isAuto: true}));
                document.getElementById('wilayaSelect').value = 'auto';
                updateUI();
                refreshTools();
            }, (err) => {
                label.innerHTML = '<i class="fa-solid fa-triangle-exclamation text-red-400"></i>';
                alert("ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆÙ„Ø§ÙŠØ© ÙŠØ¯ÙˆÙŠØ§Ù‹.");
            });
        }

        async function refreshTools() {
            // Weather
            try {
                const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${state.lat}&longitude=${state.lon}&current_weather=true`);
                const wData = await wRes.json();
                document.getElementById('weatherTemp').innerText = `${Math.round(wData.current_weather.temperature)}Â°`;
                document.getElementById('windSpeed').innerText = wData.current_weather.windspeed;
                const codes = {0:'ØµØ§ÙÙŠ', 1:'ØºØ§Ø¦Ù… Ø¬Ø²Ø¦ÙŠ', 2:'ØºØ§Ø¦Ù…', 3:'ØºØ§Ø¦Ù…', 61:'Ù…Ø·Ø±', 63:'Ù…Ø·Ø±', 80:'Ø²Ø®Ø§Øª'};
                document.getElementById('weatherDesc').innerText = codes[wData.current_weather.weathercode] || 'Ù…ØªØºÙŠØ±';
            } catch(e) {}

            // Prayers Logic Fixed
            if (typeof adhan !== 'undefined') {
                const coords = new adhan.Coordinates(state.lat, state.lon);
                const params = adhan.CalculationMethod.MuslimWorldLeague();
                params.madhab = adhan.Madhab.Shafi;
                
                const date = new Date();
                let prayerTimes = new adhan.PrayerTimes(coords, date, params);
                
                // Qibla Direction
                const qibla = adhan.Qibla(coords);
                document.getElementById('qiblaDegree').innerText = Math.round(qibla) + "Â°";
                document.getElementById('qiblaArrow').style.transform = `rotate(${qibla - 180}deg)`; // Adjust based on icon

                const fmt = t => t.toLocaleTimeString('fr-DZ', {hour:'2-digit', minute:'2-digit'});
                const names = {fajr:'Ø§Ù„ØµØ¨Ø­', dhuhr:'Ø§Ù„Ø¸Ù‡Ø±', asr:'Ø§Ù„Ø¹ØµØ±', maghrib:'Ø§Ù„Ù…ØºØ±Ø¨', isha:'Ø§Ù„Ø¹Ø´Ø§Ø¡'};
                
                const pList = document.getElementById('prayerList');
                pList.innerHTML = '';
                
                ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].forEach(p => {
                    const el = document.createElement('div');
                    el.className = 'flex flex-col bg-slate-800/50 rounded p-1 border border-slate-700/50';
                    el.innerHTML = `<span class="text-[10px] text-gray-400">${names[p]}</span><span class="font-bold font-mono text-xs">${fmt(prayerTimes[p])}</span>`;
                    pList.appendChild(el);
                });

                document.getElementById('hijriDate').innerText = new Intl.DateTimeFormat('ar-TN-u-ca-islamic', {day:'numeric', month:'long', year:'numeric'}).format(date);

                // Handle Next Prayer Logic
                let next = prayerTimes.nextPrayer();
                let nextTime = null;

                if(next === 'none') {
                    // Next prayer is tomorrow's Fajr
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    const pTomorrow = new adhan.PrayerTimes(coords, tomorrow, params);
                    next = 'fajr';
                    nextTime = pTomorrow.fajr;
                } else {
                    nextTime = prayerTimes.timeForPrayer(next);
                }

                state.prayerInstance = { next, nextTime, names };
            }
        }

        function updateTimers() {
            // Prayer Countdown Fixed
            if(state.prayerInstance && state.prayerInstance.nextTime) {
                const now = new Date();
                const diff = state.prayerInstance.nextTime - now;
                
                if (diff > 0) {
                    const h = Math.floor(diff / 3600000);
                    const m = Math.floor((diff % 3600000) / 60000);
                    const s = Math.floor((diff % 60000) / 1000);
                    
                    document.getElementById('nextPrayerName').innerText = state.prayerInstance.names[state.prayerInstance.next];
                    document.getElementById('nextPrayerCounter').innerText = `-${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                } else {
                    // Trigger refresh if time passed
                    refreshTools(); 
                }
            }
        }

        // --- Helper Logic ---
        function updateUI() {
            document.getElementById('headerCity').innerText = state.city;
            document.getElementById('weatherCity').innerText = state.city;
        }

        function calcCurrency() {
            const amount = parseFloat(document.getElementById('currAmount').value);
            const rate = parseFloat(document.getElementById('exchangeRate').value);
            if (!amount || !rate) return;
            const res = amount * rate;
            document.getElementById('currResult').innerText = res.toLocaleString() + " DA";
        }
        
        document.getElementById('currAmount').addEventListener('input', calcCurrency);
        document.getElementById('exchangeRate').addEventListener('input', calcCurrency);
        document.getElementById('currType').addEventListener('change', calcCurrency);

        function toggleCCP() { document.getElementById('ccpTool').classList.toggle('hidden'); }
        function toggleGrade() { alert("Ù‚Ø±ÙŠØ¨Ø§Ù‹: Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØµÙ„ÙŠ"); }
        
        function calcKey() {
            const num = document.getElementById('ccpInput').value;
            if(num) {
                const key = 97n - ((BigInt(num) * 100n) % 97n);
                document.getElementById('ccpRes').innerText = `ClÃ©: ${key.toString().padStart(2, '0')}`;
            }
        }

        // --- Audio & TTS ---
        function toggleSound() {
            state.voiceEnabled = !state.voiceEnabled;
            const btn = document.getElementById('soundBtn');
            if(state.voiceEnabled) {
                btn.classList.add('text-green-400');
                btn.innerHTML = '<i class="fa-solid fa-volume-high text-xs"></i>';
            } else {
                btn.classList.remove('text-green-400');
                btn.innerHTML = '<i class="fa-solid fa-volume-xmark text-xs"></i>';
                window.speechSynthesis.cancel();
            }
        }

        function speak(text) {
            if(!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const cleanText = text.replace(/[*#_`]/g, '');
            const utter = new SpeechSynthesisUtterance(cleanText);
            const voices = window.speechSynthesis.getVoices();
            const arVoice = voices.find(v => v.lang.includes('ar'));
            if(arVoice) utter.voice = arVoice;
            utter.rate = 1.1;
            window.speechSynthesis.speak(utter);
        }

        function toggleVoice() {
            const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!Recognition) return alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù‡Ø°Ø§");
            const rec = new Recognition();
            rec.lang = 'ar-DZ';
            rec.start();
            const btn = document.getElementById('micBtn');
            btn.classList.add('text-red-500', 'animate-pulse');
            rec.onresult = (event) => {
                document.getElementById('msgInput').value += event.results[0][0].transcript;
                btn.classList.remove('text-red-500', 'animate-pulse');
            };
            rec.onerror = () => btn.classList.remove('text-red-500', 'animate-pulse');
            rec.onend = () => btn.classList.remove('text-red-500', 'animate-pulse');
        }

        // --- Utility ---
        function nav(pageId, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('view-'+pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if(btn) btn.classList.add('active');
        }

        function finishOnboarding() {
            const k = document.getElementById('welcomeKey').value;
            const p = document.getElementById('welcomeProvider').value;
            if(k) {
                localStorage.setItem('dza_key', k);
                localStorage.setItem('dza_provider', p);
                document.getElementById('welcomeModal').classList.add('hidden');
                loadState();
                setTimeout(refreshTools, 500);
            } else alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙØªØ§Ø­");
        }

        function saveConfig() {
            localStorage.setItem('dza_key', document.getElementById('settingKey').value);
            localStorage.setItem('dza_provider', document.getElementById('settingProvider').value);
        }

        function toggleKeyVis() {
            const inp = document.getElementById('settingKey');
            inp.type = inp.type === 'password' ? 'text' : 'password';
        }

        function setMode(mode, btn) {
            state.mode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => {
                b.classList.remove('active', 'border-green-500', 'text-green-400');
                b.classList.add('text-gray-400');
            });
            btn.classList.add('active', 'border-green-500', 'text-green-400');
            btn.classList.remove('text-gray-400');
            state.chatHistory = []; 
            renderChat();
            addMessage('system', `ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ø®ØµÙŠØ© Ø¥Ù„Ù‰: ${CONFIG.modes[mode].name}`);
        }

        function clearChat() { if(confirm("Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ")) { state.chatHistory = []; localStorage.removeItem('dza_history'); renderChat(); } }
        function fullReset() { if(confirm("Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) { localStorage.clear(); location.reload(); } }
        function exportChatPDF() { const el = document.getElementById('chatContainer'); html2pdf().set({ margin: 10, filename: 'Dza-Chat.pdf', backgroundColor: '#1e293b' }).from(el).save(); }
        function setInput(txt) { document.getElementById('msgInput').value = txt; sendMessage(); }
        function copyCode(icon) {
            const code = icon.parentElement.nextElementSibling.innerText;
            navigator.clipboard.writeText(code);
            icon.classList.remove('fa-copy'); icon.classList.add('fa-check', 'text-green-500');
            setTimeout(() => { icon.classList.remove('fa-check', 'text-green-500'); icon.classList.add('fa-copy'); }, 2000);
        }
    </script>
</body>
</html>
