<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">
    <title>Dza-Genius V12 Ultra</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/adhan/4.4.4/Adhan.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&family=Fira+Code:wght@400&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #10b981; --bg-dark: #0f172a; --safe-top: env(safe-area-inset-top, 20px); --safe-bottom: env(safe-area-inset-bottom, 20px); }
        body { font-family: 'Cairo', sans-serif; background: var(--bg-dark); color: #f8fafc; height: 100dvh; overflow: hidden; background-image: radial-gradient(#1e293b 1px, transparent 1px); background-size: 24px 24px; }
        .app-layout { display: flex; flex-direction: column; height: 100%; padding-top: var(--safe-top); padding-bottom: calc(75px + var(--safe-bottom)); }
        
        .page { display: none; height: 100%; overflow-y: auto; padding: 16px; scroll-behavior: smooth; padding-bottom: 100px; }
        .page.active { display: block; animation: fadeUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        
        .msg-bubble { max-width: 90%; padding: 12px 16px; margin-bottom: 12px; border-radius: 18px; position: relative; font-size: 15px; line-height: 1.6; box-shadow: 0 2px 5px rgba(0,0,0,0.1); word-wrap: break-word; }
        .msg-bot { background: #1e293b; color: #e2e8f0; border: 1px solid #334155; border-bottom-left-radius: 4px; }
        .msg-user { background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; margin-right: auto; border-bottom-right-radius: 4px; }
        
        pre { background: #111827 !important; padding: 0 !important; border-radius: 8px !important; overflow: hidden; margin: 10px 0; border: 1px solid #374151; direction: ltr; }
        pre code { font-family: 'Fira Code', monospace; font-size: 13px; display: block; padding: 12px; overflow-x: auto; }
        .code-header { background: #1f2937; padding: 4px 12px; font-size: 11px; color: #9ca3af; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #374151; }

        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); border-radius: 20px; padding: 16px; margin-bottom: 14px; transition: transform 0.2s; }
        
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: calc(70px + var(--safe-bottom)); background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-around; padding-top: 10px; z-index: 50; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #64748b; width: 20%; transition: 0.3s; cursor: pointer; }
        .nav-item.active { color: var(--primary); transform: translateY(-4px); font-weight: bold; }
        .nav-item i { font-size: 20px; margin-bottom: 4px; }

        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Typing dot animation */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="welcomeModal" class="fixed inset-0 z-[100] flex items-center justify-center p-6 hidden bg-black/90 backdrop-blur-md">
        <div class="glass-card w-full max-w-sm text-center border border-green-500/30 shadow-2xl shadow-green-900/40 relative overflow-hidden animate-fadeUp">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-green-500 to-teal-500"></div>
            <div class="w-16 h-16 bg-gradient-to-tr from-green-600 to-teal-800 rounded-2xl flex items-center justify-center mx-auto mb-4 text-2xl shadow-lg">ğŸ‡©ğŸ‡¿</div>
            <h2 class="text-xl font-black mb-1 text-white">Dza-Genius V12</h2>
            <p class="text-xs text-gray-400 mb-5">Ø§Ù„Ø±ÙÙŠÙ‚ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±ÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</p>
            
            <div class="text-right mb-4 bg-slate-900/80 p-4 rounded-xl border border-slate-700">
                <label class="text-[10px] text-gray-500 uppercase font-bold block mb-2">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø±Ùƒ (AI Provider)</label>
                <select id="welcomeProvider" class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2 text-xs mb-3 text-white outline-none">
                    <option value="gemini">Google Gemini (Ù…Ø¬Ø§Ù†ÙŠ ÙˆÙ‚ÙˆÙŠ Ø¬Ø¯Ø§Ù‹ ğŸ”¥)</option>
                    <option value="groq">Groq (Llama 3 - Ø³Ø±ÙŠØ¹)</option>
                    <option value="openai">OpenAI (GPT-4)</option>
                </select>
                
                <label class="text-[10px] text-gray-500 uppercase font-bold block mb-2">API Key</label>
                <input type="password" id="welcomeKey" placeholder="Ø£Ù„ØµÙ‚ Ø§Ù„Ù…ÙØªØ§Ø­ Ù‡Ù†Ø§..." class="w-full bg-slate-800 border border-slate-600 rounded-lg p-2 text-xs font-mono text-white outline-none focus:border-green-500">
                <div id="keyLinks" class="mt-2 text-center">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-[10px] text-blue-400 block hover:underline">Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ Gemini Ù…Ø¬Ø§Ù†Ø§Ù‹</a>
                </div>
            </div>
            <button onclick="finishOnboarding()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl transition shadow-lg text-sm">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…ØºØ§Ù…Ø±Ø© ğŸš€</button>
        </div>
    </div>

    <div class="app-layout">
        <header class="flex justify-between items-center px-4 py-3 bg-slate-900/80 backdrop-blur sticky top-0 z-40 border-b border-slate-800/60">
            <div class="flex items-center gap-3">
                <div class="relative">
                    <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-green-500 to-teal-700 flex items-center justify-center text-white font-bold text-xs shadow-lg shadow-green-900/20">DZ</div>
                    <div class="absolute -bottom-1 -right-1 bg-slate-900 rounded-full p-0.5"><div class="w-2.5 h-2.5 bg-green-500 rounded-full animate-pulse border border-slate-900"></div></div>
                </div>
                <div class="leading-tight">
                    <h1 class="font-bold text-sm text-white tracking-wide">Dza-Genius <span class="text-[9px] bg-green-900/30 text-green-400 px-1 rounded border border-green-500/20">V12</span></h1>
                    <div class="text-[10px] text-gray-400 cursor-pointer flex items-center gap-1 hover:text-green-300 transition" onclick="nav('tools', document.querySelector('.nav-item:nth-child(2)'))">
                        <i class="fa-solid fa-location-dot"></i> <span id="headerCity">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...</span>
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="clearChat()" class="w-8 h-8 rounded-full bg-slate-800 text-red-400 border border-slate-700 flex items-center justify-center hover:bg-red-900/20 transition" title="Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©">
                    <i class="fa-solid fa-eraser text-xs"></i>
                </button>
                <button onclick="toggleSound()" id="soundBtn" class="w-8 h-8 rounded-full bg-slate-800 text-gray-400 border border-slate-700 flex items-center justify-center hover:text-green-400 transition" title="Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„ØµÙˆØªÙŠ">
                    <i class="fa-solid fa-volume-xmark text-xs"></i>
                </button>
            </div>
        </header>

        <main id="view-chat" class="page active">
            <div id="chatContainer" class="min-h-[60vh] flex flex-col justify-end"></div>
            
            <div class="fixed bottom-[calc(70px+var(--safe-bottom))] left-0 right-0 px-3 py-2 z-40 bg-gradient-to-t from-slate-900 via-slate-900/95 to-transparent">
                <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide mb-1 px-1" id="quickSuggestions">
                    <button onclick="setInput('ÙˆØ§Ø´ Ù‡Ùˆ Ø³Ø¹Ø± Ø§Ù„Ø£ÙˆØ±Ùˆ Ø§Ù„ÙŠÙˆÙ… ÙÙŠ Ø§Ù„Ø³ÙƒÙˆØ§Ø±ØŸ')" class="whitespace-nowrap bg-slate-800/80 border border-slate-700 text-[10px] text-gray-300 px-3 py-1.5 rounded-full hover:bg-slate-700 transition">ğŸ’¶ Ø³Ø¹Ø± Ø§Ù„Ø£ÙˆØ±Ùˆ</button>
                    <button onclick="setInput('Ø£ÙƒØªØ¨ Ù„ÙŠ Ø¯ÙˆÙ…ÙˆÙ†Ø¯ Ø®Ø·ÙŠØ© Ø¨Ø§Ø´ Ù†Ø´Ø§Ø±Ùƒ ÙÙŠ Ù…Ø³Ø§Ø¨Ù‚Ø© ØªÙˆØ¸ÙŠÙ')" class="whitespace-nowrap bg-slate-800/80 border border-slate-700 text-[10px] text-gray-300 px-3 py-1.5 rounded-full hover:bg-slate-700 transition">ğŸ“ Ø·Ù„Ø¨ Ø®Ø·ÙŠ</button>
                    <button onclick="setInput('Ø£Ø¹Ø·ÙŠÙ†ÙŠ Ù†ÙƒØªØ© Ø¬Ø²Ø§Ø¦Ø±ÙŠØ© ØªØ¶Ø­Ùƒ')" class="whitespace-nowrap bg-slate-800/80 border border-slate-700 text-[10px] text-gray-300 px-3 py-1.5 rounded-full hover:bg-slate-700 transition">ğŸ˜‚ Ù†ÙƒØªØ©</button>
                    <button onclick="setInput('ÙˆØµÙØ© Ø´Ø·ÙŠØ·Ø­Ø© Ø¯Ø¬Ø§Ø¬ Ø³Ù‡Ù„Ø©')" class="whitespace-nowrap bg-slate-800/80 border border-slate-700 text-[10px] text-gray-300 px-3 py-1.5 rounded-full hover:bg-slate-700 transition">ğŸ¥˜ ÙˆØµÙØ© Ø·Ø¨Ø®</button>
                </div>

                <div class="max-w-3xl mx-auto flex items-end gap-2 bg-slate-800/90 backdrop-blur p-1.5 rounded-[24px] border border-slate-700 shadow-2xl">
                    <button id="micBtn" onclick="toggleVoice()" class="w-10 h-10 rounded-full bg-slate-700/50 text-gray-400 hover:text-white transition flex-shrink-0">
                        <i class="fa-solid fa-microphone"></i>
                    </button>
                    <textarea id="msgInput" rows="1" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§..." class="flex-1 bg-transparent text-white text-sm py-3 px-1 focus:outline-none resize-none max-h-32 placeholder-slate-500 dir-rtl" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
                    <button onclick="sendMessage()" id="sendBtn" class="w-10 h-10 rounded-full bg-green-600 hover:bg-green-500 text-white shadow-lg shadow-green-900/30 transition transform active:scale-90 flex-shrink-0 flex items-center justify-center">
                        <i class="fa-solid fa-paper-plane text-sm"></i>
                    </button>
                </div>
            </div>
        </main>

        <main id="view-tools" class="page">
            <div class="glass-card p-3 flex gap-2 items-center mb-4 border-blue-500/30 bg-blue-900/10">
                <i class="fa-solid fa-map-location-dot text-blue-400"></i>
                <select id="wilayaSelect" onchange="changeWilaya()" class="bg-transparent w-full text-sm text-white font-bold outline-none cursor-pointer">
                    <option value="auto">ğŸ“ ØªØ­Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ (GPS)</option>
                    </select>
            </div>

            <div class="glass-card bg-gradient-to-br from-blue-900/20 to-slate-900 border-r-4 border-blue-500 relative overflow-hidden">
                <div class="flex justify-between items-start z-10 relative">
                    <div>
                        <h3 class="text-xs text-blue-300 font-bold mb-1"><i class="fa-solid fa-cloud"></i> Ø§Ù„Ø·Ù‚Ø³</h3>
                        <div class="flex items-baseline gap-2">
                            <span id="weatherTemp" class="text-3xl font-black text-white">--Â°</span>
                            <span id="weatherDesc" class="text-xs text-gray-400">..</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div id="weatherCity" class="text-xs font-bold text-white mb-1">---</div>
                        <div class="text-[10px] text-blue-400"><i class="fa-solid fa-wind"></i> <span id="windSpeed">--</span> km/h</div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="glass-card mb-0 p-3 bg-gradient-to-br from-green-900/20 to-slate-900 border-green-500/20">
                    <div class="text-[10px] text-green-400 mb-1 font-bold">Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</div>
                    <div id="nextPrayerName" class="text-xs text-gray-300">--</div>
                    <div id="nextPrayerCounter" class="text-xl font-mono font-bold text-white mt-1">--:--</div>
                </div>
                <div class="glass-card mb-0 p-3 bg-gradient-to-br from-indigo-900/20 to-slate-900 border-indigo-500/20 text-center relative overflow-hidden">
                    <div class="text-[10px] text-indigo-400 mb-1 font-bold">Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù‚Ø¨Ù„Ø©</div>
                    <div class="relative w-12 h-12 mx-auto mt-1 border-2 border-indigo-500/30 rounded-full flex items-center justify-center">
                        <i id="qiblaArrow" class="fa-solid fa-location-arrow text-xl text-white transition-all duration-1000"></i>
                    </div>
                    <div id="qiblaDegree" class="text-[10px] text-gray-400 mt-1">--Â°</div>
                </div>
            </div>

            <div class="glass-card">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xs font-bold text-gray-300"><i class="fa-regular fa-clock"></i> Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª</h3>
                    <span id="hijriDate" class="text-[10px] text-gray-500 font-mono">--/--/14--</span>
                </div>
                <div id="prayerList" class="grid grid-cols-5 gap-1 text-center"></div>
            </div>

            <div class="glass-card border-yellow-500/30">
                <h3 class="text-xs font-bold text-yellow-500 mb-3 flex justify-between">
                    <span><i class="fa-solid fa-money-bill-transfer"></i> Ø§Ù„Ø³ÙƒÙˆØ§Ø± (Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…ÙˆØ§Ø²ÙŠØ©)</span>
                    <i class="fa-solid fa-rotate cursor-pointer hover:rotate-180 transition" onclick="calcCurrency()"></i>
                </h3>
                <div class="flex gap-2 items-center mb-2">
                    <input type="number" id="currAmount" value="100" class="w-1/3 bg-slate-800 border border-slate-600 rounded p-2 text-center text-sm font-bold text-white">
                    <select id="currType" class="bg-slate-800 border border-slate-600 rounded p-2 text-xs text-white">
                        <option value="eur">â‚¬ Ø£ÙˆØ±Ùˆ</option>
                        <option value="usd">$ Ø¯ÙˆÙ„Ø§Ø±</option>
                    </select>
                    <i class="fa-solid fa-arrow-left text-gray-500 text-xs"></i>
                    <div id="currResult" class="flex-1 text-left font-mono font-bold text-green-400 text-sm">-- DA</div>
                </div>
                <div class="text-[10px] text-gray-500 flex justify-between items-center bg-slate-900/50 p-2 rounded">
                    <span>Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù (ÙŠØ¯ÙˆÙŠ):</span>
                    <input type="number" id="exchangeRate" value="250" class="w-16 bg-transparent border-b border-gray-600 text-center outline-none text-yellow-200">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 pb-8">
                <div class="glass-card mb-0 hover:bg-slate-800/80 cursor-pointer transition" onclick="toggleTool('ccpTool')">
                    <div class="text-center">
                        <i class="fa-solid fa-credit-card text-2xl text-blue-400 mb-2"></i>
                        <div class="text-xs font-bold">Ù…ÙØªØ§Ø­ CCP</div>
                    </div>
                </div>
                <div class="glass-card mb-0 hover:bg-slate-800/80 cursor-pointer transition" onclick="toggleTool('gradeTool')">
                    <div class="text-center">
                        <i class="fa-solid fa-calculator text-2xl text-pink-400 mb-2"></i>
                        <div class="text-xs font-bold">Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„</div>
                    </div>
                </div>
            </div>
            
            <div id="ccpTool" class="glass-card hidden mt-3 bg-blue-900/10 border-blue-500/20 animate-fadeUp">
                <h3 class="text-xs font-bold text-blue-400 mb-2">Ø­Ø³Ø§Ø¨ Ù…ÙØªØ§Ø­ Ø§Ù„Ø¨Ø±ÙŠØ¯ (ClÃ© CCP)</h3>
                <input type="number" id="ccpInput" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ù…ÙØªØ§Ø­)" class="w-full bg-slate-900 p-2 rounded border border-slate-700 text-center mb-2 text-sm text-white">
                <button onclick="calcKey()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded text-xs font-bold">Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…ÙØªØ§Ø­</button>
                <div id="ccpRes" class="text-center font-bold text-xl mt-3 text-white"></div>
            </div>

            <div id="gradeTool" class="glass-card hidden mt-3 bg-pink-900/10 border-pink-500/20 animate-fadeUp">
                <h3 class="text-xs font-bold text-pink-400 mb-2">Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØµÙ„ÙŠ</h3>
                <div id="gradeInputs" class="space-y-2 mb-2">
                    </div>
                <div class="flex gap-2 mb-2">
                    <button onclick="addSubject()" class="w-1/2 bg-slate-700 hover:bg-slate-600 text-white py-1 rounded text-[10px]"><i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</button>
                    <button onclick="resetGrade()" class="w-1/2 bg-red-900/50 hover:bg-red-900 text-red-300 py-1 rounded text-[10px]">Ù…Ø³Ø­</button>
                </div>
                <button onclick="calcGrade()" class="w-full bg-pink-600 hover:bg-pink-500 text-white py-2 rounded text-xs font-bold">Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„</button>
                <div id="gradeRes" class="text-center font-bold text-xl mt-3 text-white"></div>
            </div>

        </main>

        <main id="view-settings" class="page">
            <h2 class="text-lg font-bold mb-4 px-1 text-gray-300">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
            
            <div class="glass-card">
                <label class="text-xs text-gray-400 font-bold mb-3 block">Ø´Ø®ØµÙŠØ© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</label>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="setMode('darja', this)" class="mode-btn active bg-slate-800 p-3 rounded-xl text-xs border border-green-500 text-green-400 transition">ğŸ‡©ğŸ‡¿ Ø§Ù„Ø¯Ø§Ø±Ø¬Ø© (Ø¹Ø§Ù…)</button>
                    <button onclick="setMode('admin', this)" class="mode-btn bg-slate-800 p-3 rounded-xl text-xs text-gray-400 border border-transparent transition">âš–ï¸ Ø¨ÙŠØ±ÙˆÙ‚Ø±Ø§Ø·ÙŠ (Ø¥Ø¯Ø§Ø±ÙŠ)</button>
                    <button onclick="setMode('tech', this)" class="mode-btn bg-slate-800 p-3 rounded-xl text-xs text-gray-400 border border-transparent transition">ğŸ’» Ù…Ø¨Ø±Ù…Ø¬ (Dev)</button>
                    <button onclick="setMode('chef', this)" class="mode-btn bg-slate-800 p-3 rounded-xl text-xs text-gray-400 border border-transparent transition">ğŸ³ Ø´Ø§Ù Ø·Ø¨Ø®</button>
                </div>
            </div>

            <div class="glass-card">
                <label class="text-xs text-gray-400 font-bold mb-2 block">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ (API)</label>
                <select id="settingProvider" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-xs mb-2 text-gray-300 outline-none" onchange="updateKeyLink()">
                    <option value="gemini">Google Gemini</option>
                    <option value="groq">Groq AI</option>
                    <option value="openai">OpenAI</option>
                </select>
                <div class="relative">
                    <input type="password" id="settingKey" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-xs font-mono text-white outline-none focus:border-green-500 transition" placeholder="API Key">
                    <i class="fa-solid fa-eye absolute left-3 top-2.5 text-gray-500 cursor-pointer text-xs" onclick="toggleKeyVis()"></i>
                </div>
                <div id="settingLink" class="mt-2 text-right"></div>
                <button onclick="saveConfig()" class="w-full mt-3 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded text-xs">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
            </div>

            <button onclick="exportChatPDF()" class="w-full glass-card flex items-center justify-between text-xs font-bold text-gray-300 hover:bg-slate-800 cursor-pointer transition">
                <span><i class="fa-solid fa-file-export text-blue-400 ml-2"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© (PDF)</span>
                <i class="fa-solid fa-chevron-left text-gray-600"></i>
            </button>
            
            <button onclick="fullReset()" class="w-full mt-6 py-3 text-red-400 text-xs border border-red-900/50 rounded-xl bg-red-900/10 hover:bg-red-900/20 transition font-bold">
                <i class="fa-solid fa-triangle-exclamation"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù…ØµÙ†Ø¹ (Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
            </button>
            
            <p class="text-[10px] text-gray-600 text-center mt-4 font-mono">Dza-Genius V12.0 Ultra Build 2024</p>
        </main>

        <nav class="bottom-nav">
            <div class="nav-item active" onclick="nav('chat', this)"><i class="fa-solid fa-comment-dots"></i><span>Ø´Ø§Øª</span></div>
            <div class="nav-item" onclick="nav('tools', this)"><i class="fa-solid fa-toolbox"></i><span>Ø£Ø¯ÙˆØ§Øª</span></div>
            <div class="nav-item" onclick="nav('settings', this)"><i class="fa-solid fa-sliders"></i><span>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></div>
        </nav>
    </div>

    <script>
        // --- Data: Wilayas ---
        const WILAYAS = [
            {id:1, name:"Ø£Ø¯Ø±Ø§Ø±", lat:27.8742, lon:-0.2053}, {id:2, name:"Ø§Ù„Ø´Ù„Ù", lat:36.1652, lon:1.3345},
            {id:3, name:"Ø§Ù„Ø£ØºÙˆØ§Ø·", lat:33.8000, lon:2.8651}, {id:4, name:"Ø£Ù… Ø§Ù„Ø¨ÙˆØ§Ù‚ÙŠ", lat:35.8754, lon:7.1135},
            {id:5, name:"Ø¨Ø§ØªÙ†Ø©", lat:35.5559, lon:6.1741}, {id:6, name:"Ø¨Ø¬Ø§ÙŠØ©", lat:36.7558, lon:5.0843},
            {id:7, name:"Ø¨Ø³ÙƒØ±Ø©", lat:34.8505, lon:5.7280}, {id:8, name:"Ø¨Ø´Ø§Ø±", lat:31.6166, lon:-2.2199},
            {id:9, name:"Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©", lat:36.4715, lon:2.8259}, {id:10, name:"Ø§Ù„Ø¨ÙˆÙŠØ±Ø©", lat:36.3748, lon:3.9020},
            {id:11, name:"ØªÙ…Ù†Ø±Ø§Ø³Øª", lat:22.7850, lon:5.5228}, {id:12, name:"ØªØ¨Ø³Ø©", lat:35.4041, lon:8.1143},
            {id:13, name:"ØªÙ„Ù…Ø³Ø§Ù†", lat:34.8783, lon:-1.3150}, {id:14, name:"ØªÙŠØ§Ø±Øª", lat:35.3710, lon:1.3169},
            {id:15, name:"ØªÙŠØ²ÙŠ ÙˆØ²Ùˆ", lat:36.7118, lon:4.0459}, {id:16, name:"Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±", lat:36.7528, lon:3.0420},
            {id:17, name:"Ø§Ù„Ø¬Ù„ÙØ©", lat:34.6727, lon:3.2630}, {id:18, name:"Ø¬ÙŠØ¬Ù„", lat:36.8205, lon:5.7667},
            {id:19, name:"Ø³Ø·ÙŠÙ", lat:36.1898, lon:5.4107}, {id:20, name:"Ø³Ø¹ÙŠØ¯Ø©", lat:34.8303, lon:0.1517},
            {id:21, name:"Ø³ÙƒÙŠÙƒØ¯Ø©", lat:36.8761, lon:6.9092}, {id:22, name:"Ø³ÙŠØ¯ÙŠ Ø¨Ù„Ø¹Ø¨Ø§Ø³", lat:35.1899, lon:-0.6308},
            {id:23, name:"Ø¹Ù†Ø§Ø¨Ø©", lat:36.9000, lon:7.7667}, {id:24, name:"Ù‚Ø§Ù„Ù…Ø©", lat:36.4621, lon:7.4260},
            {id:25, name:"Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©", lat:36.3650, lon:6.6147}, {id:26, name:"Ø§Ù„Ù…Ø¯ÙŠØ©", lat:36.2641, lon:2.7539},
            {id:27, name:"Ù…Ø³ØªØºØ§Ù†Ù…", lat:35.9311, lon:0.0891}, {id:28, name:"Ø§Ù„Ù…Ø³ÙŠÙ„Ø©", lat:35.7058, lon:4.5419},
            {id:29, name:"Ù…Ø¹Ø³ÙƒØ±", lat:35.3966, lon:0.1402}, {id:30, name:"ÙˆØ±Ù‚Ù„Ø©", lat:31.9493, lon:5.3250},
            {id:31, name:"ÙˆÙ‡Ø±Ø§Ù†", lat:35.6971, lon:-0.6308}, {id:32, name:"Ø§Ù„Ø¨ÙŠØ¶", lat:33.6802, lon:1.0192},
            {id:33, name:"Ø¥Ù„ÙŠØ²ÙŠ", lat:26.4893, lon:8.4670}, {id:34, name:"Ø¨Ø±Ø¬ Ø¨ÙˆØ¹Ø±ÙŠØ±ÙŠØ¬", lat:36.0707, lon:4.7692},
            {id:35, name:"Ø¨ÙˆÙ…Ø±Ø¯Ø§Ø³", lat:36.7597, lon:3.4730}, {id:36, name:"Ø§Ù„Ø·Ø§Ø±Ù", lat:36.7672, lon:8.2211},
            {id:37, name:"ØªÙ†Ø¯ÙˆÙ", lat:27.6711, lon:-8.1474}, {id:38, name:"ØªÙŠØ³Ù…Ø³ÙŠÙ„Øª", lat:35.6072, lon:1.8109},
            {id:39, name:"Ø§Ù„ÙˆØ§Ø¯ÙŠ", lat:33.3561, lon:6.8631}, {id:40, name:"Ø®Ù†Ø´Ù„Ø©", lat:35.4358, lon:7.1433},
            {id:41, name:"Ø³ÙˆÙ‚ Ø£Ù‡Ø±Ø§Ø³", lat:36.2863, lon:7.9511}, {id:42, name:"ØªÙŠØ¨Ø§Ø²Ø©", lat:36.5897, lon:2.4475},
            {id:43, name:"Ù…ÙŠÙ„Ø©", lat:36.4502, lon:6.2644}, {id:44, name:"Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰", lat:36.2619, lon:1.9679},
            {id:45, name:"Ø§Ù„Ù†Ø¹Ø§Ù…Ø©", lat:32.6952, lon:-0.3109}, {id:46, name:"Ø¹ÙŠÙ† ØªÙ…ÙˆØ´Ù†Øª", lat:35.2974, lon:-1.1403},
            {id:47, name:"ØºØ±Ø¯Ø§ÙŠØ©", lat:32.4909, lon:3.6734}, {id:48, name:"ØºÙ„ÙŠØ²Ø§Ù†", lat:35.7373, lon:0.5559}
        ];

        // --- Configuration & State ---
        const CONFIG = {
            modes: {
                darja: { name: "Ø§Ù„Ø¯Ø§Ø±Ø¬Ø©", prompt: "You are a smart, funny Algerian assistant. Speak in Algerian Darja (mix of Arabic and French). Use Algerian slang (Ya kho, Sahbi, etc.) and Emojis. Be helpful but brief." },
                admin: { name: "Ø¥Ø¯Ø§Ø±ÙŠ", prompt: "Act as an expert in Algerian Bureaucracy. Write formal requests (Demande manuscrite, Recours, Lettre de motivation) strictly following Algerian administrative standards. Use formal Arabic or French as requested." },
                tech: { name: "Ù…Ø¨Ø±Ù…Ø¬", prompt: "You are a Senior Software Engineer. Provide clean, efficient code. Explain concepts simply. Use Markdown for code blocks." },
                chef: { name: "Ø´Ø§Ù", prompt: "Ø£Ù†Øª Ø·Ø¨Ø§Ø® Ø¬Ø²Ø§Ø¦Ø±ÙŠ Ù…Ø­ØªØ±Ù. Ø§Ù‚ØªØ±Ø­ ÙˆØµÙØ§Øª ØªÙ‚Ù„ÙŠØ¯ÙŠØ© ÙˆØ¹ØµØ±ÙŠØ© Ø¨Ù…Ù‚Ø§Ø¯ÙŠØ± Ø¯Ù‚ÙŠÙ‚Ø© Ø¬Ø¯Ø§Ù‹ Ù…Ø¹ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ­Ø¶ÙŠØ±." }
            },
            models: { 
                gemini: 'gemini-1.5-flash',
                groq: 'llama-3.3-70b-versatile', 
                openai: 'gpt-4o-mini' 
            }
        };

        let state = {
            lat: 36.75, lon: 3.05, city: "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±",
            chatHistory: [],
            mode: 'darja',
            voiceEnabled: false,
            prayerInstance: null,
            subjects: [] // For Grade Calculator
        };

        // --- Initialization ---
        window.onload = () => {
            initWilayaSelect();
            loadState();
            addSubject(); // Add one subject field by default
            
            // Highlight setup
            hljs.highlightAll();

            if (!localStorage.getItem('dza_key')) {
                document.getElementById('welcomeModal').classList.remove('hidden');
                updateKeyLink();
            } else {
                renderChat();
                // Delay tools refresh to ensure libraries load
                setTimeout(() => { refreshTools(); updateTimers(); }, 1000); 
            }
            
            setInterval(updateTimers, 1000);
            
            // Setup Marked
            marked.setOptions({
                highlight: function(code, lang) {
                    const language = highlight.getLanguage(lang) ? lang : 'plaintext';
                    return highlight.highlight(code, { language }).value;
                }
            });
        };

        function initWilayaSelect() {
            const sel = document.getElementById('wilayaSelect');
            WILAYAS.sort((a,b)=> a.id - b.id).forEach(w => {
                const opt = document.createElement('option');
                opt.value = w.id;
                opt.innerText = `${w.id}. ${w.name}`;
                opt.className = "text-black";
                sel.appendChild(opt);
            });
        }

        function loadState() {
            const savedLoc = JSON.parse(localStorage.getItem('dza_loc'));
            if(savedLoc) { 
                state.lat = savedLoc.lat; 
                state.lon = savedLoc.lon; 
                state.city = savedLoc.city; 
                if(savedLoc.isAuto === false) {
                   document.getElementById('wilayaSelect').value = savedLoc.wilayaId || 'auto';
                }
            }
            
            const savedChat = JSON.parse(localStorage.getItem('dza_history'));
            if(savedChat) state.chatHistory = savedChat;

            const key = localStorage.getItem('dza_key');
            if(key) {
                document.getElementById('settingKey').value = key;
                document.getElementById('settingProvider').value = localStorage.getItem('dza_provider') || 'gemini';
                updateKeyLink();
            }
            updateUI();
        }

        function changeWilaya() {
            const val = document.getElementById('wilayaSelect').value;
            if(val === 'auto') {
                getUserLocation();
            } else {
                const w = WILAYAS.find(x => x.id == val);
                if(w) {
                    state.lat = w.lat;
                    state.lon = w.lon;
                    state.city = w.name;
                    localStorage.setItem('dza_loc', JSON.stringify({lat: state.lat, lon: state.lon, city: state.city, isAuto: false, wilayaId: val}));
                    updateUI();
                    refreshTools();
                }
            }
        }

        // --- Core: Chat & AI ---
        async function sendMessage() {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            if (!text) return;

            input.value = '';
            input.style.height = 'auto';
            addMessage('user', text);

            const apiKey = localStorage.getItem('dza_key');
            const provider = localStorage.getItem('dza_provider') || 'gemini';
            const loaderId = addLoader();

            try {
                let reply = "";
                
                // --- GEMINI API ---
                if (provider === 'gemini') {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.models.gemini}:generateContent?key=${apiKey}`;
                    
                    const systemPrompt = CONFIG.modes[state.mode].prompt + ` Current Context: Location=${state.city}, Time=${new Date().toLocaleString('fr-DZ')}.`;
                    
                    // Format history for Gemini
                    const history = state.chatHistory.slice(-5).map(msg => ({
                        role: msg.role === 'user' ? 'user' : 'model',
                        parts: [{ text: msg.content }]
                    }));

                    const payload = {
                        contents: [
                            { role: 'user', parts: [{ text: systemPrompt }] }, // Inject system as first user prompt for context
                            ...history,
                            { role: 'user', parts: [{ text: text }] }
                        ]
                    };

                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const data = await response.json();
                    if(data.error) throw new Error(data.error.message);
                    reply = data.candidates[0].content.parts[0].text;

                } 
                // --- OPENAI / GROQ API ---
                else {
                    const systemMsg = {
                        role: "system", 
                        content: `${CONFIG.modes[state.mode].prompt}. Current Context: Location=${state.city}, Time=${new Date().toLocaleString('fr-DZ')}.`
                    };
                    
                    const apiMessages = [systemMsg, ...state.chatHistory.slice(-6), {role: "user", content: text}];
                    const endpoint = provider === 'groq' 
                        ? 'https://api.groq.com/openai/v1/chat/completions' 
                        : 'https://api.openai.com/v1/chat/completions';

                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: CONFIG.models[provider],
                            messages: apiMessages,
                            temperature: 0.7
                        })
                    });

                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message || "API Error");
                    reply = data.choices[0].message.content;
                }

                removeLoader(loaderId);
                addMessage('assistant', reply);
                if (state.voiceEnabled) speak(reply);

            } catch (error) {
                removeLoader(loaderId);
                addMessage('system', `Ø®Ø·Ø£: ${error.message}. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ÙØªØ§Ø­ (API Key)`);
            }
        }

        function addMessage(role, content) {
            if(role !== 'system') {
                state.chatHistory.push({ role, content });
                // Keep history manageable (last 20 msgs)
                if(state.chatHistory.length > 20) state.chatHistory.shift();
                localStorage.setItem('dza_history', JSON.stringify(state.chatHistory));
            }

            const container = document.getElementById('chatContainer');
            const div = document.createElement('div');
            
            if (role === 'system') {
                div.className = 'text-center text-[10px] text-red-400 my-2 px-4';
                div.innerText = content;
            } else {
                div.className = `msg-bubble ${role === 'user' ? 'msg-user' : 'msg-bot'}`;
                if (role === 'assistant') {
                    // Safe markdown rendering
                    div.innerHTML = marked.parse(content);
                    
                    // Process Code Blocks
                    div.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                        const pre = block.parentElement;
                        const lang = block.className.replace('language-', '') || 'code';
                        
                        // Add Header
                        const header = document.createElement('div');
                        header.className = 'code-header';
                        header.innerHTML = `<span>${lang}</span><i class="fa-regular fa-copy cursor-pointer hover:text-white" onclick="copyCode(this)"></i>`;
                        pre.insertBefore(header, block);
                    });
                } else {
                    div.innerText = content;
                }
            }
            container.appendChild(div);
            // Scroll to bottom
            const main = document.getElementById('view-chat');
            main.scrollTo(0, main.scrollHeight);
            div.scrollIntoView({ behavior: "smooth", block: "end" });
        }

        function renderChat() {
            const container = document.getElementById('chatContainer');
            container.innerHTML = '';
            if (state.chatHistory.length === 0) {
                container.innerHTML = `<div class="msg-bubble msg-bot">Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Dza-Genius V12 ğŸ‘‹<br>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ. ÙˆØ§Ø´ Ù†Ù‚Ø¯Ø± Ù†Ø¹Ø§ÙˆÙ†Ùƒ Ø§Ù„ÙŠÙˆÙ…ØŸ</div>`;
                return;
            }
            state.chatHistory.forEach(msg => {
                const div = document.createElement('div');
                div.className = `msg-bubble ${msg.role === 'user' ? 'msg-user' : 'msg-bot'}`;
                if (msg.role === 'assistant') {
                    div.innerHTML = marked.parse(msg.content);
                } else {
                    div.innerText = msg.content;
                }
                container.appendChild(div);
            });
            document.querySelectorAll('pre code').forEach(hljs.highlightElement);
            // Re-add headers to code blocks
             document.querySelectorAll('pre').forEach((pre) => {
                if(!pre.querySelector('.code-header')) {
                    const block = pre.querySelector('code');
                    if(block) {
                         const lang = block.className.replace('language-', '') || 'code';
                         const header = document.createElement('div');
                         header.className = 'code-header';
                         header.innerHTML = `<span>${lang}</span><i class="fa-regular fa-copy cursor-pointer hover:text-white" onclick="copyCode(this)"></i>`;
                         pre.insertBefore(header, block);
                    }
                }
            });
            const main = document.getElementById('view-chat');
            main.scrollTop = main.scrollHeight;
        }

        function addLoader() {
            const id = 'loader-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'msg-bubble msg-bot w-16';
            div.innerHTML = `<div class="flex gap-1 justify-center py-1"><div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div><div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div><div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div></div>`;
            document.getElementById('chatContainer').appendChild(div);
            div.scrollIntoView();
            return id;
        }
        function removeLoader(id) { const el = document.getElementById(id); if(el) el.remove(); }

        // --- Tools & Widgets ---
        function getUserLocation() {
            const label = document.getElementById('headerCity');
            label.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            
            if(!navigator.geolocation) return alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹");

            navigator.geolocation.getCurrentPosition(async (pos) => {
                state.lat = pos.coords.latitude;
                state.lon = pos.coords.longitude;
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${state.lat}&lon=${state.lon}`);
                    const json = await res.json();
                    state.city = json.address.city || json.address.town || json.address.state || "Ù…ÙˆÙ‚Ø¹ÙŠ";
                } catch(e) { state.city = "Ù…ÙˆÙ‚Ø¹ÙŠ"; }

                localStorage.setItem('dza_loc', JSON.stringify({lat: state.lat, lon: state.lon, city: state.city, isAuto: true}));
                document.getElementById('wilayaSelect').value = 'auto';
                updateUI();
                refreshTools();
            }, (err) => {
                label.innerHTML = '<i class="fa-solid fa-triangle-exclamation text-red-400"></i>';
                alert("ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆÙ„Ø§ÙŠØ© ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø£Ø¯ÙˆØ§Øª.");
            });
        }

        async function refreshTools() {
            // Weather
            try {
                const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${state.lat}&longitude=${state.lon}&current_weather=true`);
                const wData = await wRes.json();
                document.getElementById('weatherTemp').innerText = `${Math.round(wData.current_weather.temperature)}Â°`;
                document.getElementById('windSpeed').innerText = wData.current_weather.windspeed;
                const codes = {0:'ØµØ§ÙÙŠ', 1:'ØºØ§Ø¦Ù… Ø¬Ø²Ø¦ÙŠ', 2:'ØºØ§Ø¦Ù…', 3:'ØºØ§Ø¦Ù…', 61:'Ù…Ø·Ø±', 63:'Ù…Ø·Ø±', 80:'Ø²Ø®Ø§Øª', 95:'Ø±Ø¹Ø¯'};
                document.getElementById('weatherDesc').innerText = codes[wData.current_weather.weathercode] || 'Ù…ØªØºÙŠØ±';
            } catch(e) { console.log('Weather Err', e); }

            // Prayer Times
            if (typeof adhan !== 'undefined') {
                const coords = new adhan.Coordinates(state.lat, state.lon);
                const params = adhan.CalculationMethod.MuslimWorldLeague();
                params.madhab = adhan.Madhab.Shafi;
                
                const date = new Date();
                let prayerTimes = new adhan.PrayerTimes(coords, date, params);
                
                // Qibla
                const qibla = adhan.Qibla(coords);
                document.getElementById('qiblaDegree').innerText = Math.round(qibla) + "Â°";
                document.getElementById('qiblaArrow').style.transform = `rotate(${qibla - 180}deg)`;

                const fmt = t => t.toLocaleTimeString('fr-DZ', {hour:'2-digit', minute:'2-digit'});
                const names = {fajr:'Ø§Ù„ØµØ¨Ø­', dhuhr:'Ø§Ù„Ø¸Ù‡Ø±', asr:'Ø§Ù„Ø¹ØµØ±', maghrib:'Ø§Ù„Ù…ØºØ±Ø¨', isha:'Ø§Ù„Ø¹Ø´Ø§Ø¡'};
                
                const pList = document.getElementById('prayerList');
                pList.innerHTML = '';
                
                ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'].forEach(p => {
                    const el = document.createElement('div');
                    el.className = 'flex flex-col bg-slate-800/50 rounded p-1 border border-slate-700/50';
                    el.innerHTML = `<span class="text-[10px] text-gray-400">${names[p]}</span><span class="font-bold font-mono text-xs">${fmt(prayerTimes[p])}</span>`;
                    pList.appendChild(el);
                });

                document.getElementById('hijriDate').innerText = new Intl.DateTimeFormat('ar-TN-u-ca-islamic', {day:'numeric', month:'long', year:'numeric'}).format(date);

                // Next Prayer Logic (Robust)
                let next = prayerTimes.nextPrayer();
                let nextTime = null;

                if(next === 'none') {
                    // It's after Isha, so next is tomorrow's Fajr
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    const pTomorrow = new adhan.PrayerTimes(coords, tomorrow, params);
                    next = 'fajr';
                    nextTime = pTomorrow.fajr;
                } else {
                    nextTime = prayerTimes.timeForPrayer(next);
                }
                state.prayerInstance = { next, nextTime, names };
                updateTimers(); // Immediate update
            }
        }

        function updateTimers() {
            if(state.prayerInstance && state.prayerInstance.nextTime) {
                const now = new Date();
                const diff = state.prayerInstance.nextTime - now;
                
                if (diff > 0) {
                    const h = Math.floor(diff / 3600000);
                    const m = Math.floor((diff % 3600000) / 60000);
                    const s = Math.floor((diff % 60000) / 1000);
                    
                    document.getElementById('nextPrayerName').innerText = state.prayerInstance.names[state.prayerInstance.next];
                    document.getElementById('nextPrayerCounter').innerText = `-${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                } else {
                    refreshTools(); 
                }
            }
        }

        // --- Logic: Currency, CCP, Grade ---
        function updateUI() {
            document.getElementById('headerCity').innerText = state.city;
            document.getElementById('weatherCity').innerText = state.city;
        }

        function calcCurrency() {
            const amount = parseFloat(document.getElementById('currAmount').value);
            const rate = parseFloat(document.getElementById('exchangeRate').value);
            if (!amount || !rate) return;
            const res = amount * rate;
            document.getElementById('currResult').innerText = res.toLocaleString() + " DA";
        }
        
        document.getElementById('currAmount').addEventListener('input', calcCurrency);
        document.getElementById('exchangeRate').addEventListener('input', calcCurrency);
        document.getElementById('currType').addEventListener('change', calcCurrency);

        function toggleTool(id) { 
            const el = document.getElementById(id);
            el.classList.toggle('hidden');
        }
        
        function calcKey() {
            const num = document.getElementById('ccpInput').value;
            if(num) {
                const key = 97n - ((BigInt(num) * 100n) % 97n);
                document.getElementById('ccpRes').innerText = `Ø§Ù„Ù…ÙØªØ§Ø­: ${key.toString().padStart(2, '0')}`;
            }
        }

        // Grade Calculator Logic
        function addSubject() {
            const container = document.getElementById('gradeInputs');
            const div = document.createElement('div');
            div.className = "flex gap-2";
            div.innerHTML = `
                <input type="number" placeholder="Ø§Ù„Ø¹Ù„Ø§Ù…Ø© /20" class="grade-mark w-2/3 bg-slate-900 border border-slate-700 rounded p-2 text-xs text-white outline-none">
                <input type="number" placeholder="Ø§Ù„Ù…Ø¹Ø§Ù…Ù„" value="1" class="grade-coef w-1/3 bg-slate-900 border border-slate-700 rounded p-2 text-xs text-center text-white outline-none">
            `;
            container.appendChild(div);
        }

        function resetGrade() {
            document.getElementById('gradeInputs').innerHTML = '';
            document.getElementById('gradeRes').innerText = '';
            addSubject();
        }

        function calcGrade() {
            const marks = document.querySelectorAll('.grade-mark');
            const coefs = document.querySelectorAll('.grade-coef');
            let totalScore = 0;
            let totalCoef = 0;

            marks.forEach((markInput, index) => {
                const m = parseFloat(markInput.value);
                const c = parseFloat(coefs[index].value);
                if(!isNaN(m) && !isNaN(c)) {
                    totalScore += (m * c);
                    totalCoef += c;
                }
            });

            if(totalCoef > 0) {
                const avg = totalScore / totalCoef;
                const el = document.getElementById('gradeRes');
                el.innerText = avg.toFixed(2);
                if(avg >= 10) el.className = "text-center font-bold text-2xl mt-3 text-green-400";
                else el.className = "text-center font-bold text-2xl mt-3 text-red-400";
            }
        }

        // --- Audio & TTS ---
        function toggleSound() {
            state.voiceEnabled = !state.voiceEnabled;
            const btn = document.getElementById('soundBtn');
            if(state.voiceEnabled) {
                btn.classList.add('text-green-400', 'border-green-500/50');
                btn.innerHTML = '<i class="fa-solid fa-volume-high text-xs"></i>';
            } else {
                btn.classList.remove('text-green-400', 'border-green-500/50');
                btn.innerHTML = '<i class="fa-solid fa-volume-xmark text-xs"></i>';
                window.speechSynthesis.cancel();
            }
        }

        function speak(text) {
            if(!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            // Remove code blocks and Markdown for speech
            const cleanText = text.replace(/```[\s\S]*?```/g, 'ÙƒÙˆØ¯ Ø¨Ø±Ù…Ø¬ÙŠ').replace(/[*#_`]/g, '');
            
            const utter = new SpeechSynthesisUtterance(cleanText);
            const voices = window.speechSynthesis.getVoices();
            // Try to find Arabic voice
            const arVoice = voices.find(v => v.lang.includes('ar'));
            if(arVoice) utter.voice = arVoice;
            utter.rate = 1.1;
            window.speechSynthesis.speak(utter);
        }

        function toggleVoice() {
            const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!Recognition) return alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØµÙˆØªÙŠ");
            
            const rec = new Recognition();
            rec.lang = 'ar-DZ'; // Try Algerian Arabic
            rec.start();
            
            const btn = document.getElementById('micBtn');
            btn.classList.add('text-red-500', 'animate-pulse');
            
            rec.onresult = (event) => {
                document.getElementById('msgInput').value += " " + event.results[0][0].transcript;
                btn.classList.remove('text-red-500', 'animate-pulse');
                document.getElementById('msgInput').style.height = 'auto';
            };
            
            rec.onerror = () => btn.classList.remove('text-red-500', 'animate-pulse');
            rec.onend = () => btn.classList.remove('text-red-500', 'animate-pulse');
        }

        // --- Utility ---
        function nav(pageId, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('view-'+pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if(btn) btn.classList.add('active');
        }

        function finishOnboarding() {
            const k = document.getElementById('welcomeKey').value.trim();
            const p = document.getElementById('welcomeProvider').value;
            if(k) {
                localStorage.setItem('dza_key', k);
                localStorage.setItem('dza_provider', p);
                document.getElementById('welcomeModal').classList.add('hidden');
                loadState();
                setTimeout(refreshTools, 500);
            } else alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙØªØ§Ø­");
        }

        function saveConfig() {
            const k = document.getElementById('settingKey').value.trim();
            if(k) localStorage.setItem('dza_key', k);
            localStorage.setItem('dza_provider', document.getElementById('settingProvider').value);
            alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…");
            location.reload(); // Reload to apply changes cleanly
        }

        function toggleKeyVis() {
            const inp = document.getElementById('settingKey');
            inp.type = inp.type === 'password' ? 'text' : 'password';
        }

        function updateKeyLink() {
            const p = document.getElementById('settingProvider').value;
            const l = document.getElementById('settingLink');
            if(p === 'gemini') l.innerHTML = '<a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-400 text-[10px] hover:underline">Ø±Ø§Ø¨Ø· Ù…ÙØªØ§Ø­ Gemini</a>';
            else if(p === 'groq') l.innerHTML = '<a href="https://console.groq.com/keys" target="_blank" class="text-blue-400 text-[10px] hover:underline">Ø±Ø§Ø¨Ø· Ù…ÙØªØ§Ø­ Groq</a>';
            else l.innerHTML = '<a href="https://platform.openai.com/api-keys" target="_blank" class="text-blue-400 text-[10px] hover:underline">Ø±Ø§Ø¨Ø· Ù…ÙØªØ§Ø­ OpenAI</a>';
        }

        function setMode(mode, btn) {
            state.mode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => {
                b.classList.remove('active', 'border-green-500', 'text-green-400');
                b.classList.add('text-gray-400');
            });
            btn.classList.add('active', 'border-green-500', 'text-green-400');
            btn.classList.remove('text-gray-400');
            state.chatHistory = []; 
            renderChat();
            addMessage('system', `ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ø®ØµÙŠØ© Ø¥Ù„Ù‰: ${CONFIG.modes[mode].name}`);
        }

        function clearChat() { if(confirm("Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ")) { state.chatHistory = []; localStorage.removeItem('dza_history'); renderChat(); } }
        function fullReset() { if(confirm("Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) { localStorage.clear(); location.reload(); } }
        function exportChatPDF() { const el = document.getElementById('chatContainer'); html2pdf().set({ margin: 10, filename: 'Dza-Chat.pdf', backgroundColor: '#1e293b' }).from(el).save(); }
        function setInput(txt) { document.getElementById('msgInput').value = txt; sendMessage(); }
        function copyCode(icon) {
            const code = icon.parentElement.nextElementSibling.innerText;
            navigator.clipboard.writeText(code);
            icon.classList.remove('fa-copy'); icon.classList.add('fa-check', 'text-green-500');
            setTimeout(() => { icon.classList.remove('fa-check', 'text-green-500'); icon.classList.add('fa-copy'); }, 2000);
        }
    </script>
</body>
</html>
