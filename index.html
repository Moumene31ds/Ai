<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <title>Dza-Genius V15 (Ultimate)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&family=Fira+Code:wght@400&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/adhan/4.4.4/Adhan.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <style>
        :root { --primary: #10b981; --bg-dark: #0f172a; --safe-top: env(safe-area-inset-top, 20px); --safe-bottom: env(safe-area-inset-bottom, 20px); }
        body { font-family: 'Cairo', sans-serif; background: var(--bg-dark); color: #f8fafc; height: 100dvh; overflow: hidden; background-image: radial-gradient(#1e293b 1px, transparent 1px); background-size: 24px 24px; }
        .app-layout { display: flex; flex-direction: column; height: 100%; padding-top: var(--safe-top); padding-bottom: calc(75px + var(--safe-bottom)); }
        
        .page { display: none; height: 100%; overflow-y: auto; padding: 16px; scroll-behavior: smooth; padding-bottom: 120px; }
        .page.active { display: block; animation: fadeUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        
        /* Chat Styling */
        .msg-bubble { max-width: 90%; padding: 12px 16px; margin-bottom: 12px; border-radius: 18px; position: relative; font-size: 15px; line-height: 1.6; box-shadow: 0 2px 5px rgba(0,0,0,0.1); word-wrap: break-word; }
        .msg-bot { background: #1e293b; color: #e2e8f0; border: 1px solid #334155; border-bottom-left-radius: 4px; }
        .msg-user { background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; margin-right: auto; border-bottom-right-radius: 4px; }
        .msg-vip { background: linear-gradient(135deg, #2a2008 0%, #422006 100%); border: 1px solid #f59e0b; box-shadow: 0 0 15px rgba(245, 158, 11, 0.15); }

        /* Code Blocks */
        pre { background: #111827 !important; padding: 0 !important; border-radius: 8px !important; overflow: hidden; margin: 10px 0; border: 1px solid #374151; direction: ltr; position: relative; }
        pre code { font-family: 'Fira Code', monospace; font-size: 13px; display: block; padding: 12px; overflow-x: auto; }
        .copy-btn { position: absolute; top: 5px; right: 5px; background: rgba(255,255,255,0.1); border: none; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; transition: 0.2s; }
        .copy-btn:hover { background: rgba(255,255,255,0.2); }

        /* Components */
        .glass-card { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.08); border-radius: 20px; padding: 16px; margin-bottom: 14px; position: relative; overflow: hidden; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: calc(70px + var(--safe-bottom)); background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-around; padding-top: 10px; z-index: 50; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #64748b; width: 20%; transition: 0.3s; cursor: pointer; }
        .nav-item.active { color: var(--primary); transform: translateY(-4px); font-weight: bold; }
        
        /* Premium UI Styles */
        .premium-bg { background: linear-gradient(180deg, #0f172a 0%, #171002 100%); }
        .card-pro { background: linear-gradient(145deg, rgba(234, 179, 8, 0.1) 0%, rgba(0,0,0,0) 100%); border: 1px solid rgba(234, 179, 8, 0.3); transition: transform 0.3s ease; }
        .card-pro:active { transform: scale(0.98); }
        .card-ultimate { background: linear-gradient(145deg, rgba(168, 85, 247, 0.15) 0%, rgba(0,0,0,0) 100%); border: 1px solid rgba(168, 85, 247, 0.4); position: relative; box-shadow: 0 0 20px rgba(168, 85, 247, 0.1); }
        .shimmer-text { background: linear-gradient(90deg, #fff, #fbbf24, #fff); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: shine 3s linear infinite; }
        
        /* Animations */
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shine { to { background-position: 200% center; } }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        .vip-glow { animation: goldPulse 3s infinite; }
        @keyframes goldPulse { 0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(234, 179, 8, 0); } 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); } }
        .floating { animation: float 6s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
    </style>
</head>
<body>

    <div id="paymentModal" class="fixed inset-0 bg-black/90 z-[70] hidden flex items-end sm:items-center justify-center backdrop-blur-md animate-fadeUp">
        <div class="bg-slate-900 w-full max-w-md rounded-t-[30px] sm:rounded-[24px] border border-slate-700 p-6 relative shadow-2xl overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-yellow-500 to-transparent"></div>
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-yellow-500/10 rounded-full blur-3xl"></div>

            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    <i class="fa-regular fa-credit-card text-yellow-500"></i> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹
                </h3>
                <button onclick="togglePaymentModal(false)" class="w-8 h-8 rounded-full bg-slate-800 text-gray-400 flex items-center justify-center hover:bg-slate-700"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div id="paymentInfo" class="space-y-4">
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-4 rounded-2xl border border-slate-700/50 group cursor-pointer relative overflow-hidden" onclick="copyToClipboard('000000000000')">
                    <div class="absolute inset-0 bg-yellow-500/5 opacity-0 group-hover:opacity-100 transition"></div>
                    <div class="flex justify-between items-start mb-2">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/Alg%C3%A9rie_Poste.svg/1200px-Alg%C3%A9rie_Poste.svg.png" class="h-6 opacity-90">
                        <span class="text-[10px] bg-yellow-500/10 text-yellow-500 px-2 py-0.5 rounded border border-yellow-500/20">CCP</span>
                    </div>
                    <p class="text-[10px] text-gray-400">Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ø±ÙŠØ¯ÙŠ</p>
                    <div class="flex items-center gap-2">
                        <p class="text-xl font-mono font-bold text-white tracking-widest mt-1">00000000 00</p>
                        <i class="fa-regular fa-copy text-gray-500 text-xs"></i>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Ø§Ù„Ø§Ø³Ù…: <span class="text-gray-300 font-bold">Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡</span></p>
                </div>

                <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-4 rounded-2xl border border-slate-700/50 group cursor-pointer relative overflow-hidden" onclick="copyToClipboard('00799999000000000000')">
                    <div class="absolute inset-0 bg-blue-500/5 opacity-0 group-hover:opacity-100 transition"></div>
                    <div class="flex justify-between items-start mb-2">
                        <div class="font-bold text-blue-400 italic">Baridi<span class="text-white">Mob</span></div>
                        <span class="text-[10px] bg-blue-500/10 text-blue-400 px-2 py-0.5 rounded border border-blue-500/20">RIP</span>
                    </div>
                    <p class="text-[10px] text-gray-400">Ø§Ù„ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¨Ø±ÙŠØ¯ÙŠ (RIP)</p>
                    <div class="flex items-center gap-2">
                        <p class="text-sm font-mono font-bold text-white tracking-widest mt-1">007 99999 0000000000 00</p>
                        <i class="fa-regular fa-copy text-gray-500 text-xs"></i>
                    </div>
                </div>
            </div>
            
            <div id="uploadSection" class="mt-6">
                <input type="file" id="receiptFile" class="hidden" accept="image/*" onchange="uploadReceipt(this)">
                
                <button id="uploadBtn" onclick="document.getElementById('receiptFile').click()" class="w-full bg-gradient-to-r from-blue-600 to-blue-500 text-white py-3 rounded-xl font-bold text-sm shadow-lg shadow-blue-900/40 hover:scale-[1.02] transition flex items-center justify-center gap-2">
                    <span id="uploadBtnText" class="flex items-center gap-2"><i class="fa-brands fa-telegram text-lg"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙˆØµÙ„ Ù„Ù„ØªÙØ¹ÙŠÙ„</span>
                </button>
                <p class="text-[10px] text-center text-gray-500 mt-3">Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù…Ø¬Ø±Ø¯ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ÙˆØµÙ„</p>
            </div>

            <div id="successMsg" class="hidden mt-6 text-center">
                <div class="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fa-solid fa-check text-2xl text-green-500"></i>
                </div>
                <h3 class="text-white font-bold mb-1">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙˆØµÙ„!</h3>
                <p class="text-xs text-gray-400">Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¢Ù†.</p>
            </div>
        </div>
    </div>

    <div class="app-layout">
        <header class="flex justify-between items-center px-4 py-3 bg-slate-900/90 backdrop-blur sticky top-0 z-40 border-b border-slate-800/60 shadow-md">
            <div class="flex items-center gap-3">
                <div class="relative cursor-pointer group" onclick="nav('settings', document.querySelector('.nav-item:nth-child(3)'))">
                    <div id="headerAvatar" class="w-9 h-9 rounded-lg bg-gradient-to-br from-green-500 to-teal-700 flex items-center justify-center text-white font-bold text-xs shadow-lg overflow-hidden border border-slate-700 group-hover:border-green-400 transition">
                        <span>DZ</span>
                    </div>
                    <div id="headerVipBadge" class="hidden absolute -bottom-1 -right-1 bg-gradient-to-r from-yellow-400 to-yellow-600 text-black text-[8px] font-bold px-1.5 rounded-full border border-slate-900 shadow-md z-10">PRO</div>
                </div>
                <div>
                    <h1 class="font-bold text-sm text-white tracking-wide flex items-center gap-2">
                        Dza-Genius 
                        <span id="versionBadge" onclick="nav('premium')" class="cursor-pointer text-[9px] bg-slate-800 text-slate-400 px-1.5 py-0.5 rounded border border-slate-700 transition">
                            V15 FREE
                        </span>
                    </h1>
                    <div class="text-[10px] text-gray-400 flex items-center gap-1 cursor-pointer" onclick="getUserLocation()">
                        <i class="fa-solid fa-location-dot text-green-500"></i> <span id="headerCity">Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±</span>
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="nav('premium')" class="w-8 h-8 rounded-full bg-gradient-to-br from-yellow-500/20 to-transparent border border-yellow-500/30 text-yellow-400 flex items-center justify-center hover:bg-yellow-500/30 transition animate-pulse">
                    <i class="fa-solid fa-gem text-xs"></i>
                </button>
            </div>
        </header>

        <main id="view-chat" class="page active">
            <div id="chatContainer" class="min-h-[60vh] flex flex-col justify-end"></div>
            
            <div class="fixed bottom-[calc(70px+var(--safe-bottom))] left-0 right-0 px-3 py-2 z-40 bg-gradient-to-t from-slate-900 via-slate-900/95 to-transparent">
                <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide mb-1 px-1" id="quickSuggestions">
                    <button onclick="setInput('Ø§Ø±Ø³Ù… Ù„ÙŠ Ø´Ø¹Ø§Ø± ÙØ±ÙŠÙ‚ ÙƒØ±Ø© Ù‚Ø¯Ù…')" class="whitespace-nowrap bg-purple-900/40 border border-purple-500/30 text-[10px] text-purple-300 px-3 py-1.5 rounded-full hover:bg-purple-800">ğŸ¨ Ø±Ø³Ù…</button>
                    <button onclick="setInput('Ø³Ø¹Ø± Ø§Ù„Ø£ÙˆØ±Ùˆ Ø§Ù„ÙŠÙˆÙ… ÙÙŠ Ø§Ù„Ø³ÙƒÙˆØ§Ø±')" class="whitespace-nowrap bg-slate-800/80 border border-slate-700 text-[10px] text-gray-300 px-3 py-1.5 rounded-full hover:bg-slate-700">ğŸ’¶ Ø§Ù„Ø³ÙƒÙˆØ§Ø±</button>
                    <button onclick="setInput('ÙˆØµÙØ© ØºØ±Ø§ØªØ§Ù† Ø¨Ø·Ø§Ø·Ø§')" class="whitespace-nowrap bg-slate-800/80 border border-slate-700 text-[10px] text-gray-300 px-3 py-1.5 rounded-full hover:bg-slate-700">ğŸ³ Ø·Ø¨Ø®</button>
                </div>

                <div class="max-w-3xl mx-auto flex items-end gap-2 bg-slate-800/90 backdrop-blur p-1.5 rounded-[24px] border border-slate-700 shadow-2xl">
                    <div class="flex-1 relative">
                        <textarea id="msgInput" rows="1" placeholder="Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø­Ø§Ø¬Ø©..." class="w-full bg-transparent text-white text-sm py-3 px-3 focus:outline-none resize-none max-h-32 placeholder-slate-500 dir-rtl" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
                    </div>
                    <button onclick="sendMessage()" id="sendBtn" class="w-10 h-10 rounded-full bg-gradient-to-r from-green-600 to-green-500 text-white shadow-lg shadow-green-900/30 transition transform active:scale-90 flex-shrink-0 flex items-center justify-center">
                        <i class="fa-solid fa-paper-plane text-sm"></i>
                    </button>
                </div>
            </div>
        </main>

        <main id="view-tools" class="page">
            <div class="glass-card bg-gradient-to-br from-blue-900/20 to-slate-900 border-l-4 border-blue-500">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-[10px] text-blue-300 font-bold uppercase mb-1">Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-cloud-sun text-2xl text-yellow-400"></i>
                            <span id="weatherTemp" class="text-3xl font-black text-white">--Â°</span>
                        </div>
                    </div>
                    <div class="text-left">
                        <div id="weatherCity" class="text-sm font-bold text-white">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...</div>
                        <div class="text-[10px] text-gray-400 mt-1"><i class="fa-solid fa-wind"></i> <span id="windSpeed">--</span> km/h</div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="glass-card mb-0 p-3 bg-slate-800/50 border-green-500/20">
                    <div class="text-[10px] text-green-400 mb-1 font-bold">Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</div>
                    <div id="nextPrayerName" class="text-sm text-gray-300">--</div>
                    <div id="nextPrayerCounter" class="text-xl font-mono font-bold text-white mt-1 tracking-wider">--:--</div>
                </div>
                <div class="glass-card mb-0 p-3 bg-slate-800/50 border-indigo-500/20 text-center">
                    <div class="text-[10px] text-indigo-400 mb-1 font-bold">Ø§Ù„Ù‚Ø¨Ù„Ø©</div>
                    <div class="relative w-10 h-10 mx-auto mt-1 border-2 border-indigo-500/30 rounded-full flex items-center justify-center bg-slate-900">
                        <i id="qiblaArrow" class="fa-solid fa-location-arrow text-sm text-white transition-all duration-1000"></i>
                    </div>
                </div>
            </div>
            <div class="glass-card border-yellow-500/30">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xs font-bold text-yellow-500"><i class="fa-solid fa-money-bill-transfer"></i> Ø§Ù„Ø³ÙƒÙˆØ§Ø± (Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…ÙˆØ§Ø²ÙŠ)</h3>
                    <button onclick="editRate()" class="text-[10px] text-gray-500 bg-slate-800 px-2 py-1 rounded border border-slate-700">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµØ±Ù</button>
                </div>
                <div class="flex gap-2 items-center mb-2">
                    <div class="relative w-1/3">
                        <input type="number" id="currAmount" value="100" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-center text-sm font-bold text-white focus:border-yellow-500 outline-none">
                    </div>
                    <select id="currType" class="bg-slate-800 border border-slate-600 rounded p-2 text-xs text-white outline-none">
                        <option value="eur">â‚¬ EUR</option>
                        <option value="usd">$ USD</option>
                    </select>
                    <i class="fa-solid fa-arrow-left text-gray-500 text-xs"></i>
                    <div id="currResult" class="flex-1 text-left font-mono font-bold text-green-400 text-lg">-- DA</div>
                </div>
                <div id="rateDisplay" class="text-[9px] text-right text-gray-500 mt-1">Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù: 1â‚¬ = <span id="currentRate">250</span> DA</div>
            </div>
             <div class="glass-card mt-3 bg-slate-800/40 border-slate-700">
                <h3 class="text-xs font-bold text-blue-400 mb-2 flex items-center gap-2"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/Alg%C3%A9rie_Poste.svg/1200px-Alg%C3%A9rie_Poste.svg.png" class="h-3 opacity-80"> Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯</h3>
                
                <div class="flex gap-2 mb-3">
                    <input type="number" id="ccpInput" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø¨Ø¯ÙˆÙ† Ù…ÙØªØ§Ø­)" class="w-2/3 bg-slate-900 p-2 rounded border border-slate-600 text-center text-sm text-white outline-none focus:border-blue-500">
                    <button onclick="calcKey()" class="w-1/3 bg-blue-600 hover:bg-blue-500 text-white rounded text-xs font-bold">Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…ÙØªØ§Ø­</button>
                </div>
                <div id="ccpRes" class="text-center font-bold text-lg text-white min-h-[20px] mb-3"></div>
            </div>
        </main>

        <main id="view-premium" class="page premium-bg">
            <div class="text-center pt-4 pb-6 relative">
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-48 h-48 bg-yellow-500/20 rounded-full blur-[60px] -z-10"></div>
                <h2 class="text-2xl font-black text-white mb-1 tracking-tight">ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø³ØªÙˆÙ‰ <i class="fa-solid fa-rocket text-yellow-500"></i></h2>
                <p class="text-xs text-gray-400 max-w-[250px] mx-auto">Ø§ÙƒØªØ´Ù Ø§Ù„Ù‚Ø¯Ø±Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…Ø¹ Dza-Genius Ultimate</p>
            </div>
            
            <div id="userStatusContainer" class="hidden glass-card border-orange-500 mb-4 bg-orange-900/10">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-hourglass-half text-2xl text-orange-500 animate-pulse"></i>
                    <div>
                        <div class="font-bold text-white">Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</div>
                        <div class="text-[10px] text-gray-400">ÙˆØµÙ„ Ø§Ù„Ø¯ÙØ¹ Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ØŒ Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹.</div>
                    </div>
                </div>
            </div>

            <div class="glass-card card-pro mb-6 relative overflow-hidden">
                <div class="absolute -right-6 top-3 bg-yellow-500 text-black text-[9px] font-bold px-8 py-1 rotate-45 shadow-sm">Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ø§Ù‹</div>
                <div class="flex flex-col items-center mb-4">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-yellow-400 to-yellow-600 flex items-center justify-center text-xl shadow-lg shadow-yellow-500/30 mb-2 text-slate-900 floating">
                        <i class="fa-solid fa-crown"></i>
                    </div>
                    <div class="text-lg font-black text-white shimmer-text">Dza-Genius PRO</div>
                    <div class="flex items-baseline gap-1 mt-1">
                        <span class="text-2xl font-bold text-white font-mono">500</span>
                        <span class="text-xs text-yellow-500 font-bold">DA / Ø´Ù‡Ø±</span>
                    </div>
                </div>
                
                <div class="space-y-3 mb-6 px-2">
                    <div class="flex items-center gap-3">
                        <div class="w-6 h-6 rounded bg-yellow-500/10 flex items-center justify-center"><i class="fa-solid fa-bolt text-yellow-400 text-xs"></i></div>
                        <div class="text-xs text-gray-200">Ø°ÙƒØ§Ø¡ GPT-4o Ø³Ø±ÙŠØ¹ Ø¬Ø¯Ø§Ù‹</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-6 h-6 rounded bg-purple-500/10 flex items-center justify-center"><i class="fa-solid fa-image text-purple-400 text-xs"></i></div>
                        <div class="text-xs text-gray-200">Ø±Ø³Ù… ØµÙˆØ± HD (ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯)</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-6 h-6 rounded bg-green-500/10 flex items-center justify-center"><i class="fa-solid fa-microphone text-green-400 text-xs"></i></div>
                        <div class="text-xs text-gray-200">ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„ØµÙˆØªÙŠØ©</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-6 h-6 rounded bg-blue-500/10 flex items-center justify-center"><i class="fa-solid fa-ban text-blue-400 text-xs"></i></div>
                        <div class="text-xs text-gray-200">Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</div>
                    </div>
                </div>

                <button id="upgradeBtn" onclick="togglePaymentModal(true)" class="w-full py-3 rounded-xl bg-gradient-to-r from-yellow-500 to-yellow-600 text-slate-900 font-bold text-sm shadow-lg shadow-yellow-500/20 hover:shadow-yellow-500/40 transition-all active:scale-95 flex items-center justify-center gap-2">
                    ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø¢Ù† <i class="fa-solid fa-arrow-left"></i>
                </button>
            </div>
        </main>

        <main id="view-settings" class="page">
            <h2 class="text-lg font-bold mb-4 px-1 text-gray-300">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>

            <div class="glass-card mb-4 relative overflow-hidden">
                <div id="loginBtnSection">
                    <div class="flex flex-col items-center py-4">
                        <div class="w-16 h-16 bg-slate-700 rounded-full flex items-center justify-center mb-3 text-2xl">ğŸ‘¤</div>
                        <p class="text-xs text-gray-400 mb-4 text-center">Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø­ÙØ¸ Ù…Ø­Ø§Ø¯Ø«Ø§ØªÙƒ ÙˆØ§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠØ²Ø§Øª.</p>
                        <button onclick="loginWithGoogle()" class="bg-white text-slate-900 font-bold py-2 px-6 rounded-full flex items-center gap-2 hover:bg-gray-200 transition text-sm">
                            <i class="fa-brands fa-google text-red-500"></i> Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Ø¬ÙˆØ¬Ù„
                        </button>
                    </div>
                </div>
                <div id="userInfoSection" class="hidden flex-col gap-3">
                    <div class="flex items-center gap-3">
                        <img id="userImgDisplay" src="" class="w-12 h-12 rounded-full border-2 border-slate-600">
                        <div>
                            <div class="flex items-center gap-2">
                                <span id="userNameDisplay" class="font-bold text-white">---</span>
                                <span id="proBadgeCard" class="hidden text-[10px] bg-yellow-500 text-black px-1.5 rounded font-bold">PRO</span>
                            </div>
                            <div id="emailDisplay" class="text-[10px] text-gray-500">...</div>
                        </div>
                    </div>
                    <button onclick="logoutApp()" class="mt-2 w-full border border-red-500/30 text-red-400 py-2 rounded-lg text-xs hover:bg-red-900/10 transition">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
            
            <div class="glass-card">
                <label class="text-xs text-gray-400 font-bold mb-3 block">Ø´Ø®ØµÙŠØ© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯</label>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="setMode('darja', this)" class="mode-btn active bg-slate-800 p-3 rounded-xl text-xs border border-green-500 text-green-400 transition flex items-center justify-center gap-2"><span class="text-lg">ğŸ‡©ğŸ‡¿</span> Ø§Ù„Ø¯Ø§Ø±Ø¬Ø©</button>
                    <button onclick="setMode('admin', this)" class="mode-btn bg-slate-800 p-3 rounded-xl text-xs text-gray-400 border border-transparent transition flex items-center justify-center gap-2"><span class="text-lg">âš–ï¸</span> Ø¥Ø¯Ø§Ø±ÙŠ</button>
                    <button onclick="setMode('tech', this)" class="mode-btn bg-slate-800 p-3 rounded-xl text-xs text-gray-400 border border-transparent transition flex items-center justify-center gap-2"><span class="text-lg">ğŸ’»</span> Ù…Ø¨Ø±Ù…Ø¬</button>
                    <button onclick="setMode('chef', this)" class="mode-btn bg-slate-800 p-3 rounded-xl text-xs text-gray-400 border border-transparent transition flex items-center justify-center gap-2"><span class="text-lg">ğŸ³</span> Ø´Ø§Ù</button>
                </div>
            </div>
            
            <div class="mt-8">
                <button onclick="fullReset()" class="w-full py-3 text-red-400 text-xs border border-red-900/50 rounded-xl bg-red-900/10 hover:bg-red-900/20 transition font-bold">
                    <i class="fa-solid fa-triangle-exclamation"></i> Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·
                </button>
            </div>
            
            <p class="text-[10px] text-gray-600 text-center mt-6 font-mono">Dza-Genius V15 by You</p>
        </main>

        <nav class="bottom-nav">
            <div class="nav-item active" onclick="nav('chat', this)"><i class="fa-solid fa-comment-dots text-lg mb-1"></i><span>Ø´Ø§Øª</span></div>
            <div class="nav-item" onclick="nav('tools', this)"><i class="fa-solid fa-toolbox text-lg mb-1"></i><span>Ø£Ø¯ÙˆØ§Øª</span></div>
            <div class="nav-item" onclick="nav('settings', this)"><i class="fa-solid fa-sliders text-lg mb-1"></i><span>Ø­Ø³Ø§Ø¨ÙŠ</span></div>
        </nav>
    </div>

    <script>
        // --- 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ---
        // (Ù†ÙØ³ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù…Ù„Ù Ø§Ù„Ø£Ø¯Ù…Ù† - ØªØ£ÙƒØ¯ Ù…Ù† ØªØ·Ø§Ø¨Ù‚Ù‡Ø§)
        const firebaseConfig = {
          apiKey: "AIzaSyBMPbJoYquYUf055uuzMt2IgdLDMJvvKPs",
          authDomain: "aidz-5f3c4.firebaseapp.com",
          projectId: "aidz-5f3c4",
          storageBucket: "aidz-5f3c4.firebasestorage.app",
          messagingSenderId: "921793664900",
          appId: "1:921793664900:web:81325e6ddc16bf8561efd1"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // --- 2. Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ---
        let user = { loggedIn: false, isPro: false, receiptStatus: null, data: null };
        let settings = { 
            lat: 36.75, lon: 3.05, city: "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±", 
            mode: 'darja', 
            voice: false,
            currencyRate: 250 
        };
        let chatHistory = [];
        
        // --- 3. Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„ ---
        window.onload = () => {
            loadSettings();
            renderChat();
            updateUI();
            getUserLocation();
            setInterval(updatePrayerCountdown, 1000);
        };

        function loadSettings() {
            const saved = localStorage.getItem('dza_settings');
            if(saved) settings = {...settings, ...JSON.parse(saved)};
            const hist = localStorage.getItem('dza_history');
            if(hist) chatHistory = JSON.parse(hist);
            const rateEl = document.getElementById('currentRate');
            if(rateEl) rateEl.innerText = settings.currencyRate;
        }

        function saveLocal() {
            localStorage.setItem('dza_settings', JSON.stringify(settings));
        }

        // --- 4. Premium & Payment Logic (UPDATED) ---
        function togglePaymentModal(show) {
            const modal = document.getElementById('paymentModal');
            if(show) {
                if(!user.loggedIn) { alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©."); nav('settings'); return; }
                modal.classList.remove('hidden');
                document.getElementById('paymentInfo').style.display = 'block';
                document.getElementById('uploadSection').style.display = 'block';
                document.getElementById('successMsg').classList.add('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        async function uploadReceipt(input) {
            const file = input.files[0];
            if (!file) return;

            if (!user.loggedIn) {
                alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
                return;
            }

            const btnText = document.getElementById('uploadBtnText');
            const btn = document.getElementById('uploadBtn');
            const originalText = btnText.innerHTML;

            // ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø± Ù„Ù„ØªØ­Ù…ÙŠÙ„
            btn.disabled = true;
            btnText.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...';

            try {
                // 1. Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
                const storageRef = storage.ref();
                const fileRef = storageRef.child(`receipts/${auth.currentUser.uid}/${Date.now()}_${file.name}`);
                const snapshot = await fileRef.put(file);
                const url = await snapshot.ref.getDownloadURL();

                // 2. ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                await db.collection('users').doc(auth.currentUser.uid).update({
                    receiptUrl: url,
                    receiptStatus: 'pending', // Ø­Ø§Ù„Ø© Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                    uploadDate: firebase.firestore.FieldValue.serverTimestamp()
                });

                // 3. Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
                document.getElementById('paymentInfo').style.display = 'none';
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('successMsg').classList.remove('hidden');

            } catch (error) {
                console.error(error);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹: " + error.message);
                btn.disabled = false;
                btnText.innerHTML = originalText;
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
            alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù…: " + text);
        }

        // --- 5. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø´Ø§Øª ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ---
        const MODES = {
            darja: { prompt: "You are Dza-Genius, an Algerian AI assistant. Speak Algerian Darja (Arabic mixed with French). Be helpful, witty, and concise." },
            admin: { prompt: "Act as an expert in Algerian Bureaucracy. Write formal requests in Arabic." },
            tech: { prompt: "You are a Senior Software Engineer. Provide clean code and explanations." },
            chef: { prompt: "Ø£Ù†Øª Ø·Ø¨Ø§Ø® Ø¬Ø²Ø§Ø¦Ø±ÙŠ Ù…Ø­ØªØ±Ù. Ø£Ø¹Ø· ÙˆØµÙØ§Øª Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù„Ø£Ø·Ø¨Ø§Ù‚ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±ÙŠØ© ÙˆØ§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©." }
        };

        async function sendMessage() {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            if (!text) return;

            input.value = '';
            input.style.height = 'auto';
            addMessage('user', text);

            if (text.startsWith("Ø§Ø±Ø³Ù…") || text.toLowerCase().startsWith("draw")) {
                // Ù…ÙŠØ²Ø© Ø§Ù„Ø±Ø³Ù… (Ù„Ù„Ø¬Ù…ÙŠØ¹ ÙˆÙ„ÙƒÙ† Ø£Ø³Ø±Ø¹ Ù„Ù„Ù€ Pro ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„)
                const prompt = text.replace(/Ø§Ø±Ø³Ù…|Ù„ÙŠ|draw/gi, "").trim();
                const id = addLoader();
                const imgUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?nologo=true&width=1024&height=1024&model=flux`;
                const img = new Image();
                img.onload = () => {
                    removeLoader(id);
                    addMessage('assistant', `<div class="font-bold mb-2 text-xs text-gray-400">ğŸ¨ ØªÙ… Ø§Ù„Ø±Ø³Ù…:</div><img src="${imgUrl}" class="w-full rounded-xl border border-slate-600 shadow-lg" onclick="window.open(this.src)">`);
                };
                img.src = imgUrl;
                return;
            }

            const id = addLoader();
            try {
                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©
                const model = user.isPro ? 'openai' : 'openai'; // ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ù‡Ù†Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹
                const systemP = MODES[settings.mode].prompt + ` [Context: City=${settings.city}, User=${user.data?.displayName || 'Guest'}]`;
                const url = `https://text.pollinations.ai/${encodeURIComponent(systemP + "\nUser: " + text)}?model=${model}`;
                
                const res = await fetch(url);
                const reply = await res.text();
                removeLoader(id);
                typeMessage(reply);
            } catch (e) {
                removeLoader(id);
                addMessage('system', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.');
            }
        }

        function typeMessage(text) {
            chatHistory.push({ role: 'assistant', content: text });
            if(chatHistory.length > 20) chatHistory.shift();
            localStorage.setItem('dza_history', JSON.stringify(chatHistory));

            const container = document.getElementById('chatContainer');
            const div = document.createElement('div');
            let bubbleClass = `msg-bubble msg-bot`;
            if (user.isPro) bubbleClass += ' msg-vip';
            div.className = bubbleClass;
            container.appendChild(div);

            let i = 0;
            const speed = 10; 
            function type() {
                if (i < text.length) {
                    div.innerHTML = marked.parse(text.substring(0, i+1));
                    i += Math.floor(Math.random() * 5) + 1;
                    document.getElementById('view-chat').scrollTo(0, document.getElementById('view-chat').scrollHeight);
                    setTimeout(type, speed);
                } else {
                    div.innerHTML = marked.parse(text);
                    setupCodeBlocks(div);
                }
            }
            type();
        }

        function addMessage(role, content) {
            if(role === 'user') {
                chatHistory.push({ role, content });
                localStorage.setItem('dza_history', JSON.stringify(chatHistory));
            }
            const container = document.getElementById('chatContainer');
            const div = document.createElement('div');
            if (role === 'system') {
                div.className = 'text-center text-[10px] text-yellow-400 my-2 px-4 bg-yellow-900/10 rounded py-1';
                div.innerText = content;
            } else {
                div.className = `msg-bubble ${role === 'user' ? 'msg-user' : 'msg-bot'}`;
                if(role === 'assistant' && user.isPro) div.classList.add('msg-vip');
                div.innerHTML = role === 'user' ? content : marked.parse(content);
                if(role === 'assistant') setupCodeBlocks(div);
            }
            container.appendChild(div);
            document.getElementById('view-chat').scrollTo(0, document.getElementById('view-chat').scrollHeight);
        }

        function setupCodeBlocks(element) {
            element.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
                const pre = block.parentElement;
                if(!pre.querySelector('.copy-btn')) {
                    const btn = document.createElement('button');
                    btn.className = 'copy-btn';
                    btn.innerHTML = '<i class="fa-regular fa-copy"></i> Ù†Ø³Ø®';
                    btn.onclick = () => {
                        navigator.clipboard.writeText(block.innerText);
                        btn.innerHTML = '<i class="fa-solid fa-check"></i> ØªÙ…';
                        setTimeout(() => btn.innerHTML = '<i class="fa-regular fa-copy"></i> Ù†Ø³Ø®', 2000);
                    };
                    pre.appendChild(btn);
                }
            });
        }

        function renderChat() {
            const container = document.getElementById('chatContainer');
            container.innerHTML = '';
            if (chatHistory.length === 0) {
                container.innerHTML = `<div class="msg-bubble msg-bot text-center py-6"><i class="fa-solid fa-robot text-4xl text-slate-700 mb-3 block"></i>Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Dza-Genius<br>ÙˆØ§Ø´ Ù†Ù‚Ø¯Ø± Ù†Ø¹Ø§ÙˆÙ†Ùƒ Ø§Ù„ÙŠÙˆÙ…ØŸ</div>`;
                return;
            }
            chatHistory.forEach(msg => {
                const div = document.createElement('div');
                let cls = `msg-bubble ${msg.role === 'user' ? 'msg-user' : 'msg-bot'}`;
                if(msg.role === 'assistant' && user.isPro) cls += ' msg-vip';
                div.className = cls;
                div.innerHTML = msg.role === 'assistant' ? marked.parse(msg.content) : msg.content;
                if(msg.role === 'assistant') setupCodeBlocks(div);
                container.appendChild(div);
            });
        }

        function addLoader() {
            const id = 'loader-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'msg-bubble msg-bot w-16';
            div.innerHTML = `<div class="flex gap-1 justify-center py-1"><div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div><div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div><div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div></div>`;
            document.getElementById('chatContainer').appendChild(div);
            div.scrollIntoView();
            return id;
        }
        function removeLoader(id) { const el = document.getElementById(id); if(el) el.remove(); }

        // --- 6. Tools Helper Functions ---
        function calcKey() {
            const num = document.getElementById('ccpInput').value;
            if(num) {
                const key = 97n - ((BigInt(num) * 100n) % 97n);
                document.getElementById('ccpRes').innerHTML = `Ø§Ù„Ù…ÙØªØ§Ø­ Ù‡Ùˆ: <span class="text-blue-400 text-2xl">${key.toString().padStart(2, '0')}</span>`;
            }
        }
        function editRate() {
            const newRate = prompt("Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø± Ø§Ù„Ø£ÙˆØ±Ùˆ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¯Ø¬):", settings.currencyRate);
            if(newRate && !isNaN(newRate)) {
                settings.currencyRate = parseInt(newRate);
                document.getElementById('currentRate').innerText = settings.currencyRate;
                saveLocal();
                calcCurrency();
            }
        }
        function calcCurrency() {
            const amount = document.getElementById('currAmount').value;
            const type = document.getElementById('currType').value;
            const rate = type === 'eur' ? settings.currencyRate : (settings.currencyRate - 30);
            document.getElementById('currResult').innerText = (amount * rate).toLocaleString() + " DA";
        }
        if(document.getElementById('currAmount')) {
            document.getElementById('currAmount').addEventListener('input', calcCurrency);
            document.getElementById('currType').addEventListener('change', calcCurrency);
        }

        async function refreshTools() { /* ... */ } // (Ù†ÙØ³ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©)

        function updatePrayerCountdown() {
            if(typeof adhan === 'undefined') return;
            const coords = new adhan.Coordinates(settings.lat, settings.lon);
            const params = adhan.CalculationMethod.MuslimWorldLeague();
            params.madhab = adhan.Madhab.Shafi;
            const date = new Date();
            const prayerTimes = new adhan.PrayerTimes(coords, date, params);
            const next = prayerTimes.nextPrayer();
            const nextTime = prayerTimes.timeForPrayer(next);
            const names = { fajr: 'Ø§Ù„ØµØ¨Ø­', dhuhr: 'Ø§Ù„Ø¸Ù‡Ø±', asr: 'Ø§Ù„Ø¹ØµØ±', maghrib: 'Ø§Ù„Ù…ØºØ±Ø¨', isha: 'Ø§Ù„Ø¹Ø´Ø§Ø¡', none: 'ØºØ¯Ø§Ù‹' };
            if(next !== 'none') {
                const diff = nextTime - date;
                const h = Math.floor(diff / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                document.getElementById('nextPrayerName').innerText = names[next];
                document.getElementById('nextPrayerCounter').innerText = `-${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            }
        }

        function getUserLocation() {
            if(!navigator.geolocation) return;
            document.getElementById('headerCity').innerText = "ØªØ­Ø¯ÙŠØ¯...";
            navigator.geolocation.getCurrentPosition(async (pos) => {
                settings.lat = pos.coords.latitude;
                settings.lon = pos.coords.longitude;
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${settings.lat}&lon=${settings.lon}`);
                    const json = await res.json();
                    settings.city = json.address.city || json.address.town || json.address.state || "Ù…ÙˆÙ‚Ø¹ÙŠ";
                    updateUI();
                    saveLocal();
                } catch(e) { console.log(e); }
            });
        }

        // --- 7. UI Helpers ---
        function updateUI() { document.getElementById('headerCity').innerText = settings.city; }
        function setInput(t) { document.getElementById('msgInput').value = t; sendMessage(); }
        function fullReset() { if(confirm("ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡!")) { localStorage.clear(); location.reload(); } }
        
        function nav(pageId, btn) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('view-'+pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if(btn && btn.classList.contains('nav-item')) {
                btn.classList.add('active');
            }
        }

        function setMode(mode, btn) {
            settings.mode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => {
                b.classList.remove('active', 'border-green-500', 'text-green-400');
                b.classList.add('text-gray-400');
            });
            btn.classList.add('active', 'border-green-500', 'text-green-400');
            btn.classList.remove('text-gray-400');
            saveLocal();
            addMessage('system', `ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ø®ØµÙŠØ©: ${btn.innerText}`);
        }

        // --- 8. Auth & Subscription Listener ---
        function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).then(res => {
                // Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                const u = res.user;
                db.collection('users').doc(u.uid).set({
                    name: u.displayName,
                    email: u.email,
                    photo: u.photoURL,
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            }).catch(e => alert(e.message));
        }
        function logoutApp() { auth.signOut().then(() => location.reload()); }
        
        auth.onAuthStateChanged((u) => {
            if (u) {
                user.loggedIn = true;
                user.data = u;
                document.getElementById('loginBtnSection').style.display = 'none';
                document.getElementById('userInfoSection').style.display = 'flex';
                document.getElementById('userNameDisplay').innerText = u.displayName;
                document.getElementById('emailDisplay').innerText = u.email;
                document.getElementById('userImgDisplay').src = u.photoURL;

                // Ø§Ø³ØªÙ…Ø§Ø¹ Ù…Ø¨Ø§Ø´Ø± Ù„ØªØºÙŠØ±Ø§Øª Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ØªÙØ¹ÙŠÙ„ ÙÙˆØ±ÙŠ)
                db.collection("users").doc(u.uid).onSnapshot((doc) => {
                    if(doc.exists) {
                        const d = doc.data();
                        user.isPro = d.isPro || false;
                        user.receiptStatus = d.receiptStatus || null;
                        
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø©
                        if (user.isPro) {
                            // ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ VIP
                            document.getElementById('proBadgeCard').classList.remove('hidden');
                            document.getElementById('headerVipBadge').classList.remove('hidden');
                            document.getElementById('headerAvatar').parentElement.classList.add('vip-glow');
                            
                            const vBadge = document.getElementById('versionBadge');
                            vBadge.innerText = "V15 ULTIMATE";
                            vBadge.className = "cursor-pointer text-[9px] bg-gradient-to-r from-yellow-600/20 to-yellow-500/10 text-yellow-500 px-1.5 py-0.5 rounded border border-yellow-500/30 font-bold";
                            
                            // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„ØªØ±Ù‚ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø´ØªØ±ÙƒØ§Ù‹
                            if(document.getElementById('upgradeBtn')) document.getElementById('upgradeBtn').style.display = 'none';
                            
                        } else if (user.receiptStatus === 'pending') {
                            // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø§Ù„Ø© Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                            document.getElementById('userStatusContainer').classList.remove('hidden');
                        }
                    }
                });
            } else {
                user = { loggedIn: false, isPro: false, data: null };
            }
        });
    </script>
</body>
    </html>
