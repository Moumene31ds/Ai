<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Dza-Genius">
    <meta name="apple-mobile-web-app-title" content="Dza-Genius">
    <meta name="theme-color" content="#0f172a">
    <meta name="msapplication-navbutton-color" content="#0f172a">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>Dza-Genius App</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/adhan@4.4.4/dist/adhan.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">

    <link rel="manifest" id="manifest-placeholder">

    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --primary: #10b981;
            --bg-dark: #0f172a;
        }

        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: var(--bg-dark);
            color: #f1f5f9;
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* ØªØ®Ø·ÙŠØ· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
        .app-layout {
            height: 100dvh;
            display: flex;
            flex-direction: column;
            padding-top: var(--safe-top);
            padding-bottom: calc(60px + var(--safe-bottom)); /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù†Ø§ÙØ¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ */
        }

        /* Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: calc(60px + var(--safe-bottom));
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #334155;
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            padding-top: 10px;
            z-index: 50;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            color: #94a3b8;
            transition: 0.2s;
        }
        
        .nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .nav-item i { font-size: 20px; margin-bottom: 2px; }

        /* Ø§Ù„ØµÙØ­Ø§Øª (Tabs) */
        .page { display: none; height: 100%; overflow-y: auto; padding: 16px; scroll-behavior: smooth; }
        .page.active-page { display: block; animation: fadeIn 0.3s; }

        /* Chat Bubbles */
        .msg { max-width: 85%; margin-bottom: 12px; position: relative; animation: slideUp 0.2s ease-out; }
        .msg-bot { background: #1e293b; border-radius: 12px 12px 12px 2px; }
        .msg-user { background: #2563eb; border-radius: 12px 12px 2px 12px; margin-left: auto; }

        /* Card Styles */
        .card { background: #1e293b; border-radius: 16px; padding: 16px; margin-bottom: 12px; border: 1px solid #334155; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <div class="app-layout">
        
        <header class="flex justify-between items-center px-4 py-2 border-b border-gray-800 bg-slate-900/50 backdrop-blur sticky top-0 z-40">
            <div class="flex items-center gap-2">
                <span class="w-8 h-8 bg-green-600 rounded-lg flex items-center justify-center font-bold text-white shadow-lg shadow-green-900/20">D</span>
                <div>
                    <h1 class="font-bold text-sm">Dza-Genius</h1>
                    <p class="text-[10px] text-green-400" id="statusText">Ù…ØªØµÙ„ (Groq)</p>
                </div>
            </div>
            <button id="installBtn" class="hidden text-xs bg-slate-800 border border-slate-700 px-3 py-1 rounded-full text-blue-400 hover:bg-slate-700">
                <i class="fa-solid fa-download"></i> ØªØ«Ø¨ÙŠØª
            </button>
        </header>

        <main id="tab-chat" class="page active-page flex flex-col">
            <div id="chatContainer" class="flex-1 overflow-y-auto pb-4">
                <div class="msg msg-bot p-4 shadow-sm">
                    <div class="text-xs font-bold text-green-500 mb-1">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯</div>
                    <div class="text-sm">ÙˆØ§Ø´ Ø®ÙˆÙŠØ§! Ù…Ø±Ø­Ø¨Ø§ Ø¨ÙŠÙƒ ÙÙŠ Dza-Genius 4.0 ğŸ‡©ğŸ‡¿.
                    <br>ÙƒØ§Ø´ Ù…Ø§ ÙŠØ®ØµÙƒ (Ù‡Ø¯Ø±Ø©ØŒ Ø­Ø³Ø§Ø¨Ø§ØªØŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª) Ø±Ø§Ù†ÙŠ Ù‡Ù†Ø§.</div>
                </div>
            </div>
            
            <div class="mt-auto pt-2">
                <div class="flex gap-2 items-end bg-slate-800 p-2 rounded-2xl border border-slate-700">
                    <button onclick="toggleRecording()" id="micBtn" class="w-10 h-10 rounded-full bg-slate-700 text-gray-400 flex items-center justify-center flex-shrink-0 active:text-red-500 transition">
                        <i class="fa-solid fa-microphone"></i>
                    </button>
                    <textarea id="userInput" rows="1" class="flex-1 bg-transparent text-white text-sm p-2.5 focus:outline-none resize-none max-h-32" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." oninput="autoResize(this)"></textarea>
                    <button onclick="sendMessage()" class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center flex-shrink-0 shadow-lg active:scale-90 transition">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </main>

        <main id="tab-tools" class="page">
            <h2 class="text-xl font-bold mb-4 px-2">Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±ÙŠØ©</h2>
            
            <div class="card">
                <div class="flex items-center gap-3 mb-3 text-yellow-500">
                    <i class="fa-solid fa-building-columns text-xl"></i>
                    <h3 class="font-bold">Ø­Ø§Ø³Ø¨Ø© Ù…ÙØªØ§Ø­ Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± (CCP)</h3>
                </div>
                <div class="space-y-3">
                    <input type="number" id="ccpInput" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ù…ÙØªØ§Ø­)" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-center tracking-widest outline-none focus:border-yellow-500">
                    <button onclick="calcCCP()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-xl transition">Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…ÙØªØ§Ø­ (ClÃ©)</button>
                    <div id="ccpResult" class="hidden bg-slate-900 p-3 rounded-xl text-center border border-yellow-500/30">
                        <span class="text-gray-400 text-xs">Ø§Ù„Ù…ÙØªØ§Ø­ Ù‡Ùˆ:</span>
                        <div class="text-2xl font-bold text-white mt-1" id="ccpKeyDisplay">--</div>
                        <div class="text-xs text-gray-500 mt-1" id="ccpFullDisplay"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="flex items-center gap-3 mb-3 text-green-500">
                    <i class="fa-solid fa-money-bill-transfer text-xl"></i>
                    <h3 class="font-bold">Ø³Ø¹Ø± Ø§Ù„Ø³ÙƒÙˆØ§Ø± (Devise)</h3>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div class="bg-slate-900 p-2 rounded-lg text-center">
                        <div class="text-xs text-gray-400">1 Euro (â‚¬)</div>
                        <input type="number" id="eurRate" value="245" class="w-full bg-transparent text-center font-bold text-white outline-none">
                    </div>
                    <div class="bg-slate-900 p-2 rounded-lg text-center">
                        <div class="text-xs text-gray-400">1 USD ($)</div>
                        <input type="number" id="usdRate" value="225" class="w-full bg-transparent text-center font-bold text-white outline-none">
                    </div>
                </div>
                <input type="number" id="currencyInput" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø£ÙˆØ±Ùˆ/Ø¯ÙˆÙ„Ø§Ø±" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-center mb-2 outline-none">
                <div class="text-center font-bold text-xl text-green-400" id="currencyResult">0 DZD</div>
            </div>

            <div class="card">
                <div class="flex items-center gap-3 mb-3 text-blue-400">
                    <i class="fa-solid fa-mosque text-xl"></i>
                    <h3 class="font-bold">Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© (Ø§Ù„ÙŠÙˆÙ…)</h3>
                </div>
                <div id="prayerList" class="text-sm space-y-2 divide-y divide-slate-700/50">Loading...</div>
            </div>
        </main>

        <main id="tab-settings" class="page">
            <h2 class="text-xl font-bold mb-4 px-2">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>

            <div class="card">
                <h3 class="text-sm font-bold text-gray-400 mb-3 uppercase">Ø§Ù„Ù…Ø­Ø±Ùƒ (Engine)</h3>
                <select id="providerSelect" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 mb-3 text-sm outline-none" onchange="saveSettings()">
                    <option value="groq">Groq (Ù…Ø¬Ø§Ù†ÙŠ ÙˆØ³Ø±ÙŠØ¹)</option>
                    <option value="openai">OpenAI (GPT-4)</option>
                </select>
                <input type="password" id="apiKey" placeholder="Ø¶Ø¹ Ù…ÙØªØ§Ø­ API Ù‡Ù†Ø§..." class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm font-mono outline-none focus:border-green-500 mb-2" onchange="saveSettings()">
                <div class="flex justify-between text-[10px] text-blue-400">
                    <a href="https://console.groq.com/keys" target="_blank">Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ Groq</a>
                    <span class="text-gray-500">ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‡Ø§ØªÙÙƒ ÙÙ‚Ø·</span>
                </div>
            </div>

            <div class="card">
                <h3 class="text-sm font-bold text-gray-400 mb-3 uppercase">Ø§Ù„Ø´Ø®ØµÙŠØ© (Persona)</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="setPersona('darja')" class="p-3 bg-slate-900 rounded-xl text-xs border border-green-500/50 hover:bg-slate-800 transition">ğŸ‡©ğŸ‡¿ Ø§Ù„Ø¯Ø§Ø±Ø¬Ø©</button>
                    <button onclick="setPersona('admin')" class="p-3 bg-slate-900 rounded-xl text-xs hover:bg-slate-800 transition">âš–ï¸ Ø®Ø¨ÙŠØ± Ø¥Ø¯Ø§Ø±ÙŠ</button>
                    <button onclick="setPersona('tech')" class="p-3 bg-slate-900 rounded-xl text-xs hover:bg-slate-800 transition">ğŸ’» Ù…Ø¨Ø±Ù…Ø¬</button>
                    <button onclick="setPersona('poet')" class="p-3 bg-slate-900 rounded-xl text-xs hover:bg-slate-800 transition">âœ’ï¸ Ø´Ø§Ø¹Ø± Ø´Ø¹Ø¨ÙŠ</button>
                </div>
            </div>

            <div class="card">
                <button onclick="clearHistory()" class="w-full text-red-400 text-sm py-2 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-trash"></i> Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
                </button>
            </div>
        </main>

        <nav class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('chat', this)">
                <i class="fa-solid fa-comment-dots"></i>
                <span>Ù…Ø­Ø§Ø¯Ø«Ø©</span>
            </div>
            <div class="nav-item" onclick="switchTab('tools', this)">
                <i class="fa-solid fa-toolbox"></i>
                <span>Ø£Ø¯ÙˆØ§Øª</span>
            </div>
            <div class="nav-item" onclick="switchTab('settings', this)">
                <i class="fa-solid fa-gear"></i>
                <span>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
            </div>
        </nav>

    </div>

    <script>
        // --- 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª PWA (Android Install) ---
        // Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Manifest Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù„ÙŠØ¹Ù…Ù„ ÙƒÙ…Ù„Ù ÙˆØ§Ø­Ø¯
        const manifestData = {
            "name": "Dza-Genius",
            "short_name": "Dza-Genius",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#0f172a",
            "theme_color": "#0f172a",
            "icons": [
                { "src": "https://cdn-icons-png.flaticon.com/512/4712/4712109.png", "sizes": "192x192", "type": "image/png" }
            ]
        };
        const stringManifest = JSON.stringify(manifestData);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBtn').classList.remove('hidden');
        });

        document.getElementById('installBtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('installBtn').classList.add('hidden');
                }
                deferredPrompt = null;
            }
        });

        // --- 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Tabs) ---
        function switchTab(tabId, el) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            // Show selected page
            document.getElementById('tab-' + tabId).classList.add('active-page');
            
            // Update Nav Icons
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        // --- 3. Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±ÙŠØ© (Logic) ---
        
        // Ø­Ø³Ø§Ø¨ Ù…ÙØªØ§Ø­ CCP
        function calcCCP() {
            const account = document.getElementById('ccpInput').value;
            if (!account || account.length < 5) {
                alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØµØ­ÙŠØ­");
                return;
            }
            // Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙØªØ§Ø­
            // Key = 97 - ((Account * 100) % 97)
            // Ù†Ø³ØªØ®Ø¯Ù… BigInt Ù„Ø£Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù‚Ø¯ ØªÙƒÙˆÙ† ÙƒØ¨ÙŠØ±Ø©
            try {
                const accNum = BigInt(account);
                const x = accNum * 100n;
                const remainder = x % 97n;
                const key = 97n - remainder;
                
                // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¶
                document.getElementById('ccpResult').classList.remove('hidden');
                document.getElementById('ccpKeyDisplay').innerText = key.toString().padStart(2, '0');
                document.getElementById('ccpFullDisplay').innerText = `RIP: ${account} / ${key.toString().padStart(2, '0')}`;
            } catch (e) {
                alert("Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­");
            }
        }

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙƒÙˆØ§Ø±
        document.getElementById('currencyInput').addEventListener('input', function(e) {
            const val = parseFloat(e.target.value);
            const rate = parseFloat(document.getElementById('eurRate').value);
            if(val) {
                document.getElementById('currencyResult').innerText = (val * rate).toLocaleString() + " DZD";
            }
        });

        // Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©
        function loadPrayer() {
            const coords = new adhan.Coordinates(36.75, 3.05); // Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±
            const params = adhan.CalculationMethod.MuslimWorldLeague();
            const date = new Date();
            const pt = new adhan.PrayerTimes(coords, date, params);
            const f = (t) => t.toLocaleTimeString('fr-DZ', {hour:'2-digit', minute:'2-digit'});
            
            document.getElementById('prayerList').innerHTML = `
                <div class="flex justify-between py-1 border-b border-gray-800"><span>Ø§Ù„ÙØ¬Ø±</span><span class="text-green-400 font-mono">${f(pt.fajr)}</span></div>
                <div class="flex justify-between py-1 border-b border-gray-800"><span>Ø§Ù„Ø¸Ù‡Ø±</span><span class="text-green-400 font-mono">${f(pt.dhuhr)}</span></div>
                <div class="flex justify-between py-1 border-b border-gray-800"><span>Ø§Ù„Ø¹ØµØ±</span><span class="text-green-400 font-mono">${f(pt.asr)}</span></div>
                <div class="flex justify-between py-1 border-b border-gray-800"><span>Ø§Ù„Ù…ØºØ±Ø¨</span><span class="text-green-400 font-mono">${f(pt.maghrib)}</span></div>
                <div class="flex justify-between py-1"><span>Ø§Ù„Ø¹Ø´Ø§Ø¡</span><span class="text-green-400 font-mono">${f(pt.isha)}</span></div>
            `;
        }
        loadPrayer();

        // --- 4. Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Chat Engine) ---
        
        // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ù† LocalStorage
        const savedKey = localStorage.getItem('dza_apiKey');
        const savedProvider = localStorage.getItem('dza_provider');
        const savedHistory = localStorage.getItem('dza_history');

        if(savedKey) document.getElementById('apiKey').value = savedKey;
        if(savedProvider) document.getElementById('providerSelect').value = savedProvider;
        if(savedHistory) document.getElementById('chatContainer').innerHTML = savedHistory;

        function saveSettings() {
            localStorage.setItem('dza_apiKey', document.getElementById('apiKey').value);
            localStorage.setItem('dza_provider', document.getElementById('providerSelect').value);
            updateStatus();
        }

        function updateStatus() {
            const provider = document.getElementById('providerSelect').value;
            document.getElementById('statusText').innerText = `Ù…ØªØµÙ„ (${provider})`;
        }

        let currentPersona = 'darja';
        const personas = {
            darja: "You are an Algerian Assistant. Speak in Darja (Algerian Dialect). Be helpful and friendly.",
            admin: "You are an expert in Algerian Bureaucracy. Assist with formal letters and legal info.",
            tech: "You are a coding expert. Explain in simple terms.",
            poet: "You are an Algerian Chaabi poet. Speak with rhymes and deep wisdom."
        };

        function setPersona(p) {
            currentPersona = p;
            alert(`ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„ÙˆØ¶Ø¹ Ø¥Ù„Ù‰: ${p}`);
        }

        function appendMessage(sender, text) {
            const div = document.createElement('div');
            const isUser = sender === 'user';
            div.className = `msg ${isUser ? 'msg-user' : 'msg-bot'} p-3 shadow-sm text-sm`;
            
            div.innerHTML = isUser ? text.replace(/\n/g, '<br>') : marked.parse(text);
            
            document.getElementById('chatContainer').appendChild(div);
            div.scrollIntoView({behavior: "smooth"});

            // Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„
            localStorage.setItem('dza_history', document.getElementById('chatContainer').innerHTML);
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            const apiKey = document.getElementById('apiKey').value;
            const provider = document.getElementById('providerSelect').value;

            if(!text) return;
            if(!apiKey) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ API ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª'); switchTab('settings', document.querySelectorAll('.nav-item')[2]); return; }

            input.value = '';
            input.style.height = 'auto';
            appendMessage('user', text);

            // Loader
            const loaderDiv = document.createElement('div');
            loaderDiv.className = 'msg msg-bot p-3 w-12 flex justify-center';
            loaderDiv.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin text-green-500"></i>';
            loaderDiv.id = 'loader';
            document.getElementById('chatContainer').appendChild(loaderDiv);
            loaderDiv.scrollIntoView();

            try {
                const url = provider === 'groq' ? 'https://api.groq.com/openai/v1/chat/completions' : 'https://api.openai.com/v1/chat/completions';
                const model = provider === 'groq' ? 'llama3-70b-8192' : 'gpt-4-turbo-preview';

                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            { role: "system", content: personas[currentPersona] },
                            { role: "user", content: text }
                        ]
                    })
                });
                
                const data = await res.json();
                document.getElementById('loader').remove();
                
                if(data.error) throw new Error(data.error.message);
                appendMessage('ai', data.choices[0].message.content);

            } catch (e) {
                document.getElementById('loader')?.remove();
                appendMessage('ai', `Ø®Ø·Ø£: ${e.message}`);
            }
        }

        function clearHistory() {
            if(confirm("Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ØŸ")) {
                localStorage.removeItem('dza_history');
                document.getElementById('chatContainer').innerHTML = '';
            }
        }

        // Voice
        let recognition;
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'ar-DZ';
            recognition.continuous = false;
            recognition.onstart = () => document.getElementById('micBtn').classList.add('text-red-500');
            recognition.onend = () => document.getElementById('micBtn').classList.remove('text-red-500');
            recognition.onresult = (e) => { document.getElementById('userInput').value += " " + e.results[0][0].transcript; };
        }
        function toggleRecording() { recognition ? recognition.start() : alert("Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­"); }

    </script>
</body>
</html>
