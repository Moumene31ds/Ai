<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <meta name="application-name" content="Dza-Genius">
    <title>Dza-Genius V9 Ultimate</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/adhan/4.4.4/Adhan.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">

    <link rel="manifest" id="manifest-placeholder">

    <style>
        /* --- ØªØ®ØµÙŠØµØ§Øª CSS --- */
        :root {
            --primary: #10b981;
            --bg-dark: #0f172a;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-dark);
            color: #f8fafc;
            height: 100dvh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            background-image: radial-gradient(#1e293b 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* ØªØ®Ø·ÙŠØ· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
        .app-layout {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding-top: var(--safe-top);
            padding-bottom: calc(75px + var(--safe-bottom));
        }

        /* Ø§Ù„ØµÙØ­Ø§Øª */
        .page { display: none; height: 100%; overflow-y: auto; padding: 16px; scroll-behavior: smooth; }
        .page.active { display: block; animation: fadeUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }

        /* ÙÙ‚Ø§Ø¹Ø§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
        .msg-bubble {
            max-width: 88%;
            padding: 14px 18px;
            margin-bottom: 14px;
            border-radius: 20px;
            position: relative;
            word-wrap: break-word;
            font-size: 15px;
            line-height: 1.6;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .msg-bot { background: #1e293b; color: #e2e8f0; border: 1px solid #334155; border-bottom-left-radius: 4px; }
        .msg-user { background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; margin-right: auto; border-bottom-right-radius: 4px; }

        /* Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø§Øª */
        pre { background: #020617 !important; padding: 12px !important; border-radius: 12px !important; direction: ltr; overflow-x: auto; border: 1px solid #334155; }
        code { font-family: 'Courier New', monospace; font-size: 13px; }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ© (Glassmorphism) */
        .glass-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 20px;
            padding: 18px;
            margin-bottom: 14px;
            transition: transform 0.2s;
        }
        .glass-card:active { transform: scale(0.98); }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%;
            height: calc(75px + var(--safe-bottom));
            background: rgba(15, 23, 42, 0.90);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-around; padding-top: 14px; z-index: 50;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 11px; color: #64748b; width: 25%; transition: 0.3s; cursor: pointer; }
        .nav-item.active { color: var(--primary); transform: translateY(-4px); font-weight: bold; }
        .nav-item i { font-size: 22px; margin-bottom: 5px; }

        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø­Ø±ÙƒØ© */
        @keyframes fadeUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .typing-dots span { display: inline-block; width: 6px; height: 6px; background: #94a3b8; border-radius: 50%; margin: 0 2px; animation: bounce 1.4s infinite; }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
    </style>
</head>
<body>

    <div id="welcomeModal" class="fixed inset-0 z-[100] flex items-center justify-center p-6 hidden bg-black/90 backdrop-blur-md">
        <div class="glass-card w-full max-w-sm text-center border-2 border-green-500/20 shadow-2xl shadow-green-900/20">
            <div class="w-20 h-20 bg-gradient-to-tr from-green-500 to-teal-600 rounded-2xl flex items-center justify-center mx-auto mb-5 text-3xl shadow-lg animate-bounce">ğŸ‡©ğŸ‡¿</div>
            <h2 class="text-2xl font-black mb-2 text-white">Dza-Genius V9</h2>
            <p class="text-sm text-gray-400 mb-6 font-medium">Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„</p>
            
            <div class="text-right mb-4 bg-slate-900/50 p-4 rounded-xl border border-slate-700">
                <label class="text-[11px] text-gray-400 uppercase font-bold block mb-2">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø±Ùƒ (AI Engine)</label>
                <select id="welcomeProvider" class="w-full bg-slate-800 border border-slate-600 rounded-xl p-3 text-sm mb-4 outline-none text-white focus:border-green-500 transition">
                    <option value="groq">Groq (Llama 3.3 - Ù…Ø¬Ø§Ù†ÙŠ ÙˆØ³Ø±ÙŠØ¹ ğŸš€)</option>
                    <option value="openai">OpenAI (GPT-4o - Ø¯Ù‚ÙŠÙ‚)</option>
                </select>
                
                <label class="text-[11px] text-gray-400 uppercase font-bold block mb-2">Ù…ÙØªØ§Ø­ API Key</label>
                <input type="password" id="welcomeKey" placeholder="Ø£Ù„ØµÙ‚ Ø§Ù„Ù…ÙØªØ§Ø­ Ù‡Ù†Ø§..." class="w-full bg-slate-800 border border-slate-600 rounded-xl p-3 text-sm font-mono outline-none text-white focus:border-green-500 transition">
                <a href="https://console.groq.com/keys" target="_blank" class="text-[11px] text-blue-400 mt-3 block text-center hover:text-blue-300 transition flex items-center justify-center gap-1">
                    <i class="fa-solid fa-key"></i> Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ Ù…Ø¬Ø§Ù†ÙŠ
                </a>
            </div>
            <button onclick="finishOnboarding()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-xl transition shadow-lg transform active:scale-95">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ¬Ø±Ø¨Ø©</button>
        </div>
    </div>

    <div class="app-layout">
        
        <header class="flex justify-between items-center px-5 py-4 bg-slate-900/80 backdrop-blur sticky top-0 z-40 border-b border-slate-800">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-green-600 to-teal-700 flex items-center justify-center text-white font-bold text-sm shadow-green-900/50 shadow-lg">DZ</div>
                <div>
                    <h1 class="font-bold text-base text-white">Dza-Genius</h1>
                    <div class="text-[11px] text-gray-400 flex items-center gap-1.5 cursor-pointer hover:text-green-400 transition" onclick="getUserLocation()" id="locationDisplay">
                        <i class="fa-solid fa-location-arrow"></i> <span>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...</span>
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="getUserLocation()" class="w-9 h-9 rounded-full bg-slate-800 text-blue-400 border border-slate-700 flex items-center justify-center hover:bg-slate-700 transition" title="GPS">
                    <i class="fa-solid fa-crosshairs"></i>
                </button>
                <button onclick="exportChatPDF()" class="w-9 h-9 rounded-full bg-slate-800 text-gray-300 border border-slate-700 flex items-center justify-center hover:bg-slate-700 transition" title="PDF">
                    <i class="fa-solid fa-file-pdf"></i>
                </button>
            </div>
        </header>

        <main id="view-chat" class="page active">
            <div id="chatContainer" class="pb-28 min-h-[60vh]">
                <div class="msg-bubble msg-bot shadow-lg">
                    <div class="text-xs font-bold text-green-400 mb-1 flex items-center gap-2">
                        <i class="fa-solid fa-robot"></i> Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ
                    </div>
                    <div>ÙˆØ§Ø´ Ø±Ø§Ùƒ Ø®ÙˆÙŠØ§/Ø£Ø®ØªÙŠ! ğŸ‘‹<br>Ø£Ù†Ø§ Ù‡Ù†Ø§ Ø¨Ø§Ø´ Ù†Ø¹Ø§ÙˆÙ†Ùƒ ÙÙŠ ÙƒÙ„Ø´.<br>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± <b>GPS</b> Ø§Ù„ÙÙˆÙ‚ Ø¨Ø§Ø´ Ù†Ø¶Ø¨Ø·Ù„Ùƒ Ø§Ù„ØµÙ„Ø§Ø© ÙˆØ§Ù„Ø·Ù‚Ø³ØŒ ÙˆÙ…Ø¨Ø¹Ø¯ Ø³Ù‚Ø³ÙŠÙ†ÙŠ ÙˆØ§Ø´ Ø­Ø¨ÙŠØª!</div>
                </div>
            </div>
            
            <div class="fixed bottom-[calc(75px+var(--safe-bottom))] left-0 right-0 px-4 py-3 z-40 bg-gradient-to-t from-slate-900 via-slate-900/95 to-transparent">
                <div class="max-w-3xl mx-auto flex items-end gap-2 bg-slate-800/90 backdrop-blur p-2 rounded-3xl border border-slate-700 shadow-2xl">
                    <button id="micBtn" onclick="toggleVoice()" class="w-11 h-11 rounded-full bg-slate-700 text-gray-400 flex items-center justify-center flex-shrink-0 transition active:text-red-500 active:bg-red-900/20 hover:text-white">
                        <i class="fa-solid fa-microphone"></i>
                    </button>
                    <textarea id="msgInput" rows="1" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." class="flex-1 bg-transparent text-white text-sm p-3 focus:outline-none resize-none max-h-32 placeholder-gray-500" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
                    <button onclick="sendMessage()" class="w-11 h-11 rounded-full bg-green-600 hover:bg-green-500 text-white flex items-center justify-center flex-shrink-0 shadow-lg transition transform active:scale-90">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </main>

        <main id="view-tools" class="page">
            <h2 class="text-lg font-bold mb-4 px-1 text-gray-300 flex items-center gap-2"><i class="fa-solid fa-toolbox"></i> Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø°ÙƒÙŠØ©</h2>

            <div class="glass-card flex justify-between items-center bg-gradient-to-br from-blue-900/30 to-slate-900 border-r-4 border-blue-500 overflow-hidden relative">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-500/20 rounded-full blur-2xl"></div>
                <div>
                    <h3 class="text-xs text-blue-300 font-bold mb-1"><i class="fa-solid fa-location-dot"></i> Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ù…Ø­Ù„ÙŠ</h3>
                    <div id="weatherTemp" class="text-4xl font-black text-white tracking-tighter">--Â°</div>
                    <div id="weatherDesc" class="text-xs text-gray-400 mt-1">ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ GPS</div>
                </div>
                <div class="text-center z-10">
                    <i class="fa-solid fa-cloud-sun text-4xl text-yellow-400 drop-shadow-lg"></i>
                    <div id="weatherCity" class="text-[10px] text-gray-400 mt-1 font-bold">---</div>
                </div>
            </div>

            <div class="glass-card border-r-4 border-green-500 relative overflow-hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-green-400"><i class="fa-solid fa-mosque"></i> Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©</h3>
                    <div id="nextPrayerCounter" class="text-xs bg-green-500/10 text-green-300 px-3 py-1 rounded-full border border-green-500/20 font-mono">--:--:--</div>
                </div>
                <div id="prayerList" class="space-y-2 text-sm">
                    <div class="text-center text-gray-500 text-xs py-2">Ø¬Ø§Ø±ÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹...</div>
                </div>
                <div class="mt-4 pt-3 border-t border-gray-700/50 text-[10px] text-gray-500 flex justify-between items-center">
                    <span id="prayerLocLabel"><i class="fa-solid fa-map-pin"></i> ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
                    <span id="qiblaLabel" class="bg-slate-800 px-2 py-1 rounded">ğŸ•‹ Ø§Ù„Ù‚Ø¨Ù„Ø©: --</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="glass-card mb-0 flex flex-col justify-between">
                    <div class="text-yellow-500 text-xs font-bold mb-2"><i class="fa-solid fa-credit-card"></i> Ù…ÙØªØ§Ø­ CCP</div>
                    <input type="number" id="ccpInput" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨" class="bg-slate-900/50 border border-slate-700 rounded-lg p-2 text-xs text-center mb-2 outline-none">
                    <button onclick="calcCCP()" class="bg-yellow-600/20 text-yellow-400 hover:bg-yellow-600 hover:text-white border border-yellow-600/30 py-1.5 rounded-lg text-xs transition">Ø§Ø­Ø³Ø¨</button>
                    <div id="ccpResult" class="hidden mt-2 text-center font-mono font-bold text-white text-lg"></div>
                </div>

                <div class="glass-card mb-0 flex flex-col justify-between">
                    <div class="text-purple-400 text-xs font-bold mb-2"><i class="fa-solid fa-calculator"></i> Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„</div>
                    <div class="flex gap-1 mb-2">
                        <input type="number" id="gradeSum" placeholder="Ù…Ø¬Ù…ÙˆØ¹" class="w-1/2 bg-slate-900/50 border border-slate-700 rounded-lg p-2 text-[10px] text-center">
                        <input type="number" id="coeffSum" placeholder="Ù…Ø¹Ø§Ù…Ù„" class="w-1/2 bg-slate-900/50 border border-slate-700 rounded-lg p-2 text-[10px] text-center">
                    </div>
                    <button onclick="calcGrade()" class="bg-purple-600/20 text-purple-400 hover:bg-purple-600 hover:text-white border border-purple-600/30 py-1.5 rounded-lg text-xs transition">Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
                </div>
            </div>

            <div class="glass-card">
                <h3 class="text-xs font-bold text-red-400 mb-3"><i class="fa-solid fa-phone-flip"></i> Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</h3>
                <div class="flex gap-2">
                    <a href="tel:14" class="flex-1 bg-red-900/20 border border-red-500/30 p-2 rounded-xl text-center hover:bg-red-600 hover:text-white transition group">
                        <i class="fa-solid fa-fire-extinguisher text-xl mb-1 text-red-400 group-hover:text-white"></i>
                        <div class="text-[10px]">Ø§Ù„Ø­Ù…Ø§ÙŠØ© (14)</div>
                    </a>
                    <a href="tel:17" class="flex-1 bg-blue-900/20 border border-blue-500/30 p-2 rounded-xl text-center hover:bg-blue-600 hover:text-white transition group">
                        <i class="fa-solid fa-shield-halved text-xl mb-1 text-blue-400 group-hover:text-white"></i>
                        <div class="text-[10px]">Ø§Ù„Ø´Ø±Ø·Ø© (17)</div>
                    </a>
                    <a href="tel:1055" class="flex-1 bg-green-900/20 border border-green-500/30 p-2 rounded-xl text-center hover:bg-green-600 hover:text-white transition group">
                        <i class="fa-solid fa-person-military-rifle text-xl mb-1 text-green-400 group-hover:text-white"></i>
                        <div class="text-[10px]">Ø§Ù„Ø¯Ø±Ùƒ (1055)</div>
                    </a>
                </div>
            </div>
        </main>

        <main id="view-settings" class="page">
            <h2 class="text-lg font-bold mb-4 px-1 text-gray-300"><i class="fa-solid fa-sliders"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
            
            <div class="glass-card">
                <label class="text-xs text-gray-400 block mb-3 font-bold uppercase">Ø§Ù„Ø´Ø®ØµÙŠØ© (Persona Mode)</label>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="setMode('darja')" class="mode-btn bg-slate-800 p-3 rounded-xl text-xs border border-green-500 text-green-400 transition">ğŸ—£ï¸ Ø§Ù„Ø¯Ø§Ø±Ø¬Ø©</button>
                    <button onclick="setMode('admin')" class="mode-btn bg-slate-800 p-3 rounded-xl text-xs text-gray-400 hover:bg-slate-700 transition">âš–ï¸ Ø¥Ø¯Ø§Ø±ÙŠ</button>
                    <button onclick="setMode('tech')" class="mode-btn bg-slate-800 p-3 rounded-xl text-xs text-gray-400 hover:bg-slate-700 transition">ğŸ’» Ù…Ø¨Ø±Ù…Ø¬</button>
                    <button onclick="setMode('islam')" class="mode-btn bg-slate-800 p-3 rounded-xl text-xs text-gray-400 hover:bg-slate-700 transition">ğŸ•Œ Ø¯ÙŠÙ†ÙŠ</button>
                </div>
            </div>

            <div class="glass-card">
                <label class="text-xs text-gray-400 block mb-2 font-bold uppercase">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ (API)</label>
                <div class="space-y-3">
                    <select id="settingProvider" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm outline-none" onchange="saveConfig()">
                        <option value="groq">Groq (Llama 3.3)</option>
                        <option value="openai">OpenAI (GPT-4o)</option>
                    </select>
                    <input type="password" id="settingKey" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm font-mono outline-none focus:border-blue-500 transition" onchange="saveConfig()" placeholder="API Key">
                </div>
            </div>
            
            <button onclick="clearAllData()" class="w-full p-4 text-red-400 bg-red-900/10 border border-red-500/20 rounded-2xl text-xs flex items-center justify-center gap-2 hover:bg-red-900/30 transition">
                <i class="fa-solid fa-trash-can"></i> Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·
            </button>
            
            <div class="mt-8 text-center text-[10px] text-gray-600">
                Dza-Genius V9.0 Ultimate<br>ØµÙ†Ø¹ ÙÙŠ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± ğŸ‡©ğŸ‡¿
            </div>
        </main>

        <nav class="bottom-nav">
            <div class="nav-item active" onclick="nav('chat', this)">
                <i class="fa-solid fa-comment-dots"></i>
                <span>Ù…Ø­Ø§Ø¯Ø«Ø©</span>
            </div>
            <div class="nav-item" onclick="nav('tools', this)">
                <i class="fa-solid fa-layer-group"></i>
                <span>Ø£Ø¯ÙˆØ§Øª</span>
            </div>
            <div class="nav-item" onclick="nav('settings', this)">
                <i class="fa-solid fa-gear"></i>
                <span>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
            </div>
        </nav>
    </div>

    <script>
        // --- 1. Ø§Ù„Ø«ÙˆØ§Ø¨Øª ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
        const MODES = {
            darja: { prompt: "You are a helpful Algerian AI assistant. Speak strictly in 'Algerian Darja' (Arabic/French mix). Be friendly, witty, and concise." },
            admin: { prompt: "You are an expert in Algerian Bureaucracy. Write formal letters (Demandes, Recours) strictly adhering to Algerian standards in Arabic or French." },
            tech: { prompt: "You are a Senior Developer. Explain code simply." },
            islam: { prompt: "Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø¯ÙŠÙ†ÙŠ Ù…Ø·Ù„Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø«Ù‚Ø§ÙØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ© Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±ÙŠØ©. Ø£Ø¬ÙˆØ¨ØªÙƒ Ù…Ù‡Ø°Ø¨Ø© ÙˆÙ…ÙˆØ«Ù‚Ø©." }
        };
        const MODELS = { groq: 'llama-3.3-70b-versatile', openai: 'gpt-4o' };
        
        let currentState = {
            lat: 36.75, // Default Algiers
            lon: 3.05,
            city: "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± (Ø§ÙØªØ±Ø§Ø¶ÙŠ)",
            mode: 'darja'
        };
        
        // --- 2. Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„ ---
        window.onload = () => {
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Manifest Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            const manifest = {
                "name": "Dza-Genius", "short_name": "Dza-Genius", "start_url": ".", "display": "standalone",
                "background_color": "#0f172a", "theme_color": "#0f172a",
                "icons": [{ "src": "https://cdn-icons-png.flaticon.com/512/4712/4712109.png", "sizes": "192x192", "type": "image/png" }]
            };
            const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            document.getElementById('manifest-placeholder').href = URL.createObjectURL(blob);

            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
            const key = localStorage.getItem('dza_key');
            if (!key) {
                document.getElementById('welcomeModal').classList.remove('hidden');
            } else {
                document.getElementById('settingKey').value = key;
                document.getElementById('settingProvider').value = localStorage.getItem('dza_provider') || 'groq';
                // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­ÙÙˆØ¸
                const savedLoc = JSON.parse(localStorage.getItem('dza_loc'));
                if (savedLoc) {
                    currentState.lat = savedLoc.lat;
                    currentState.lon = savedLoc.lon;
                    currentState.city = savedLoc.city;
                    updateLocationUI();
                }
                // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
                if (localStorage.getItem('dza_chat')) {
                    document.getElementById('chatContainer').innerHTML = localStorage.getItem('dza_chat');
                }
            }

            // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª
            refreshWidgets();
            setInterval(updatePrayerTimer, 1000);
        };

        // --- 3. Ù†Ø¸Ø§Ù… GPS ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹ ---
        function getUserLocation() {
            const btn = document.getElementById('locationDisplay');
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...`;
            
            if (!navigator.geolocation) return alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS");

            navigator.geolocation.getCurrentPosition(async (pos) => {
                currentState.lat = pos.coords.latitude;
                currentState.lon = pos.coords.longitude;
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¹Ø±ÙØ© Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentState.lat}&lon=${currentState.lon}`);
                    const data = await res.json();
                    currentState.city = data.address.city || data.address.town || data.address.state || "Ù…ÙˆÙ‚Ø¹ÙŠ";
                } catch (e) { currentState.city = "Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ"; }

                // Ø­ÙØ¸ ÙˆØªØ­Ø¯ÙŠØ«
                localStorage.setItem('dza_loc', JSON.stringify(currentState));
                updateLocationUI();
                refreshWidgets();
                alert(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${currentState.city}`);
            }, (err) => {
                btn.innerHTML = `<i class="fa-solid fa-triangle-exclamation text-yellow-500"></i> ÙØ´Ù„`;
                alert("ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ GPS.");
            });
        }

        function updateLocationUI() {
            document.getElementById('locationDisplay').innerHTML = `<i class="fa-solid fa-location-dot text-green-400"></i> ${currentState.city}`;
            document.getElementById('weatherCity').innerText = currentState.city;
            document.getElementById('prayerLocLabel').innerHTML = `<i class="fa-solid fa-map-pin"></i> ${currentState.city}`;
        }

        // --- 4. Ø§Ù„Ø£Ø¯ÙˆØ§Øª (Widgets) ---
        let prayerInstance = null;

        async function refreshWidgets() {
            // 1. Ø§Ù„ØµÙ„Ø§Ø© (Adhan.js)
            if (typeof adhan !== 'undefined') {
                const coords = new adhan.Coordinates(currentState.lat, currentState.lon);
                const params = adhan.CalculationMethod.MuslimWorldLeague();
                const date = new Date();
                prayerInstance = new adhan.PrayerTimes(coords, date, params);
                
                // Ø§Ù„Ù‚Ø¨Ù„Ø©
                const qibla = adhan.Qibla(coords);
                document.getElementById('qiblaLabel').innerText = `ğŸ•‹ Ø§Ù„Ù‚Ø¨Ù„Ø©: ${Math.round(qibla)}Â°`;

                const fmt = (t) => t.toLocaleTimeString('fr-DZ', {hour:'2-digit', minute:'2-digit'});
                
                document.getElementById('prayerList').innerHTML = `
                    <div class="flex justify-between py-2 border-b border-gray-700/50" id="row-fajr"><span class="text-gray-400">Ø§Ù„ÙØ¬Ø±</span><span class="font-mono text-white font-bold">${fmt(prayerInstance.fajr)}</span></div>
                    <div class="flex justify-between py-2 border-b border-gray-700/50" id="row-dhuhr"><span class="text-gray-400">Ø§Ù„Ø¸Ù‡Ø±</span><span class="font-mono text-white font-bold">${fmt(prayerInstance.dhuhr)}</span></div>
                    <div class="flex justify-between py-2 border-b border-gray-700/50" id="row-asr"><span class="text-gray-400">Ø§Ù„Ø¹ØµØ±</span><span class="font-mono text-white font-bold">${fmt(prayerInstance.asr)}</span></div>
                    <div class="flex justify-between py-2 border-b border-gray-700/50" id="row-maghrib"><span class="text-gray-400">Ø§Ù„Ù…ØºØ±Ø¨</span><span class="font-mono text-white font-bold">${fmt(prayerInstance.maghrib)}</span></div>
                    <div class="flex justify-between py-2" id="row-isha"><span class="text-gray-400">Ø§Ù„Ø¹Ø´Ø§Ø¡</span><span class="font-mono text-white font-bold">${fmt(prayerInstance.isha)}</span></div>
                `;
            }

            // 2. Ø§Ù„Ø·Ù‚Ø³ (Open-Meteo Free API)
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${currentState.lat}&longitude=${currentState.lon}&current_weather=true`);
                const data = await res.json();
                document.getElementById('weatherTemp').innerText = `${Math.round(data.current_weather.temperature)}Â°`;
                const code = data.current_weather.weathercode;
                let desc = "ØµØ§ÙÙŠ";
                if(code > 3) desc = "ØºØ§Ø¦Ù…";
                if(code > 50) desc = "Ù…Ø·Ø±";
                document.getElementById('weatherDesc').innerText = `${desc} - Ø§Ù„Ø±ÙŠØ§Ø­: ${data.current_weather.windspeed}`;
            } catch (e) { console.log("Weather Error"); }
        }

        function updatePrayerTimer() {
            if (!prayerInstance) return;
            const now = new Date();
            const next = prayerInstance.nextPrayer();
            const nextTime = prayerInstance.timeForPrayer(next);
            
            if (nextTime) {
                const diff = nextTime - now;
                const h = Math.floor((diff % 86400000) / 3600000);
                const m = Math.floor(((diff % 86400000) % 3600000) / 60000);
                const s = Math.floor(((diff % 60000) / 1000));
                document.getElementById('nextPrayerCounter').innerText = `- ${h}:${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
                
                // ØªÙ„ÙˆÙŠÙ† Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
                document.querySelectorAll('[id^="row-"]').forEach(el => el.classList.remove('text-green-400', 'bg-green-500/10'));
                const row = document.getElementById(`row-${next}`);
                if(row) row.classList.add('text-green-400', 'bg-green-500/10', 'rounded-lg', 'px-2');
            } else {
                document.getElementById('nextPrayerCounter').innerText = "ØªÙ…Øª Ø§Ù„ØµÙ„ÙˆØ§Øª";
            }
        }

        // --- 5. Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ ---
        function calcCCP() {
            const val = document.getElementById('ccpInput').value;
            if (val) {
                const key = 97n - ((BigInt(val) * 100n) % 97n);
                const el = document.getElementById('ccpResult');
                el.classList.remove('hidden');
                el.innerText = key < 10 ? '0' + key : key;
            }
        }
        function calcGrade() {
            const s = parseFloat(document.getElementById('gradeSum').value);
            const c = parseFloat(document.getElementById('coeffSum').value);
            if (s && c) alert(`Ø§Ù„Ù…Ø¹Ø¯Ù„ Ù‡Ùˆ: ${(s/c).toFixed(2)}`);
        }

        // --- 6. Ø§Ù„Ø´Ø§Øª ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ---
        async function sendMessage() {
            const input = document.getElementById('msgInput');
            const txt = input.value.trim();
            if (!txt) return;
            
            const key = localStorage.getItem('dza_key');
            if (!key) return nav('settings', document.querySelectorAll('.nav-item')[2]);

            input.value = '';
            input.style.height = 'auto';
            appendMsg('user', txt);

            // Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
            const loadingId = 'load-' + Date.now();
            const loader = document.createElement('div');
            loader.id = loadingId;
            loader.className = 'msg-bubble msg-bot typing-dots';
            loader.innerHTML = '<span></span><span></span><span></span>';
            document.getElementById('chatContainer').appendChild(loader);
            loader.scrollIntoView();

            try {
                const prov = localStorage.getItem('dza_provider') || 'groq';
                const url = prov === 'groq' ? 'https://api.groq.com/openai/v1/chat/completions' : 'https://api.openai.com/v1/chat/completions';
                
                // Ø³ÙŠØ§Ù‚ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
                let sysPrompt = MODES[currentState.mode].prompt;
                sysPrompt += ` User Location: ${currentState.city}. Time: ${new Date().toLocaleTimeString()}. Weather info if asked: ${document.getElementById('weatherTemp').innerText}.`;

                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                    body: JSON.stringify({
                        model: MODELS[prov],
                        messages: [{role: "system", content: sysPrompt}, {role: "user", content: txt}],
                        temperature: 0.7
                    })
                });

                const data = await res.json();
                document.getElementById(loadingId).remove();

                if (data.error) throw new Error(data.error.message);
                appendMsg('ai', data.choices[0].message.content);

            } catch (e) {
                document.getElementById(loadingId)?.remove();
                appendMsg('system', `Ø®Ø·Ø£: ${e.message}`);
            }
        }

        function appendMsg(role, txt) {
            const d = document.createElement('div');
            d.className = `msg-bubble ${role==='user'?'msg-user':'msg-bot'}`;
            d.innerHTML = role==='user' ? txt.replace(/\n/g, '<br>') : marked.parse(txt);
            document.getElementById('chatContainer').appendChild(d);
            d.scrollIntoView({behavior:'smooth'});
            localStorage.setItem('dza_chat', document.getElementById('chatContainer').innerHTML);
        }

        // --- 7. ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© ---
        function nav(page, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('view-' + page).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
        }

        function finishOnboarding() {
            const k = document.getElementById('welcomeKey').value;
            const p = document.getElementById('welcomeProvider').value;
            if(k) {
                localStorage.setItem('dza_key', k);
                localStorage.setItem('dza_provider', p);
                document.getElementById('settingKey').value = k;
                document.getElementById('settingProvider').value = p;
                document.getElementById('welcomeModal').classList.add('hidden');
            } else alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…ÙØªØ§Ø­ Ù…Ù† ÙØ¶Ù„Ùƒ");
        }

        function saveConfig() {
            localStorage.setItem('dza_key', document.getElementById('settingKey').value);
            localStorage.setItem('dza_provider', document.getElementById('settingProvider').value);
        }

        function setMode(m) {
            currentState.mode = m;
            document.querySelectorAll('.mode-btn').forEach(b => {
                b.classList.remove('border-green-500', 'text-green-400');
                b.classList.add('text-gray-400');
            });
            event.target.classList.add('border-green-500', 'text-green-400');
            event.target.classList.remove('text-gray-400');
            alert(`ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹: ${m}`);
        }

        function toggleVoice() {
            if(!('webkitSpeechRecognition' in window)) return alert("Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­");
            const r = new webkitSpeechRecognition();
            r.lang = 'ar-DZ';
            r.start();
            document.getElementById('micBtn').classList.add('text-red-400', 'animate-pulse');
            r.onresult = (e) => {
                document.getElementById('msgInput').value += " " + e.results[0][0].transcript;
                document.getElementById('micBtn').classList.remove('text-red-400', 'animate-pulse');
            };
        }

        function exportChatPDF() {
            const el = document.getElementById('chatContainer');
            html2pdf().set({ margin: 10, filename: 'Dza-Chat.pdf', backgroundColor: '#1e293b' }).from(el).save();
        }

        function clearAllData() {
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡ØŸ")) {
                localStorage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>
