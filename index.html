<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="application-name" content="Dza-Genius">
    <meta name="apple-mobile-web-app-title" content="Dza-Genius">
    <meta name="theme-color" content="#0f172a">

    <title>Dza-Genius Ultimate (Fixed)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/adhan@4.4.4/dist/adhan.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">

    <link rel="manifest" id="manifest-placeholder">

    <style>
        :root {
            --primary: #10b981;
            --bg-dark: #0f172a;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-dark);
            color: #f8fafc;
            height: 100dvh; /* Dynamic Height */
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            background-image: radial-gradient(#1e293b 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* --- Layout --- */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding-top: var(--safe-top);
            padding-bottom: calc(70px + var(--safe-bottom));
        }

        /* --- Chat Area --- */
        .page { display: none; height: 100%; overflow-y: auto; padding: 16px; scroll-behavior: smooth; }
        .page.active { display: block; animation: fadeIn 0.3s ease-out; }

        .msg-bubble { max-width: 85%; padding: 12px 16px; margin-bottom: 12px; font-size: 14px; line-height: 1.6; position: relative; word-wrap: break-word; }
        .msg-bot { background: #1e293b; border-radius: 18px 18px 18px 4px; color: #e2e8f0; border: 1px solid #334155; }
        .msg-user { background: #2563eb; border-radius: 18px 18px 4px 18px; color: white; margin-right: auto; }
        
        .code-block { background: #020617; padding: 10px; border-radius: 8px; font-family: monospace; overflow-x: auto; margin: 5px 0; direction: ltr; border: 1px solid #334155; }
        
        /* --- Bottom Nav --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            height: calc(65px + var(--safe-bottom));
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-around;
            padding-top: 12px;
            z-index: 50;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            color: #64748b;
            transition: all 0.3s ease;
            width: 30%;
            cursor: pointer;
        }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        .nav-item i { font-size: 20px; margin-bottom: 4px; }

        /* --- Cards --- */
        .glass-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .typing-indicator span { display: inline-block; width: 6px; height: 6px; bg-gray-400; border-radius: 50%; margin: 0 2px; animation: typing 1.4s infinite; background-color: #9ca3af; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    </style>
</head>
<body>

    <div id="welcomeModal" class="fixed inset-0 z-[100] flex items-center justify-center p-6 hidden bg-slate-900/95 backdrop-blur-sm">
        <div class="bg-slate-800 border border-slate-600 rounded-2xl p-6 w-full max-w-sm text-center shadow-2xl">
            <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl animate-bounce">ğŸ‡©ğŸ‡¿</div>
            <h2 class="text-xl font-bold mb-2 text-white">Ø¥Ø¹Ø¯Ø§Ø¯ Dza-Genius</h2>
            <p class="text-sm text-gray-300 mb-6">Ù…Ø±Ø­Ø¨Ø§ Ø¨ÙŠÙƒ! Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ­ØªØ§Ø¬ Ù…ÙØªØ§Ø­ (API Key) Ø¨Ø§Ø´ ÙŠØ®Ø¯Ù….</p>
            
            <div class="text-left mb-4">
                <label class="text-xs text-gray-400 block mb-1">Ø§Ù„Ù…Ø­Ø±Ùƒ (Provider):</label>
                <select id="welcomeProvider" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm mb-3 text-white outline-none">
                    <option value="groq">Groq (Ù…Ø¬Ø§Ù†ÙŠ - Llama 3.3)</option>
                    <option value="openai">OpenAI (GPT-4o)</option>
                </select>
                
                <label class="text-xs text-gray-400 block mb-1">Ù…ÙØªØ§Ø­ API:</label>
                <input type="password" id="welcomeKey" placeholder="gsk_... Ø£Ùˆ sk-..." class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm font-mono text-white outline-none focus:border-green-500">
                <a href="https://console.groq.com/keys" target="_blank" class="text-[11px] text-blue-400 mt-2 block hover:underline text-center">ğŸ‘‰ Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ Groq Ù…Ø¬Ø§Ù†ÙŠ</a>
            </div>

            <button onclick="finishOnboarding()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl transition shadow-lg">Ø­ÙØ¸ ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… âœ…</button>
        </div>
    </div>

    <div class="app-container">
        
        <header class="flex justify-between items-center px-4 py-3 bg-slate-900/80 backdrop-blur sticky top-0 z-40 border-b border-slate-800">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-green-600 to-teal-600 flex items-center justify-center text-white font-bold text-xs shadow-lg">DZ</div>
                <div>
                    <h1 class="font-bold text-sm text-white">Dza-Genius v6</h1>
                    <div id="statusIndicator" class="text-[10px] text-green-400 flex items-center gap-1">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Ù…ØªØµÙ„
                    </div>
                </div>
            </div>
            <button onclick="installPWA()" id="installBtn" class="hidden bg-slate-800 text-blue-400 text-xs px-3 py-1.5 rounded-full border border-slate-700 hover:bg-slate-700 transition">
                <i class="fa-solid fa-download mr-1"></i> ØªØ«Ø¨ÙŠØª
            </button>
        </header>

        <main id="view-chat" class="page active relative">
            <div id="chatContainer" class="pb-24 min-h-[50vh]">
                <div class="msg-bubble msg-bot shadow-md">
                    <div class="text-xs font-bold text-green-400 mb-1">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ (Llama 3.3)</div>
                    <div>ÙˆØ§Ø´ Ø®ÙˆÙŠØ§/Ø£Ø®ØªÙŠ! ğŸ‘‹<br>Ø±Ø§Ù†ÙŠ Ù‡Ù†Ø§ Ø¨Ø§Ø´ Ù†Ø¹Ø§ÙˆÙ†Ùƒ. Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù„Ù‰ Ø£ÙŠ Ø­Ø§Ø¬Ø© (ÙƒÙˆØ¯ØŒ Ø±Ø³Ø§Ø¦Ù„ Ø¥Ø¯Ø§Ø±ÙŠØ©ØŒ ÙˆÙ„Ø§ Ù‚Øµ Ù†Ø¶Ø­ÙƒÙˆØ§ Ø´ÙˆÙŠØ©).</div>
                </div>
            </div>
            
            <div class="fixed bottom-[calc(65px+var(--safe-bottom))] left-0 right-0 px-3 py-2 bg-gradient-to-t from-slate-900 via-slate-900/90 to-transparent z-40">
                <div class="max-w-3xl mx-auto flex items-end gap-2 bg-slate-800 p-2 rounded-2xl border border-slate-700 shadow-xl">
                    <button id="micBtn" onclick="toggleMic()" class="w-11 h-11 rounded-full bg-slate-700 text-gray-400 flex items-center justify-center flex-shrink-0 transition active:scale-90 hover:text-white">
                        <i class="fa-solid fa-microphone"></i>
                    </button>
                    <textarea id="msgInput" rows="1" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." class="flex-1 bg-transparent text-white text-sm p-3 focus:outline-none resize-none max-h-32 leading-relaxed" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
                    <button onclick="sendMsg()" id="sendBtn" class="w-11 h-11 rounded-full bg-green-600 text-white flex items-center justify-center flex-shrink-0 shadow-lg active:scale-90 transition hover:bg-green-500">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </main>

        <main id="view-tools" class="page">
            <h2 class="text-lg font-bold mb-4 px-1 text-gray-300">Ø£Ø¯ÙˆØ§Øª Ø¬Ø²Ø§Ø¦Ø±ÙŠØ© ğŸ‡©ğŸ‡¿</h2>
            
            <div class="glass-card border-l-4 border-yellow-500">
                <div class="flex items-center gap-3 mb-3 text-yellow-500">
                    <i class="fa-solid fa-building-columns text-xl"></i>
                    <h3 class="font-bold text-sm">Ø­Ø§Ø³Ø¨Ø© Ù…ÙØªØ§Ø­ CCP</h3>
                </div>
                <div class="flex gap-2">
                    <input type="number" id="ccpInput" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ù…ÙØªØ§Ø­)" class="flex-1 bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm text-center outline-none focus:border-yellow-500 text-white font-mono">
                    <button onclick="calculateCCP()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 rounded-lg text-sm font-bold">Ø§Ø­Ø³Ø¨</button>
                </div>
                <div id="ccpOutput" class="mt-3 hidden p-3 bg-slate-900/50 rounded-lg text-center border border-dashed border-gray-600"></div>
            </div>

            <div class="glass-card border-l-4 border-purple-500">
                <div class="flex items-center gap-3 mb-3 text-purple-400">
                    <i class="fa-solid fa-map-location-dot text-xl"></i>
                    <h3 class="font-bold text-sm">Ø¨Ø­Ø« Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª</h3>
                </div>
                <div class="flex gap-2 relative">
                    <input type="text" id="wilayaInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„ÙˆÙ„Ø§ÙŠØ©..." class="flex-1 bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm outline-none text-white">
                    <button onclick="searchWilaya()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 rounded-lg"><i class="fa-solid fa-search"></i></button>
                </div>
                <div id="wilayaResult" class="mt-2 text-sm text-gray-300 font-bold p-1"></div>
            </div>

            <div class="glass-card border-l-4 border-green-500">
                <div class="flex items-center gap-3 mb-3 text-green-500">
                    <i class="fa-solid fa-money-bill-transfer text-xl"></i>
                    <h3 class="font-bold text-sm">Ø§Ù„Ø³ÙƒÙˆØ§Ø± (Square)</h3>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <div class="bg-slate-900 p-2 rounded text-center border border-slate-700">
                        <div class="text-[10px] text-gray-500">1 EUR (â‚¬)</div>
                        <input type="number" id="rateEur" value="245" class="w-full bg-transparent text-center font-bold text-white outline-none">
                    </div>
                    <div class="bg-slate-900 p-2 rounded text-center border border-slate-700">
                        <div class="text-[10px] text-gray-500">1 USD ($)</div>
                        <input type="number" id="rateUsd" value="225" class="w-full bg-transparent text-center font-bold text-white outline-none">
                    </div>
                </div>
                <input type="number" id="moneyInput" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm text-center outline-none text-white">
                <div id="moneyOutput" class="text-center font-bold text-xl text-green-400 mt-2">0 DA</div>
            </div>
            
             <div class="glass-card border-l-4 border-blue-500">
                <div class="flex items-center gap-3 mb-3 text-blue-400">
                    <i class="fa-solid fa-mosque text-xl"></i>
                    <h3 class="font-bold text-sm">Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© (Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±)</h3>
                </div>
                <div id="prayerOutput" class="space-y-2 text-sm font-mono">Running...</div>
            </div>
        </main>

        <main id="view-settings" class="page">
            <h2 class="text-lg font-bold mb-4 px-1 text-gray-300">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
            
            <div class="glass-card">
                <label class="text-xs text-gray-400 block mb-2 font-bold">Ø§Ù„Ø´Ø®ØµÙŠØ© (Persona)</label>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="changePersona('darja')" class="persona-btn p-3 bg-slate-800 rounded-lg text-xs border border-green-500 text-green-400">ğŸ—£ï¸ Ø§Ù„Ø¯Ø§Ø±Ø¬Ø©</button>
                    <button onclick="changePersona('admin')" class="persona-btn p-3 bg-slate-800 rounded-lg text-xs hover:bg-slate-700 text-gray-300">âš–ï¸ Ø¥Ø¯Ø§Ø±ÙŠ</button>
                    <button onclick="changePersona('tech')" class="persona-btn p-3 bg-slate-800 rounded-lg text-xs hover:bg-slate-700 text-gray-300">ğŸ’» Ù…Ø¨Ø±Ù…Ø¬</button>
                    <button onclick="changePersona('poet')" class="persona-btn p-3 bg-slate-800 rounded-lg text-xs hover:bg-slate-700 text-gray-300">âœ’ï¸ Ø´Ø§Ø¹Ø±</button>
                </div>
            </div>

            <div class="glass-card">
                <label class="text-xs text-gray-400 block mb-2 font-bold">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø±Ùƒ (API)</label>
                <select id="settingsProvider" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm mb-2 text-white outline-none" onchange="saveConfig()">
                    <option value="groq">Groq (Llama 3.3)</option>
                    <option value="openai">OpenAI (GPT-4o)</option>
                </select>
                <input type="password" id="settingsKey" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm font-mono text-white outline-none focus:border-blue-500" onchange="saveConfig()">
                <p class="text-[10px] text-gray-500 mt-2"><i class="fa-solid fa-lock"></i> ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙØªØ§Ø­ ÙÙŠ Ù‡Ø§ØªÙÙƒ ÙÙ‚Ø·.</p>
            </div>

            <button onclick="clearChatHistory()" class="w-full py-3 text-red-400 text-sm glass-card hover:bg-red-900/10 transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-trash"></i> Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            </button>
        </main>

        <nav class="bottom-nav">
            <div class="nav-item active" onclick="navTo('chat', this)">
                <i class="fa-solid fa-comment-dots"></i>
                <span>Ù…Ø­Ø§Ø¯Ø«Ø©</span>
            </div>
            <div class="nav-item" onclick="navTo('tools', this)">
                <i class="fa-solid fa-layer-group"></i>
                <span>Ø£Ø¯ÙˆØ§Øª</span>
            </div>
            <div class="nav-item" onclick="navTo('settings', this)">
                <i class="fa-solid fa-sliders"></i>
                <span>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
            </div>
        </nav>

    </div>

    <script>
        // --- 1. GLOBAL CONSTANTS (Defined FIRST to fix "hoisting" errors) ---
        
        // Models Config (UPDATED MODELS HERE)
        const MODELS = {
            groq: 'llama-3.3-70b-versatile', // Newest model replacing deprecated one
            openai: 'gpt-4o'
        };

        const PERSONAS = {
            darja: { 
                name: "Ø§Ù„Ø¯Ø§Ø±Ø¬Ø©",
                prompt: "You are a friendly, witty Algerian AI assistant. You speak strictly in 'Algerian Darja' (Arabic mixed with French words like 'Sahit', 'Khouya', 'Normal', 'Bein sur'). Your tone is casual and helpful. Keep responses concise." 
            },
            admin: { 
                name: "Ø¥Ø¯Ø§Ø±ÙŠ",
                prompt: "You are an expert in Algerian Administrative Law and Bureaucracy. You help users write formal letters (Demandes, Recours, Lettre de Motivation) strictly adhering to Algerian standards in Arabic or French. You are formal and precise." 
            },
            tech: { 
                name: "Ù…Ø¨Ø±Ù…Ø¬",
                prompt: "You are a Senior Full Stack Developer. You provide clean, working code snippets. You explain complex concepts simply in Arabic or English." 
            },
            poet: { 
                name: "Ø´Ø§Ø¹Ø±",
                prompt: "Ø£Ù†Øª Ø´Ø§Ø¹Ø± Ø´Ø¹Ø¨ÙŠ Ø¬Ø²Ø§Ø¦Ø±ÙŠ (Ù…Ø«Ù„ Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ø§Ù† Ø§Ù„Ù…Ø¬Ø¯ÙˆØ¨). ØªØªØ­Ø¯Ø« Ø¨Ø§Ù„Ø­ÙƒÙ…ØŒ Ø§Ù„Ø£Ù…Ø«Ø§Ù„ Ø§Ù„Ø´Ø¹Ø¨ÙŠØ©ØŒ ÙˆØ§Ù„Ù‚Ø§ÙÙŠØ©. Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø°Ø§Øª Ø·Ø§Ø¨Ø¹ ØªØ±Ø§Ø«ÙŠ ÙˆØ¹Ù…ÙŠÙ‚." 
            }
        };

        const WILAYAS = {
            "1": "Ø£Ø¯Ø±Ø§Ø±", "2": "Ø§Ù„Ø´Ù„Ù", "3": "Ø§Ù„Ø£ØºÙˆØ§Ø·", "4": "Ø£Ù… Ø§Ù„Ø¨ÙˆØ§Ù‚ÙŠ", "5": "Ø¨Ø§ØªÙ†Ø©", "6": "Ø¨Ø¬Ø§ÙŠØ©", "7": "Ø¨Ø³ÙƒØ±Ø©", "8": "Ø¨Ø´Ø§Ø±", "9": "Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©", "10": "Ø§Ù„Ø¨ÙˆÙŠØ±Ø©", "11": "ØªÙ…Ù†Ø±Ø§Ø³Øª", "12": "ØªØ¨Ø³Ø©", "13": "ØªÙ„Ù…Ø³Ø§Ù†", "14": "ØªÙŠØ§Ø±Øª", "15": "ØªÙŠØ²ÙŠ ÙˆØ²Ùˆ", "16": "Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±", "17": "Ø§Ù„Ø¬Ù„ÙØ©", "18": "Ø¬ÙŠØ¬Ù„", "19": "Ø³Ø·ÙŠÙ", "20": "Ø³Ø¹ÙŠØ¯Ø©", "21": "Ø³ÙƒÙŠÙƒØ¯Ø©", "22": "Ø³ÙŠØ¯ÙŠ Ø¨Ù„Ø¹Ø¨Ø§Ø³", "23": "Ø¹Ù†Ø§Ø¨Ø©", "24": "Ù‚Ø§Ù„Ù…Ø©", "25": "Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©", "26": "Ø§Ù„Ù…Ø¯ÙŠØ©", "27": "Ù…Ø³ØªØºØ§Ù†Ù…", "28": "Ø§Ù„Ù…Ø³ÙŠÙ„Ø©", "29": "Ù…Ø¹Ø³ÙƒØ±", "30": "ÙˆØ±Ù‚Ù„Ø©", "31": "ÙˆÙ‡Ø±Ø§Ù†", "32": "Ø§Ù„Ø¨ÙŠØ¶", "33": "Ø¥Ù„ÙŠØ²ÙŠ", "34": "Ø¨Ø±Ø¬ Ø¨ÙˆØ¹Ø±ÙŠØ±ÙŠØ¬", "35": "Ø¨ÙˆÙ…Ø±Ø¯Ø§Ø³", "36": "Ø§Ù„Ø·Ø§Ø±Ù", "37": "ØªÙ†Ø¯ÙˆÙ", "38": "ØªÙŠØ³Ù…Ø³ÙŠÙ„Øª", "39": "Ø§Ù„ÙˆØ§Ø¯ÙŠ", "40": "Ø®Ù†Ø´Ù„Ø©", "41": "Ø³ÙˆÙ‚ Ø£Ù‡Ø±Ø§Ø³", "42": "ØªÙŠØ¨Ø§Ø²Ø©", "43": "Ù…ÙŠÙ„Ø©", "44": "Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰", "45": "Ø§Ù„Ù†Ø¹Ø§Ù…Ø©", "46": "Ø¹ÙŠÙ† ØªÙ…ÙˆØ´Ù†Øª", "47": "ØºØ±Ø¯Ø§ÙŠØ©", "48": "ØºÙ„ÙŠØ²Ø§Ù†", "49": "ØªÙŠÙ…ÙŠÙ…ÙˆÙ†", "50": "Ø¨Ø±Ø¬ Ø¨Ø§Ø¬ÙŠ Ù…Ø®ØªØ§Ø±", "51": "Ø£ÙˆÙ„Ø§Ø¯ Ø¬Ù„Ø§Ù„", "52": "Ø¨Ù†ÙŠ Ø¹Ø¨Ø§Ø³", "53": "Ø¹ÙŠÙ† ØµØ§Ù„Ø­", "54": "Ø¹ÙŠÙ† Ù‚Ø²Ø§Ù…", "55": "ØªÙ‚Ø±Øª", "56": "Ø¬Ø§Ù†Øª", "57": "Ø§Ù„Ù…ØºÙŠØ±", "58": "Ø§Ù„Ù…Ù†ÙŠØ¹Ø©"
        };

        let currentPersona = 'darja';

        // --- 2. INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // PWA Manifest Gen
            const manifestData = {
                "name": "Dza-Genius", "short_name": "Dza-Genius", "start_url": ".", "display": "standalone",
                "background_color": "#0f172a", "theme_color": "#0f172a",
                "icons": [{ "src": "https://cdn-icons-png.flaticon.com/512/4712/4712109.png", "sizes": "192x192", "type": "image/png" }]
            };
            const blob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
            document.getElementById('manifest-placeholder').setAttribute('href', URL.createObjectURL(blob));

            // Load Config
            const key = localStorage.getItem('dza_key');
            if (!key) {
                document.getElementById('welcomeModal').classList.remove('hidden');
            } else {
                document.getElementById('settingsKey').value = key;
                document.getElementById('settingsProvider').value = localStorage.getItem('dza_provider') || 'groq';
                loadHistory();
            }
            
            // Init Features
            loadPrayerTimes();
        });

        // --- 3. UI FUNCTIONS ---
        function finishOnboarding() {
            const key = document.getElementById('welcomeKey').value.trim();
            const provider = document.getElementById('welcomeProvider').value;
            if (key) {
                localStorage.setItem('dza_key', key);
                localStorage.setItem('dza_provider', provider);
                document.getElementById('settingsKey').value = key;
                document.getElementById('settingsProvider').value = provider;
                document.getElementById('welcomeModal').classList.add('hidden');
                appendMsg('system', 'ØªÙ… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø±Ø¨ ØªØ³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø³Ø¤Ø§Ù„.');
            } else {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙØªØ§Ø­ (API Key)');
            }
        }

        function navTo(view, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('view-' + view).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
        }

        function saveConfig() {
            localStorage.setItem('dza_key', document.getElementById('settingsKey').value.trim());
            localStorage.setItem('dza_provider', document.getElementById('settingsProvider').value);
            document.getElementById('statusIndicator').innerHTML = `<span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> ØªÙ… Ø§Ù„Ø­ÙØ¸`;
        }

        function changePersona(key) {
            currentPersona = key;
            // Update UI
            document.querySelectorAll('.persona-btn').forEach(b => {
                b.classList.remove('border', 'border-green-500', 'text-green-400');
                b.classList.add('text-gray-300');
            });
            event.target.classList.add('border', 'border-green-500', 'text-green-400');
            event.target.classList.remove('text-gray-300');
            
            appendMsg('system', `ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„ÙˆØ¶Ø¹ Ø¥Ù„Ù‰: <b>${PERSONAS[key].name}</b>`);
        }

        // --- 4. CHAT ENGINE (FIXED) ---
        const chatBox = document.getElementById('chatContainer');
        const input = document.getElementById('msgInput');

        function appendMsg(role, text) {
            const div = document.createElement('div');
            const isUser = role === 'user';
            
            if (role === 'system') {
                div.className = 'text-center text-[10px] text-gray-500 my-2';
                div.innerHTML = text;
            } else {
                div.className = `msg-bubble ${isUser ? 'msg-user' : 'msg-bot'} shadow-sm`;
                
                // Parse Content
                div.innerHTML = isUser ? text.replace(/\n/g, '<br>') : marked.parse(text);

                // Add TTS button for bot
                if (!isUser) {
                    const btn = document.createElement('button');
                    btn.className = 'absolute -top-3 left-0 bg-slate-700 text-[10px] px-2 py-0.5 rounded-full text-gray-300 hover:text-white opacity-0 group-hover:opacity-100 transition';
                    btn.innerHTML = '<i class="fa-solid fa-volume-high"></i>';
                    btn.onclick = () => speak(text);
                    div.classList.add('group'); // Enable hover
                    div.appendChild(btn);
                }
            }

            chatBox.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
            localStorage.setItem('dza_history_v6', chatBox.innerHTML);
        }

        async function sendMsg() {
            const text = input.value.trim();
            const key = localStorage.getItem('dza_key');
            const provider = localStorage.getItem('dza_provider') || 'groq';

            if (!text) return;
            if (!key) { navTo('settings', document.querySelectorAll('.nav-item')[2]); alert("ÙŠØ¬Ø¨ ÙˆØ¶Ø¹ Ù…ÙØªØ§Ø­ API Ø£ÙˆÙ„Ø§Ù‹"); return; }

            input.value = '';
            input.style.height = 'auto';
            appendMsg('user', text);

            // Loader
            const loaderId = 'load-' + Date.now();
            const loader = document.createElement('div');
            loader.id = loaderId;
            loader.className = 'msg-bubble msg-bot typing-indicator';
            loader.innerHTML = '<span></span><span></span><span></span>';
            chatBox.appendChild(loader);
            loader.scrollIntoView();

            try {
                // API ENDPOINTS
                const url = provider === 'groq' ? 'https://api.groq.com/openai/v1/chat/completions' : 'https://api.openai.com/v1/chat/completions';
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${key}`
                    },
                    body: JSON.stringify({
                        model: MODELS[provider], // Uses the FIXED model names
                        messages: [
                            { role: "system", content: PERSONAS[currentPersona].prompt },
                            { role: "user", content: text }
                        ],
                        temperature: 0.7
                    })
                });

                const data = await response.json();
                document.getElementById(loaderId).remove();

                if (data.error) {
                    // Smart Error Handling
                    let errMsg = data.error.message;
                    if (errMsg.includes('invalid_api_key')) errMsg = "Ù…ÙØªØ§Ø­ API Ø®Ø§Ø·Ø¦. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.";
                    if (errMsg.includes('model')) errMsg = "Ø­Ø¯Ø« ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ØŒ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.";
                    throw new Error(errMsg);
                }

                appendMsg('ai', data.choices[0].message.content);

            } catch (error) {
                document.getElementById(loaderId)?.remove();
                appendMsg('system', `<span class="text-red-400"><i class="fa-solid fa-triangle-exclamation"></i> Ø®Ø·Ø£: ${error.message}</span>`);
            }
        }

        function loadHistory() {
            const h = localStorage.getItem('dza_history_v6');
            if (h) chatBox.innerHTML = h;
        }
        function clearChatHistory() {
            if(confirm("Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ØŸ")) {
                chatBox.innerHTML = '';
                localStorage.removeItem('dza_history_v6');
            }
        }

        // --- 5. TOOLS FUNCTIONS ---

        // CCP Calculator (Fixed BigInt Logic)
        function calculateCCP() {
            const val = document.getElementById('ccpInput').value;
            const out = document.getElementById('ccpOutput');
            
            if (val && val.length > 2) {
                try {
                    // Key = 97 - ((CCP * 100) % 97)
                    const acc = BigInt(val); // Use BigInt for large numbers
                    const x = acc * 100n;
                    const remainder = x % 97n;
                    const key = 97n - remainder;
                    
                    out.classList.remove('hidden');
                    out.innerHTML = `
                        <div class="text-gray-400 text-xs">RIP</div>
                        <div class="text-white font-mono text-sm tracking-widest">${val} / <span class="text-yellow-400 font-bold">${key < 10 ? '0'+key : key}</span></div>
                        <div class="mt-2 text-xs text-green-400">Ø§Ù„Ù…ÙØªØ§Ø­ (ClÃ©) Ù‡Ùˆ: <b>${key < 10 ? '0'+key : key}</b></div>
                    `;
                } catch (e) {
                    out.classList.remove('hidden');
                    out.innerHTML = '<span class="text-red-400">Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± ØµØ§Ù„Ø­</span>';
                }
            }
        }

        // Wilaya Search
        function searchWilaya() {
            const q = document.getElementById('wilayaInput').value.trim();
            const res = document.getElementById('wilayaResult');
            
            if (!q) return;

            let found = "";
            // Check if number
            if (WILAYAS[q]) {
                found = `<span class="text-purple-400">${q}</span> - ${WILAYAS[q]}`;
            } else {
                // Search by name
                for (let [num, name] of Object.entries(WILAYAS)) {
                    if (name.includes(q)) {
                        found = `<span class="text-purple-400">${num}</span> - ${name}`;
                        break;
                    }
                }
            }

            res.innerHTML = found ? `<i class="fa-solid fa-check-circle text-green-500"></i> ${found}` : `<span class="text-red-400">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</span>`;
        }

        // Currency
        document.getElementById('moneyInput').addEventListener('input', (e) => {
            const amount = parseFloat(e.target.value);
            const rate = parseFloat(document.getElementById('rateEur').value);
            if (amount) {
                document.getElementById('moneyOutput').innerText = (amount * rate).toLocaleString() + " DA";
            } else {
                document.getElementById('moneyOutput').innerText = "0 DA";
            }
        });

        // Prayer Times
        function loadPrayerTimes() {
            try {
                const coords = new adhan.Coordinates(36.75, 3.05); // Algiers
                const params = adhan.CalculationMethod.MuslimWorldLeague();
                const date = new Date();
                const pt = new adhan.PrayerTimes(coords, date, params);
                const f = (t) => t.toLocaleTimeString('fr-DZ', {hour:'2-digit', minute:'2-digit'});
                
                document.getElementById('prayerOutput').innerHTML = `
                    <div class="flex justify-between border-b border-gray-700/50 py-1"><span>Ø§Ù„ÙØ¬Ø±</span><span class="text-blue-300 font-mono">${f(pt.fajr)}</span></div>
                    <div class="flex justify-between border-b border-gray-700/50 py-1"><span>Ø§Ù„Ø¸Ù‡Ø±</span><span class="text-blue-300 font-mono">${f(pt.dhuhr)}</span></div>
                    <div class="flex justify-between border-b border-gray-700/50 py-1"><span>Ø§Ù„Ø¹ØµØ±</span><span class="text-blue-300 font-mono">${f(pt.asr)}</span></div>
                    <div class="flex justify-between border-b border-gray-700/50 py-1"><span>Ø§Ù„Ù…ØºØ±Ø¨</span><span class="text-blue-300 font-mono">${f(pt.maghrib)}</span></div>
                    <div class="flex justify-between py-1"><span>Ø§Ù„Ø¹Ø´Ø§Ø¡</span><span class="text-blue-300 font-mono">${f(pt.isha)}</span></div>
                `;
            } catch (e) { console.log("Prayer error"); }
        }

        // --- 6. UTILITIES ---
        function toggleMic() {
            if (!('webkitSpeechRecognition' in window)) {
                alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ. Ø¬Ø±Ø¨ Chrome.");
                return;
            }
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'ar-DZ';
            recognition.start();
            
            const btn = document.getElementById('micBtn');
            btn.classList.add('text-red-500', 'animate-pulse');
            
            recognition.onresult = (e) => {
                input.value += " " + e.results[0][0].transcript;
                btn.classList.remove('text-red-500', 'animate-pulse');
            };
            recognition.onend = () => btn.classList.remove('text-red-500', 'animate-pulse');
        }

        function speak(txt) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(txt.replace(/[*#`]/g, ''));
            u.lang = 'ar-SA';
            window.speechSynthesis.speak(u);
        }

        // PWA Install
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBtn').classList.remove('hidden');
        });
        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') document.getElementById('installBtn').classList.add('hidden');
                deferredPrompt = null;
            }
        }
    </script>
</body>
</html>
