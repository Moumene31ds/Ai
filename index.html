<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="application-name" content="Dza-Genius">
    <meta name="apple-mobile-web-app-title" content="Dza-Genius">
    <meta name="theme-color" content="#0f172a">

    <title>Dza-Genius Ultimate</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/adhan@4.4.4/dist/adhan.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">

    <link rel="manifest" id="manifest-placeholder">

    <style>
        :root {
            --primary: #10b981;
            --bg-dark: #0f172a;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-dark);
            color: #f8fafc;
            height: 100dvh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            background-image: radial-gradient(#1e293b 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* --- Layout & Navigation --- */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding-top: var(--safe-top);
            padding-bottom: calc(70px + var(--safe-bottom));
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            height: calc(65px + var(--safe-bottom));
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-around;
            padding-top: 10px;
            z-index: 50;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            color: #64748b;
            transition: all 0.3s ease;
            width: 25%;
        }

        .nav-item i { font-size: 20px; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }

        /* --- Pages --- */
        .page { display: none; height: 100%; overflow-y: auto; padding: 16px; scroll-behavior: smooth; }
        .page.active { display: block; animation: fadeIn 0.3s ease-out; }

        /* --- Chat Components --- */
        .msg-bubble { max-width: 85%; padding: 12px 16px; margin-bottom: 12px; font-size: 14px; line-height: 1.6; position: relative; }
        .msg-bot { background: #1e293b; border-radius: 18px 18px 18px 4px; color: #e2e8f0; border: 1px solid #334155; }
        .msg-user { background: #2563eb; border-radius: 18px 18px 4px 18px; color: white; margin-right: auto; }
        
        .code-block { background: #0f172a; padding: 10px; border-radius: 8px; font-family: monospace; overflow-x: auto; margin: 5px 0; direction: ltr; }

        /* --- Cards & Tools --- */
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
        
        .typing-indicator span { display: inline-block; width: 6px; height: 6px; background: #94a3b8; border-radius: 50%; margin: 0 2px; animation: typing 1.4s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* --- Welcome Modal --- */
        #welcomeModal { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); }
    </style>
</head>
<body>

    <div id="welcomeModal" class="fixed inset-0 z-[100] flex items-center justify-center p-6 hidden">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl p-6 w-full max-w-sm text-center shadow-2xl">
            <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl animate-bounce">ğŸ‡©ğŸ‡¿</div>
            <h2 class="text-xl font-bold mb-2">Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙÙŠ Dza-Genius</h2>
            <p class="text-sm text-gray-400 mb-6">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„. Ù„Ù„Ø¨Ø¯Ø¡ØŒ Ù†Ø­ØªØ§Ø¬ Ø¥Ù„Ù‰ "Ø§Ù„Ù…Ø­Ø±Ùƒ" (API Key).</p>
            
            <div class="text-left mb-4">
                <label class="text-xs text-gray-500 block mb-1">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø±Ùƒ:</label>
                <select id="welcomeProvider" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2 text-sm mb-3">
                    <option value="groq">Groq (Ù…Ø¬Ø§Ù†ÙŠ ÙˆØ³Ø±ÙŠØ¹ âš¡)</option>
                    <option value="openai">OpenAI (GPT-4)</option>
                </select>
                
                <label class="text-xs text-gray-500 block mb-1">Ù…ÙØªØ§Ø­ API:</label>
                <input type="password" id="welcomeKey" placeholder="gsk_... Ø£Ùˆ sk-..." class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2 text-sm font-mono">
                <a href="https://console.groq.com/keys" target="_blank" class="text-[10px] text-blue-400 mt-1 block hover:underline">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ Groq Ù…Ø¬Ø§Ù†ÙŠ</a>
            </div>

            <button onclick="finishOnboarding()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl transition">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù† ğŸš€</button>
        </div>
    </div>

    <div class="app-container">
        
        <header class="flex justify-between items-center px-4 py-3 bg-slate-900/50 backdrop-blur sticky top-0 z-40 border-b border-slate-800">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-green-500 to-blue-600 flex items-center justify-center text-white font-bold text-xs shadow-lg">DZ</div>
                <div>
                    <h1 class="font-bold text-sm text-white">Dza-Genius</h1>
                    <div id="headerStatus" class="text-[10px] text-green-400 flex items-center gap-1">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Ù…ØªØµÙ„
                    </div>
                </div>
            </div>
            <button onclick="installPWA()" id="installBtn" class="hidden bg-slate-800 text-blue-400 text-xs px-3 py-1.5 rounded-full border border-slate-700">
                <i class="fa-solid fa-download mr-1"></i> ØªØ«Ø¨ÙŠØª
            </button>
        </header>

        <main id="view-chat" class="page active">
            <div id="chatContainer" class="pb-4 min-h-[50vh]">
                <div class="msg-bubble msg-bot shadow-lg">
                    <div class="text-xs font-bold text-green-400 mb-1">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</div>
                    <div>ÙˆØ§Ø´ Ø®ÙˆÙŠØ§/Ø£Ø®ØªÙŠ! ğŸ‘‹<br>Ø£Ù†Ø§ Ù‡Ù†Ø§ Ø¨Ø§Ø´ Ù†Ø¹Ø§ÙˆÙ†Ùƒ ÙÙŠ ÙƒÙ„Ø´: Ù‡Ø¯Ø±Ø©ØŒ ÙƒÙˆØ¯ØŒ Ø·Ù„Ø¨Ø§Øª Ø®Ø·ÙŠØ©ØŒ ÙˆÙ„Ø§ Ø£Ø¯ÙˆØ§Øª (CCPØŒ ØµÙ„Ø§Ø©).<br><b>Ø¬Ø±Ø¨Ù†ÙŠ!</b></div>
                </div>
            </div>
            
            <div class="fixed bottom-[calc(70px+var(--safe-bottom))] left-0 right-0 p-3 bg-gradient-to-t from-slate-900 to-transparent z-40">
                <div class="max-w-3xl mx-auto flex items-end gap-2 bg-slate-800 p-2 rounded-2xl border border-slate-700 shadow-xl">
                    <button id="micBtn" onclick="toggleMic()" class="w-10 h-10 rounded-full bg-slate-700 text-gray-400 flex items-center justify-center flex-shrink-0 transition active:scale-95">
                        <i class="fa-solid fa-microphone"></i>
                    </button>
                    <textarea id="msgInput" rows="1" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§..." class="flex-1 bg-transparent text-white text-sm p-2.5 focus:outline-none resize-none max-h-32" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
                    <button onclick="sendMsg()" class="w-10 h-10 rounded-full bg-green-600 text-white flex items-center justify-center flex-shrink-0 shadow-lg active:scale-95 transition">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </main>

        <main id="view-tools" class="page">
            <h2 class="text-lg font-bold mb-4 px-1 text-gray-300">Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h2>
            
            <div class="glass-card group hover:border-yellow-500/50 transition">
                <div class="flex items-center gap-3 mb-3 text-yellow-500">
                    <div class="w-8 h-8 rounded-full bg-yellow-500/10 flex items-center justify-center"><i class="fa-solid fa-building-columns"></i></div>
                    <h3 class="font-bold text-sm">Ø­Ø§Ø³Ø¨Ø© CCP</h3>
                </div>
                <div class="flex gap-2">
                    <input type="number" id="ccpInput" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ù…ÙØªØ§Ø­)" class="flex-1 bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm text-center outline-none focus:border-yellow-500">
                    <button onclick="calculateCCP()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 rounded-lg text-sm transition">Ø§Ø­Ø³Ø¨</button>
                </div>
                <div id="ccpOutput" class="mt-2 text-center text-sm font-mono text-white hidden p-2 bg-slate-900 rounded border border-dashed border-gray-700"></div>
            </div>

            <div class="glass-card group hover:border-green-500/50 transition">
                <div class="flex items-center gap-3 mb-3 text-green-500">
                    <div class="w-8 h-8 rounded-full bg-green-500/10 flex items-center justify-center"><i class="fa-solid fa-money-bill-transfer"></i></div>
                    <h3 class="font-bold text-sm">Ø§Ù„Ø³ÙƒÙˆØ§Ø± (Devise)</h3>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-3 text-xs">
                    <div class="bg-slate-900 p-2 rounded text-center">
                        <div class="text-gray-500">1 EUR</div>
                        <input type="number" id="rateEur" value="240" class="w-full bg-transparent text-center font-bold text-white outline-none">
                    </div>
                    <div class="bg-slate-900 p-2 rounded text-center">
                        <div class="text-gray-500">1 USD</div>
                        <input type="number" id="rateUsd" value="220" class="w-full bg-transparent text-center font-bold text-white outline-none">
                    </div>
                </div>
                <input type="number" id="moneyInput" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm text-center mb-2 outline-none">
                <div id="moneyOutput" class="text-center font-bold text-lg text-green-400">0 DA</div>
            </div>

            <div class="glass-card">
                <div class="flex items-center gap-3 mb-3 text-blue-400">
                    <div class="w-8 h-8 rounded-full bg-blue-500/10 flex items-center justify-center"><i class="fa-solid fa-mosque"></i></div>
                    <h3 class="font-bold text-sm">Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©</h3>
                </div>
                <div id="prayerOutput" class="space-y-2 text-sm">Loading...</div>
            </div>

             <div class="glass-card">
                <div class="flex items-center gap-3 mb-3 text-purple-400">
                    <div class="w-8 h-8 rounded-full bg-purple-500/10 flex items-center justify-center"><i class="fa-solid fa-map-location-dot"></i></div>
                    <h3 class="font-bold text-sm">Ø¯Ù„ÙŠÙ„ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª</h3>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="wilayaInput" placeholder="Ø±Ù‚Ù… Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„ÙˆÙ„Ø§ÙŠØ©..." class="flex-1 bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm outline-none">
                    <button onclick="searchWilaya()" class="bg-purple-600 hover:bg-purple-700 text-white px-3 rounded-lg"><i class="fa-solid fa-search"></i></button>
                </div>
                <div id="wilayaResult" class="mt-2 text-sm text-gray-300 hidden"></div>
            </div>
        </main>

        <main id="view-settings" class="page">
            <h2 class="text-lg font-bold mb-4 px-1 text-gray-300">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
            
            <div class="glass-card">
                <label class="text-xs text-gray-500 block mb-2">Ø§Ù„Ø´Ø®ØµÙŠØ© (Persona)</label>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="changePersona('darja')" class="p-3 bg-slate-800 rounded-lg text-xs border border-green-500/30 hover:bg-slate-700 transition">ğŸ—£ï¸ Ø§Ù„Ø¯Ø§Ø±Ø¬Ø©</button>
                    <button onclick="changePersona('admin')" class="p-3 bg-slate-800 rounded-lg text-xs hover:bg-slate-700 transition">âš–ï¸ Ø¥Ø¯Ø§Ø±ÙŠ</button>
                    <button onclick="changePersona('tech')" class="p-3 bg-slate-800 rounded-lg text-xs hover:bg-slate-700 transition">ğŸ’» Ù…Ø¨Ø±Ù…Ø¬</button>
                    <button onclick="changePersona('poet')" class="p-3 bg-slate-800 rounded-lg text-xs hover:bg-slate-700 transition">âœ’ï¸ Ø´Ø§Ø¹Ø±</button>
                </div>
            </div>

            <div class="glass-card">
                <label class="text-xs text-gray-500 block mb-2">ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙØªØ§Ø­ (API Key)</label>
                <select id="settingsProvider" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm mb-2 text-gray-300" onchange="saveConfig()">
                    <option value="groq">Groq</option>
                    <option value="openai">OpenAI</option>
                </select>
                <input type="password" id="settingsKey" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm font-mono text-gray-300" onchange="saveConfig()">
            </div>

            <button onclick="clearChatHistory()" class="w-full py-3 text-red-400 text-sm glass-card hover:bg-red-900/10 transition">
                <i class="fa-solid fa-trash mr-2"></i> Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            </button>
        </main>

        <nav class="bottom-nav">
            <div class="nav-item active" onclick="navTo('chat', this)">
                <i class="fa-solid fa-comment-dots"></i>
                <span>Ù…Ø­Ø§Ø¯Ø«Ø©</span>
            </div>
            <div class="nav-item" onclick="navTo('tools', this)">
                <i class="fa-solid fa-layer-group"></i>
                <span>Ø£Ø¯ÙˆØ§Øª</span>
            </div>
            <div class="nav-item" onclick="navTo('settings', this)">
                <i class="fa-solid fa-sliders"></i>
                <span>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
            </div>
        </nav>

    </div>

    <script>
        // --- 1. DEFINITIONS (GLOBAL CONSTANTS - MUST BE TOP) ---
        // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø«ÙˆØ§Ø¨Øª Ù‡Ù†Ø§ Ù„ØªØ¬Ù†Ø¨ Ø®Ø·Ø£ "ReferenceError"
        
        const PERSONAS = {
            darja: { 
                name: "Ø§Ù„Ø¯Ø§Ø±Ø¬Ø©",
                prompt: "You are a friendly Algerian Assistant. Speak strictly in Algerian Darja (Arabic mixed with French). Use terms like 'Khouya', 'Sahit', 'Bein sur'. Keep answers concise." 
            },
            admin: { 
                name: "Ø¥Ø¯Ø§Ø±ÙŠ",
                prompt: "You are an expert in Algerian Bureaucracy. Write formal letters (Demandes, Recours) strictly adhering to Algerian standards (French/Arabic)." 
            },
            tech: { 
                name: "Ù…Ø¨Ø±Ù…Ø¬",
                prompt: "You are a senior Full Stack Developer. Explain code simply in Arabic/English." 
            },
            poet: { 
                name: "Ø´Ø§Ø¹Ø± Ø´Ø¹Ø¨ÙŠ",
                prompt: "Ø£Ù†Øª Ø´Ø§Ø¹Ø± Ø´Ø¹Ø¨ÙŠ Ø¬Ø²Ø§Ø¦Ø±ÙŠ ØªØªØ­Ø¯Ø« Ø¨Ø§Ù„Ø­ÙƒÙ… ÙˆØ§Ù„Ø£Ù…Ø«Ø§Ù„ Ø§Ù„Ø´Ø¹Ø¨ÙŠØ©." 
            }
        };

        const WILAYAS = {
            "1": "Adrar", "2": "Chlef", "3": "Laghouat", "4": "Oum El Bouaghi", "5": "Batna", "6": "BÃ©jaÃ¯a", "7": "Biskra", "8": "BÃ©char", "9": "Blida", "10": "Bouira", "11": "Tamanrasset", "12": "TÃ©bessa", "13": "Tlemcen", "14": "Tiaret", "15": "Tizi Ouzou", "16": "Alger", "17": "Djelfa", "18": "Jijel", "19": "SÃ©tif", "20": "SaÃ¯da", "21": "Skikda", "22": "Sidi Bel AbbÃ¨s", "23": "Annaba", "24": "Guelma", "25": "Constantine", "26": "MÃ©dÃ©a", "27": "Mostaganem", "28": "M'Sila", "29": "Mascara", "30": "Ouargla", "31": "Oran", "32": "El Bayadh", "33": "Illizi", "34": "Bordj Bou ArrÃ©ridj", "35": "BoumerdÃ¨s", "36": "El Tarf", "37": "Tindouf", "38": "Tissemsilt", "39": "El Oued", "40": "Khenchela", "41": "Souk Ahras", "42": "Tipaza", "43": "Mila", "44": "AÃ¯n Defla", "45": "NaÃ¢ma", "46": "AÃ¯n TÃ©mouchent", "47": "GhardaÃ¯a", "48": "Relizane", "49": "Timimoun", "50": "Bordj Badji Mokhtar", "51": "Ouled Djellal", "52": "BÃ©ni AbbÃ¨s", "53": "In Salah", "54": "In Guezzam", "55": "Touggourt", "56": "Djanet", "57": "El M'Ghair", "58": "El Meniaa"
        };

        let currentPersona = 'darja';
        
        // --- 2. PWA MANIFEST GENERATION ---
        const manifestContent = {
            "name": "Dza-Genius", "short_name": "Dza-Genius", "start_url": ".", "display": "standalone",
            "background_color": "#0f172a", "theme_color": "#0f172a",
            "icons": [{ "src": "https://cdn-icons-png.flaticon.com/512/4712/4712109.png", "sizes": "192x192", "type": "image/png" }]
        };
        const blob = new Blob([JSON.stringify(manifestContent)], {type: 'application/json'});
        document.getElementById('manifest-placeholder').setAttribute('href', URL.createObjectURL(blob));

        // --- 3. INIT & NAVIGATION ---
        window.onload = function() {
            // Check if user has key
            const key = localStorage.getItem('dza_key');
            if (!key) {
                document.getElementById('welcomeModal').classList.remove('hidden');
            } else {
                // Load Settings
                document.getElementById('settingsKey').value = key;
                document.getElementById('settingsProvider').value = localStorage.getItem('dza_provider') || 'groq';
                loadChatHistory();
            }

            // Init Tools
            loadPrayerTimes();
        };

        function finishOnboarding() {
            const key = document.getElementById('welcomeKey').value;
            const provider = document.getElementById('welcomeProvider').value;
            if(key) {
                localStorage.setItem('dza_key', key);
                localStorage.setItem('dza_provider', provider);
                document.getElementById('settingsKey').value = key;
                document.getElementById('settingsProvider').value = provider;
                document.getElementById('welcomeModal').classList.add('hidden');
            } else {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙØªØ§Ø­");
            }
        }

        function navTo(viewId, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
        }

        function saveConfig() {
            localStorage.setItem('dza_key', document.getElementById('settingsKey').value);
            localStorage.setItem('dza_provider', document.getElementById('settingsProvider').value);
        }

        // --- 4. CHAT LOGIC ---
        const chatContainer = document.getElementById('chatContainer');
        const msgInput = document.getElementById('msgInput');

        function appendMsg(sender, text) {
            const div = document.createElement('div');
            const isUser = sender === 'user';
            
            div.className = `msg-bubble ${isUser ? 'msg-user' : 'msg-bot'}`;
            
            // Markdown parsing
            div.innerHTML = isUser ? text.replace(/\n/g, '<br>') : marked.parse(text);
            
            // TTS Button for bot
            if(!isUser) {
                const ttsBtn = document.createElement('button');
                ttsBtn.innerHTML = '<i class="fa-solid fa-volume-high"></i>';
                ttsBtn.className = "absolute top-2 left-2 text-gray-500 hover:text-white text-xs";
                ttsBtn.onclick = () => speak(text);
                div.appendChild(ttsBtn);
            }

            chatContainer.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
            
            // Save history
            localStorage.setItem('dza_history', chatContainer.innerHTML);
        }

        function loadChatHistory() {
            const history = localStorage.getItem('dza_history');
            if(history) chatContainer.innerHTML = history;
        }

        function clearChatHistory() {
            if(confirm("Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ØŸ")) {
                chatContainer.innerHTML = '';
                localStorage.removeItem('dza_history');
            }
        }

        function changePersona(p) {
            currentPersona = p;
            alert(`ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ø®ØµÙŠØ© Ø¥Ù„Ù‰: ${PERSONAS[p].name}`);
        }

        async function sendMsg() {
            const text = msgInput.value.trim();
            const key = localStorage.getItem('dza_key');
            const provider = localStorage.getItem('dza_provider');

            if(!text) return;
            if(!key) { alert("Ø§Ù„Ù…ÙØªØ§Ø­ Ù…ÙÙ‚ÙˆØ¯! Ø§Ø°Ù‡Ø¨ Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"); return; }

            msgInput.value = '';
            msgInput.style.height = 'auto';
            appendMsg('user', text);

            // Typing Indicator
            const loader = document.createElement('div');
            loader.className = 'msg-bubble msg-bot typing-indicator';
            loader.innerHTML = '<span></span><span></span><span></span>';
            chatContainer.appendChild(loader);
            loader.scrollIntoView();

            try {
                const url = provider === 'groq' ? 'https://api.groq.com/openai/v1/chat/completions' : 'https://api.openai.com/v1/chat/completions';
                const model = provider === 'groq' ? 'llama3-70b-8192' : 'gpt-4-turbo-preview';

                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            { role: "system", content: PERSONAS[currentPersona].prompt },
                            { role: "user", content: text }
                        ]
                    })
                });

                const data = await res.json();
                loader.remove();

                if(data.error) throw new Error(data.error.message);
                const reply = data.choices[0].message.content;
                appendMsg('ai', reply);

            } catch (e) {
                loader.remove();
                appendMsg('ai', `âš ï¸ Ø®Ø·Ø£: ${e.message}`);
            }
        }

        // --- 5. TOOLS LOGIC ---
        
        // CCP
        function calculateCCP() {
            const acc = document.getElementById('ccpInput').value;
            if(acc && acc.length > 2) {
                try {
                    const x = BigInt(acc) * 100n;
                    const key = 97n - (x % 97n);
                    const output = document.getElementById('ccpOutput');
                    output.classList.remove('hidden');
                    output.innerHTML = `Ø§Ù„Ù…ÙØªØ§Ø­ (ClÃ©): <b class="text-yellow-400 text-lg">${key}</b><br>RIP: ${acc} / ${key}`;
                } catch(e) { alert("Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­"); }
            }
        }

        // Prayer Times
        function loadPrayerTimes() {
            const coords = new adhan.Coordinates(36.75, 3.05);
            const params = adhan.CalculationMethod.MuslimWorldLeague();
            const date = new Date();
            const pt = new adhan.PrayerTimes(coords, date, params);
            const fmt = (t) => t.toLocaleTimeString('fr-DZ', {hour:'2-digit', minute:'2-digit'});
            
            document.getElementById('prayerOutput').innerHTML = `
                <div class="flex justify-between border-b border-gray-700 pb-1"><span>Ø§Ù„ÙØ¬Ø±</span><span class="text-blue-400 font-mono">${fmt(pt.fajr)}</span></div>
                <div class="flex justify-between border-b border-gray-700 pb-1 pt-1"><span>Ø§Ù„Ø¸Ù‡Ø±</span><span class="text-blue-400 font-mono">${fmt(pt.dhuhr)}</span></div>
                <div class="flex justify-between border-b border-gray-700 pb-1 pt-1"><span>Ø§Ù„Ø¹ØµØ±</span><span class="text-blue-400 font-mono">${fmt(pt.asr)}</span></div>
                <div class="flex justify-between border-b border-gray-700 pb-1 pt-1"><span>Ø§Ù„Ù…ØºØ±Ø¨</span><span class="text-blue-400 font-mono">${fmt(pt.maghrib)}</span></div>
                <div class="flex justify-between pt-1"><span>Ø§Ù„Ø¹Ø´Ø§Ø¡</span><span class="text-blue-400 font-mono">${fmt(pt.isha)}</span></div>
            `;
        }

        // Currency
        document.getElementById('moneyInput').addEventListener('input', (e) => {
            const val = e.target.value;
            const rate = document.getElementById('rateEur').value;
            if(val) document.getElementById('moneyOutput').innerText = (val * rate).toLocaleString() + " DA";
        });

        // Wilaya Search
        function searchWilaya() {
            const input = document.getElementById('wilayaInput').value.toLowerCase();
            const resDiv = document.getElementById('wilayaResult');
            let found = null;
            
            // Search by Key (Number) or Value (Name)
            if(WILAYAS[input]) found = `${input} - ${WILAYAS[input]}`;
            else {
                for (const [k, v] of Object.entries(WILAYAS)) {
                    if(v.toLowerCase().includes(input)) found = `${k} - ${v}`;
                }
            }

            resDiv.classList.remove('hidden');
            if(found) resDiv.innerHTML = `<span class="text-purple-400 font-bold"><i class="fa-solid fa-check"></i> ${found}</span>`;
            else resDiv.innerHTML = `<span class="text-red-400">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</span>`;
        }

        // --- 6. UTILS (Voice, Install) ---
        function toggleMic() {
            if (!('webkitSpeechRecognition' in window)) return alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØµÙˆØª");
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'ar-DZ';
            recognition.start();
            document.getElementById('micBtn').classList.add('text-red-500');
            recognition.onresult = (e) => { 
                msgInput.value += " " + e.results[0][0].transcript; 
                document.getElementById('micBtn').classList.remove('text-red-500');
            };
            recognition.onend = () => document.getElementById('micBtn').classList.remove('text-red-500');
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text.replace(/[*#]/g, ''));
            u.lang = 'ar-SA';
            window.speechSynthesis.speak(u);
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBtn').classList.remove('hidden');
        });
        async function installPWA() {
            if(deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if(outcome === 'accepted') document.getElementById('installBtn').classList.add('hidden');
                deferredPrompt = null;
            }
        }

    </script>
</body>
</html>
